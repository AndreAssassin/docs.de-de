---
title: WIF-Sitzungsverwaltung
ms.date: 03/30/2017
ms.assetid: 98bce126-18a9-401b-b20d-67ee462a5f8a
author: BrucePerlerMS
ms.openlocfilehash: 980d0c6dca9b0b5fadf2d4a841e4c95a9acaff52
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 04/23/2019
ms.locfileid: "61780080"
---
# <a name="wif-session-management"></a><span data-ttu-id="e9f35-102">WIF-Sitzungsverwaltung</span><span class="sxs-lookup"><span data-stu-id="e9f35-102">WIF Session Management</span></span>
<span data-ttu-id="e9f35-103">Wenn ein Client erstmals versucht auf eine geschützte Ressource zuzugreifen, die von einer vertrauenden Seite gehostet wird, muss sich der Client zunächst gegenüber einem Sicherheitstokendienst (STS) authentifizieren, der von der vertrauenden Seite als vertrauenswürdig eingestuft wird.</span><span class="sxs-lookup"><span data-stu-id="e9f35-103">When a client first tries to access a protected resource that is hosted by a relying party, the client must first authenticate itself to a security token service (STS) that is trusted by the relying party.</span></span> <span data-ttu-id="e9f35-104">Der STS stellt dem Client dann ein Sicherheitstoken aus.</span><span class="sxs-lookup"><span data-stu-id="e9f35-104">The STS then issues a security token to the client.</span></span> <span data-ttu-id="e9f35-105">Der Client präsentiert dieses Token der vertrauenden Seite, die dem Client dann Zugriff auf die geschützte Ressource gewährt.</span><span class="sxs-lookup"><span data-stu-id="e9f35-105">The client presents this token to the relying party, which then grants the client access to the protected resource.</span></span> <span data-ttu-id="e9f35-106">Sie möchten jedoch nicht, dass der Client sich für jede Anfrage erneut gegenüber dem STS authentifizieren muss, vor allem, da er sich möglicherweise nicht auf demselben Computer oder in derselben Domäne wie die vertrauende Seite befindet.</span><span class="sxs-lookup"><span data-stu-id="e9f35-106">However, you don’t want the client to have to re-authenticate to the STS for each request, especially because it might not even be on the same computer or in the same domain as the relying party.</span></span> <span data-ttu-id="e9f35-107">Stattdessen fordert die Windows Identity Foundation (WIF) den Client und die vertrauende Seite zur Erstellung einer Sitzung auf, in der der Client ein Sitzungssicherheitstoken verwendet, um sich gegenüber der vertrauenden Seite für alle Anforderungen nach der ersten Anforderung zu authentifizieren.</span><span class="sxs-lookup"><span data-stu-id="e9f35-107">Instead, Windows Identity Foundation (WIF) has the client and relying party establish a session in which the client uses a session security token to authenticate itself to the relying party for all requests after the first request.</span></span> <span data-ttu-id="e9f35-108">Die vertrauende Seite kann dieses Sitzungssicherheitstoken, das in einem Cookie gespeichert wird, zur Rekonstruktion des <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType> des Clients verwenden.</span><span class="sxs-lookup"><span data-stu-id="e9f35-108">The relying party can use this session security token, which is stored inside a cookie, to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span></span>  
  
 <span data-ttu-id="e9f35-109">Der STS definiert, welche Authentifizierung der Client bereitstellen muss.</span><span class="sxs-lookup"><span data-stu-id="e9f35-109">The STS defines what authentication the client must provide.</span></span> <span data-ttu-id="e9f35-110">Der Client kann jedoch möglicherweise über mehrere Anmeldeinformationen verfügen, mit denen er sich gegenüber des STS authentifizieren kann.</span><span class="sxs-lookup"><span data-stu-id="e9f35-110">However, the client might have multiple credentials with which it can authenticate itself to the STS.</span></span> <span data-ttu-id="e9f35-111">Beispielsweise können ein Token von Windows Live, ein Benutzername und Kennwort, ein Zertifikat und ein Smartkey auftreten.</span><span class="sxs-lookup"><span data-stu-id="e9f35-111">For example, it might have a token from Windows Live, a user name and password, a certificate, and a smartkey.</span></span> <span data-ttu-id="e9f35-112">In diesem Fall gewährt der STS dem Client mehrere Identitäten. Jede Identität entspricht einer der Anmeldeinformationen, die vom Client präsentiert wurden.</span><span class="sxs-lookup"><span data-stu-id="e9f35-112">In that case, the STS grants the client several identities, with each identity corresponding to one of the credentials that the client presents.</span></span> <span data-ttu-id="e9f35-113">Die vertrauende Seite kann eine oder mehrere dieser Identitäten verwenden, wenn sie entscheidet, welche Zugriffsebene sie dem Client gewährt.</span><span class="sxs-lookup"><span data-stu-id="e9f35-113">The relying party can use one or more of these identities when it decides what level of access to grant the client.</span></span>  
  
 <span data-ttu-id="e9f35-114">Die <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> wird verwendet, um <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType> des Clients zu rekonstruieren, worin alle Clientidentitäten in <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A> enthalten sind.</span><span class="sxs-lookup"><span data-stu-id="e9f35-114">The <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> is used to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>, which contains all of the client’s identities in <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span></span> <span data-ttu-id="e9f35-115">Alle <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> der Auflistung enthalten die Bootstrap-Token, die dieser Identität zugeordnet sind.</span><span class="sxs-lookup"><span data-stu-id="e9f35-115">Each <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> in the collection contains the bootstrap tokens that are associated with that identity.</span></span>  
  
 <span data-ttu-id="e9f35-116">Wenn ein neues Sitzungstoken mit der Sitzungs-ID des ursprünglichen Sitzungstokens ausgestellt wird, aktualisiert <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> das Sitzungstoken im Tokencache nicht.</span><span class="sxs-lookup"><span data-stu-id="e9f35-116">If a new session token is issued with the session ID of the original session token, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> does not update the session token in the token cache.</span></span> <span data-ttu-id="e9f35-117">Sie sollten immer ein Sitzungstoken mit einer eindeutigen Sitzungs-ID instanziieren.</span><span class="sxs-lookup"><span data-stu-id="e9f35-117">You should always instantiate a session token with a unique session ID.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e9f35-118">Die Methode „Session.SecurityTokenHandler.ReadToken“ löst eine <xref:System.Xml.XmlException>-Ausnahme aus, wenn sie eine ungültige Eingabe erhält, z.B. wenn das Cookie, das das Sitzungstoken enthält, beschädigt ist.</span><span class="sxs-lookup"><span data-stu-id="e9f35-118">Session.SecurityTokenHandler.ReadToken throws a <xref:System.Xml.XmlException> exception if it receives invalid input; for example, if the cookie that contains the session token is corrupted.</span></span> <span data-ttu-id="e9f35-119">Es wird empfohlen, diese Ausnahme abzufangen und anwendungsspezifisches Verhalten bereitzustellen.</span><span class="sxs-lookup"><span data-stu-id="e9f35-119">We recommend that you catch this exception and provide application-specific behavior.</span></span>  
  
 <span data-ttu-id="e9f35-120">Wenn eine geschützte Webseite große Menge von Ressourcen (z.B. kleine Grafiken) enthält, die auch in der geschützten Domäne enthalten sind, muss sich der Client gegenüber der vertrauenden Seite erneut authentifizieren, um jede dieser Ressourcen herunterzuladen.</span><span class="sxs-lookup"><span data-stu-id="e9f35-120">If a protected Web page contains lots of resources (such as small graphics) that are also in the protected domain, the client must re-authenticate itself to the relying party to download each of those resources.</span></span> <span data-ttu-id="e9f35-121">Wenn Sie ein Sitzungsauthentifizierungstoken verwenden, müssen Sie sich nicht für jede Anforderung gegenüber dem STS authentifizieren, aber es werden dennoch viele Cookies gesendet werden.</span><span class="sxs-lookup"><span data-stu-id="e9f35-121">Use of a session authentication token avoids the need to authenticate to the STS for each request, but it still means that many cookies are being sent over.</span></span> <span data-ttu-id="e9f35-122">Sie sollten die Webseite möglicherweise so einrichten, dass wichtige Daten und Ressourcen in der geschützten Domäne gespeichert werden, während kleinere Elemente in einer ungeschützten Domäne gespeichert und mit der Web-Hauptseite verknüpft sind.</span><span class="sxs-lookup"><span data-stu-id="e9f35-122">You might want to set up the Web page so that the important data and resources are stored in the protected domain while minor items are stored in an unprotected domain and linked to from the main Web page.</span></span> <span data-ttu-id="e9f35-123">Legen Sie den Cookiepfad so fest, dass er nur auf die geschützte Domäne verweist.</span><span class="sxs-lookup"><span data-stu-id="e9f35-123">Also, set the cookie path to reference only the protected domain.</span></span>  
  
 <span data-ttu-id="e9f35-124">Für den Betrieb im Verweismodus empfiehlt Microsoft die Bereitstellung eines Handlers für das <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated>-Ereignis in der Datei **global.asax.cs** sowie das Festlegen der **IsReferenceMode**-Eigenschaft im Token, das an die <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A>-Eigenschaft übergeben wurde.</span><span class="sxs-lookup"><span data-stu-id="e9f35-124">To operate in reference mode, Microsoft recommends providing a handler for the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> event in the **global.asax.cs** file and setting the **IsReferenceMode** property on the token passed in the <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> property.</span></span> <span data-ttu-id="e9f35-125">Diese Updates stellen sicher, dass das Sitzungstoken für jede Anforderung im Verweismodus arbeitet und gegenüber dem Festlegen der <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A>-Eigenschaft für das Sitzungsauthentifizierungsmodul bevorzugt wird.</span><span class="sxs-lookup"><span data-stu-id="e9f35-125">These updates will ensure that the session token operates in reference mode for every request and is favored over merely setting the  <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> property on the Session Authentication Module.</span></span>  
  
## <a name="extensibility"></a><span data-ttu-id="e9f35-126">Erweiterungen</span><span class="sxs-lookup"><span data-stu-id="e9f35-126">Extensibility</span></span>  
 <span data-ttu-id="e9f35-127">Sie können den Verwaltungsmechanismus der Sitzung erweitern.</span><span class="sxs-lookup"><span data-stu-id="e9f35-127">You can extend the session management mechanism.</span></span> <span data-ttu-id="e9f35-128">Ein Grund dafür wäre die Leistungsverbesserung.</span><span class="sxs-lookup"><span data-stu-id="e9f35-128">One reason for this would be to improve the performance.</span></span> <span data-ttu-id="e9f35-129">Beispielsweise könnten Sie einen benutzerdefinierten Cookiehandler erstellen, der das Sitzungssicherheitstoken zwischen dem cookie- und speicherinternen Zustand transformiert oder optimiert.</span><span class="sxs-lookup"><span data-stu-id="e9f35-129">For example, you could create a custom cookie handler that transforms or optimizes the session security token between its in-memory state and what goes into the cookie.</span></span> <span data-ttu-id="e9f35-130">Zu diesem Zweck können Sie die <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType>-Eigenschaft von <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> mit einem benutzerdefinierten Cookiehandler konfigurieren, der von <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType> abgeleitet wird.</span><span class="sxs-lookup"><span data-stu-id="e9f35-130">To do so, you can configure the <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> property of the <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> to use a custom cookie handler that derives from <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span></span> <span data-ttu-id="e9f35-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> ist der Standardhandler für das Cookie, weil die Cookies die zulässige Größe für das Hypertext Transfer Protocol (HTTP) überschreiten. Wenn Sie stattdessen einen benutzerdefinierten Cookiehandler verwenden, müssen Sie die Segmentierung implementieren.</span><span class="sxs-lookup"><span data-stu-id="e9f35-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> is the default cookie handler because the cookies exceed the allowable size for Hypertext Transfer Protocol (HTTP); if you use a custom cookie handler instead, you must implement chunking.</span></span>  
  
 <span data-ttu-id="e9f35-132">Weitere Informationen finden Sie unter [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) Beispiel.</span><span class="sxs-lookup"><span data-stu-id="e9f35-132">For more information, see [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) sample.</span></span> <span data-ttu-id="e9f35-133">Dieses Beispiel veranschaulicht ein Sitzungscache, das in einer Farm verwendet werden kann (im Gegensatz zu einem Tokenreplycache), sodass Sie Sitzungen als Verweis verwenden können und keine großen Cookies austauschen müssen. Das Beispiel zeigt ebenfalls eine einfachere Sicherung von Cookies in einer Farm.</span><span class="sxs-lookup"><span data-stu-id="e9f35-133">This sample shows a farm ready session cache (as opposed to a tokenreplycache) so that you can use sessions by reference instead of exchanging big cookies; this sample also demonstrates an easier way of securing cookies in a farm.</span></span> <span data-ttu-id="e9f35-134">Der Sitzungscache basiert auf WCF.</span><span class="sxs-lookup"><span data-stu-id="e9f35-134">The session cache is WCF-based.</span></span> <span data-ttu-id="e9f35-135">Im Hinblick auf die Sitzungssicherung zeigt das Beispiel eine neue Funktion in WIF 4.5 einer Cookie-Transformation, die auf MachineKey basiert, die aktiviert werden kann, indem Sie einfach den entsprechenden Ausschnitt in der Datei „Web.config“ einfügen. Das Beispiel selbst ist nicht „ausgelagert“, aber es zeigt, was Sie tun müssen, um die Anwendung darauf vorzubereiten.</span><span class="sxs-lookup"><span data-stu-id="e9f35-135">With regard to session securing, the sample demonstrates a new capability in WIF 4.5 of a cookie transform based on MachineKey, which can be activated by simply pasting the appropriate snippet in the web.config. The sample itself is not "farmed", but it demonstrates what you need for making your app farm-ready.</span></span>
