---
title: Delegierung und Identitätswechsel mit WCF
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- impersonation [WCF]
- delegation [WCF]
ms.assetid: 110e60f7-5b03-4b69-b667-31721b8e3152
ms.openlocfilehash: 4f86636cd244ce53ed00f80b38777e78a3278d6f
ms.sourcegitcommit: e08b319358a8025cc6aa38737854f7bdb87183d6
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 04/29/2019
ms.locfileid: "64912503"
---
# <a name="delegation-and-impersonation-with-wcf"></a><span data-ttu-id="9cdae-102">Delegierung und Identitätswechsel mit WCF</span><span class="sxs-lookup"><span data-stu-id="9cdae-102">Delegation and Impersonation with WCF</span></span>
<span data-ttu-id="9cdae-103">Der*Identitätswechsel* ist ein gängiges Verfahren, das Dienste verwenden, um den Clientzugriff auf die Ressourcen einer Dienstdomäne zu beschränken.</span><span class="sxs-lookup"><span data-stu-id="9cdae-103">*Impersonation* is a common technique that services use to restrict client access to a service domain's resources.</span></span> <span data-ttu-id="9cdae-104">Dienstdomänenressourcen können entweder Computerressourcen, wie lokale Dateien (Identitätswechsel), oder eine Ressource auf einem anderen Computer, z. B. eine Dateifreigabe (Delegierung), sein.</span><span class="sxs-lookup"><span data-stu-id="9cdae-104">Service domain resources can either be machine resources, such as local files (impersonation), or a resource on another machine, such as a file share (delegation).</span></span> <span data-ttu-id="9cdae-105">Eine Beispielanwendung finden Sie unter [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span><span class="sxs-lookup"><span data-stu-id="9cdae-105">For a sample application, see [Impersonating the Client](../../../../docs/framework/wcf/samples/impersonating-the-client.md).</span></span> <span data-ttu-id="9cdae-106">Ein Beispiel zur Verwendung von Identitätswechsel finden Sie unter [Vorgehensweise: Annehmen der Clientidentität für einen Dienst](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md).</span><span class="sxs-lookup"><span data-stu-id="9cdae-106">For an example of how to use impersonation, see [How to: Impersonate a Client on a Service](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md).</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="9cdae-107">Beim Identitätswechsel eines Clients in einem Dienst wird der Dienst mit den Anmeldeinformationen des Clients ausgeführt, die höhere Rechte besitzen können als der Serverprozess.</span><span class="sxs-lookup"><span data-stu-id="9cdae-107">Be aware that when impersonating a client on a service, the service runs with the client's credentials, which may have higher privileges than the server process.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="9cdae-108">Übersicht</span><span class="sxs-lookup"><span data-stu-id="9cdae-108">Overview</span></span>  
 <span data-ttu-id="9cdae-109">In der Regel ruft ein Client einen Dienst auf, damit dieser eine Aktion für ihn ausführt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-109">Typically, clients call a service to have the service perform some action on the client’s behalf.</span></span> <span data-ttu-id="9cdae-110">Der Identitätswechsel ermöglicht es dem Dienst, während der Ausführung der Aktion als Client zu fungieren.</span><span class="sxs-lookup"><span data-stu-id="9cdae-110">Impersonation allows the service to act as the client while performing the action.</span></span> <span data-ttu-id="9cdae-111">Die Delegierung ermöglicht es einem Front-End-Dienst, die Clientanforderung so an einen Back-End-Dienst weiterzuleiten, dass auch der Back-End-Dienst die Identität des Clients annehmen kann.</span><span class="sxs-lookup"><span data-stu-id="9cdae-111">Delegation allows a front-end service to forward the client’s request to a back-end service in such a way that the back-end service can also impersonate the client.</span></span> <span data-ttu-id="9cdae-112">Der Identitätswechsel wird meist als Möglichkeit verwendet, mit der überprüft werden kann, ob ein Client zur Durchführung einer bestimmten Aktion berechtigt ist. Die Delegierung stellt dagegen eine Möglichkeit dar, die Fähigkeit zum Identitätswechsel und die Clientidentität an einen Back-End-Dienst zu übertragen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-112">Impersonation is most commonly used as a way of checking whether a client is authorized to perform a particular action, while delegation is a way of flowing impersonation capabilities, along with the client’s identity, to a back-end service.</span></span> <span data-ttu-id="9cdae-113">Die Delegierung ist eine Windows-Domänenfunktion, die verwendet werden kann, wenn eine auf Kerberos basierende Authentifizierung durchgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="9cdae-113">Delegation is a Windows domain feature that can be used when Kerberos-based authentication is performed.</span></span> <span data-ttu-id="9cdae-114">Delegierung und Identitätsübergabe sind zwei verschiedene Dinge. Weil bei der Delegierung die Fähigkeit zur Annahme der Identität des Clients übertragen wird, ohne das Kennwort des Clients zu besitzen, handelt es sich um einen Vorgang mit höheren Sicherheitsberechtigungen als die Identitätsübergabe.</span><span class="sxs-lookup"><span data-stu-id="9cdae-114">Delegation is distinct from identity flow and, because delegation transfers the ability to impersonate the client without possession of the client’s password, it is a much higher privileged operation than identity flow.</span></span>  
  
 <span data-ttu-id="9cdae-115">Sowohl Identitätswechsel als auch Delegierung erfordern, dass der Client eine Windows-Identität besitzt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-115">Both impersonation and delegation require that the client have a Windows identity.</span></span> <span data-ttu-id="9cdae-116">Wenn der Client keine Windows-Identität besitzt, dann besteht nur die Möglichkeit, die Identität des Clients dem zweiten Dienst zu übertragen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-116">If a client does not possess a Windows identity, then the only option available is to flow the client’s identity to the second service.</span></span>  
  
## <a name="impersonation-basics"></a><span data-ttu-id="9cdae-117">Grundlagen des Identitätswechsels</span><span class="sxs-lookup"><span data-stu-id="9cdae-117">Impersonation Basics</span></span>  
 <span data-ttu-id="9cdae-118">Windows Communication Foundation (WCF) unterstützt den Identitätswechsel für eine Vielzahl von Clientanmeldeinformationen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-118">Windows Communication Foundation (WCF) supports impersonation for a variety of client credentials.</span></span> <span data-ttu-id="9cdae-119">In diesem Thema wird die Dienstmodellunterstützung für den Identitätswechsel des Aufrufers während der Implementierung einer Dienstmethode beschrieben.</span><span class="sxs-lookup"><span data-stu-id="9cdae-119">This topic describes service model support for impersonating the caller during the implementation of a service method.</span></span> <span data-ttu-id="9cdae-120">Die interoperabilitätsbestrebungen von werden allgemeine Bereitstellungsszenarien, die im Zusammenhang mit Identitätswechsel und SOAP-Sicherheit und WCF-Optionen in diesen Szenarien.</span><span class="sxs-lookup"><span data-stu-id="9cdae-120">Also discussed are common deployment scenarios involving impersonation and SOAP security and WCF options in these scenarios.</span></span>  
  
 <span data-ttu-id="9cdae-121">In diesem Thema liegt der Schwerpunkt auf dem Identitätswechsel und Delegierung in WCF bei Verwendung der SOAP-Sicherheit.</span><span class="sxs-lookup"><span data-stu-id="9cdae-121">This topic focuses on impersonation and delegation in WCF when using SOAP security.</span></span> <span data-ttu-id="9cdae-122">Außerdem können Sie Identitätswechsel und Delegierung mit WCF Wenn transportsicherheit nutzen, wie in beschrieben [Using Impersonation with Transport Security](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span><span class="sxs-lookup"><span data-stu-id="9cdae-122">You can also use impersonation and delegation with WCF when using transport security, as described in [Using Impersonation with Transport Security](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md).</span></span>  
  
## <a name="two-methods"></a><span data-ttu-id="9cdae-123">Zwei Methoden</span><span class="sxs-lookup"><span data-stu-id="9cdae-123">Two Methods</span></span>  
 <span data-ttu-id="9cdae-124">WCF-SOAP-Sicherheit verfügt über zwei unterschiedliche Methoden zum Durchführen von Identitätswechsel.</span><span class="sxs-lookup"><span data-stu-id="9cdae-124">WCF SOAP security has two distinct methods for performing impersonation.</span></span> <span data-ttu-id="9cdae-125">Die verwendete Methode hängt von der Bindung ab.</span><span class="sxs-lookup"><span data-stu-id="9cdae-125">The method used depends on the binding.</span></span> <span data-ttu-id="9cdae-126">Die eine Methode besteht im Identitätswechsel von einem Windows-Token aus, das von SSPI (Security Support Provider Interface) oder der Kerberos-Authentifizierung stammt, die dann im Cache des Diensts gespeichert wird.</span><span class="sxs-lookup"><span data-stu-id="9cdae-126">One is impersonation from a Windows token obtained from the Security Support Provider Interface (SSPI) or Kerberos authentication, which is then cached on the service.</span></span> <span data-ttu-id="9cdae-127">Die zweite Methode besteht im Identitätswechsel von einem Windows-Token aus, das von Kerberos-Erweiterungen stammt, insgesamt als *Service-for-User* (S4U) bezeichnet.</span><span class="sxs-lookup"><span data-stu-id="9cdae-127">The second is impersonation from a Windows token obtained from the Kerberos extensions, collectively called *Service-for-User* (S4U).</span></span>  
  
### <a name="cached-token-impersonation"></a><span data-ttu-id="9cdae-128">Identitätswechsel mit im Cache gespeichertem Token</span><span class="sxs-lookup"><span data-stu-id="9cdae-128">Cached Token Impersonation</span></span>  
 <span data-ttu-id="9cdae-129">Sie können einen Identitätswechsel mit einem im Cache gespeicherten Token folgendermaßen ausführen:</span><span class="sxs-lookup"><span data-stu-id="9cdae-129">You can perform cached-token impersonation with the following:</span></span>  
  
- <span data-ttu-id="9cdae-130">Mit<xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>und <xref:System.ServiceModel.NetTcpBinding> mit Windows-Clientanmeldeinformationen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-130"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a Windows client credential.</span></span>  
  
- <span data-ttu-id="9cdae-131">Mit<xref:System.ServiceModel.BasicHttpBinding> , mit einem <xref:System.ServiceModel.BasicHttpSecurityMode> , der auf die <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> -Anmeldeinformationen eingestellt ist, oder einer anderen Standardbindung, bei der der Client Benutzernamen-Anmeldeinformationen präsentiert, die der Dienst einem gültigen Windows-Konto zuordnen kann.</span><span class="sxs-lookup"><span data-stu-id="9cdae-131"><xref:System.ServiceModel.BasicHttpBinding> with a <xref:System.ServiceModel.BasicHttpSecurityMode> set to the <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> credential, or any other standard binding where the client presents a user name credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="9cdae-132">Mit jeder <xref:System.ServiceModel.Channels.CustomBinding> , die Windows-Clientanmeldeinformationen verwendet, bei denen `requireCancellation` auf `true`eingestellt ist.</span><span class="sxs-lookup"><span data-stu-id="9cdae-132">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` set to `true`.</span></span> <span data-ttu-id="9cdae-133">(Die Eigenschaft ist für folgende Klassen verfügbar: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters> und <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) Bei Verwendung einer sicheren Konversation auf der Bindung muss die `requireCancellation`-Eigenschaft auch auf `true` eingestellt sein.</span><span class="sxs-lookup"><span data-stu-id="9cdae-133">(The property is available on the following classes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, and <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) If a secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
- <span data-ttu-id="9cdae-134">Mit jeder <xref:System.ServiceModel.Channels.CustomBinding> , bei der der Client Benutzernamen-Anmeldeinformationen präsentiert.</span><span class="sxs-lookup"><span data-stu-id="9cdae-134">Any <xref:System.ServiceModel.Channels.CustomBinding> where the client presents a user name credential.</span></span> <span data-ttu-id="9cdae-135">Bei Verwendung einer sicheren Konversation auf der Bindung muss die `requireCancellation` -Eigenschaft auch auf `true`eingestellt sein.</span><span class="sxs-lookup"><span data-stu-id="9cdae-135">If secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
### <a name="s4u-based-impersonation"></a><span data-ttu-id="9cdae-136">Auf S4U basierender Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="9cdae-136">S4U-Based Impersonation</span></span>  
 <span data-ttu-id="9cdae-137">Sie können einen auf S4U basierenden Identitätswechsel folgendermaßen ausführen:</span><span class="sxs-lookup"><span data-stu-id="9cdae-137">You can perform S4U-based impersonation with the following:</span></span>  
  
- <span data-ttu-id="9cdae-138">Mit<xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>und <xref:System.ServiceModel.NetTcpBinding> mit Zertifikatclient-Anmeldeinformationen, die der Dienst einem gültigen Windows-Konto zuordnen kann.</span><span class="sxs-lookup"><span data-stu-id="9cdae-138"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a certificate client credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="9cdae-139">Mit jeder <xref:System.ServiceModel.Channels.CustomBinding> , die Windows-Clientanmeldeinformationen verwendet, bei denen die `requireCancellation` -Eigenschaft auf `false`eingestellt ist.</span><span class="sxs-lookup"><span data-stu-id="9cdae-139">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` property set to `false`.</span></span>  
  
- <span data-ttu-id="9cdae-140">Mit jeder <xref:System.ServiceModel.Channels.CustomBinding> , die einen Benutzernamen oder Windows-Clientanmeldeinformationen und eine sichere Konversation verwendet, wobei die `requireCancellation` -Eigenschaft auf `false`eingestellt ist.</span><span class="sxs-lookup"><span data-stu-id="9cdae-140">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a user name or Windows client credential and secure conversation with the `requireCancellation` property set to `false`.</span></span>  
  
 <span data-ttu-id="9cdae-141">Inwieweit der Dienst die Identität des Clients annehmen kann, hängt von den Rechten ab, die das Dienstkonto beim Versuch des Identitätswechsels besitzt, vom verwendeten Typ des Identitätswechsels und möglicherweise vom Ausmaß des Identitätswechsels, den der Client zulässt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-141">The extent to which the service can impersonate the client depends on the privileges the service account holds when it attempts impersonation, the type of impersonation used, and possibly the extent of impersonation the client permits.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="9cdae-142">Wenn Client und Dienst auf demselben Computer ausgeführt werden und der Client unter einem Systemkonto (z. B. unter `Local System` oder `Network Service`) ausgeführt wird, kann kein Clientidentitätswechsel vorgenommen werden, wenn mit Token für den Sicherheitszustandskontext eine Sicherheitsverbindung hergestellt wird.</span><span class="sxs-lookup"><span data-stu-id="9cdae-142">When the client and service are running on the same computer and the client is running under a system account (for example, `Local System` or `Network Service`), the client cannot be impersonated when a secure session is established with stateful Security Context tokens.</span></span> <span data-ttu-id="9cdae-143">Eine Windows Forms- oder Konsolenanwendung wird in der Regel unter dem derzeit angemeldeten Konto ausgeführt, sodass für dieses Konto standardmäßig ein Identitätswechsel durchgeführt werden kann.</span><span class="sxs-lookup"><span data-stu-id="9cdae-143">A Windows Form or console application typically runs under the currently logged-in account, so that account can be impersonated by default.</span></span> <span data-ttu-id="9cdae-144">Wenn es sich bei dem Client jedoch um eine [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] -Seite handelt, die auf [!INCLUDE[iis601](../../../../includes/iis601-md.md)] oder [!INCLUDE[iisver](../../../../includes/iisver-md.md)]gehostet wird, wird der Client standardmäßig unter dem `Network Service` -Konto ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-144">However, when the client is an [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] page and that page is hosted in [!INCLUDE[iis601](../../../../includes/iis601-md.md)] or [!INCLUDE[iisver](../../../../includes/iisver-md.md)], then the client does run under the `Network Service` account by default.</span></span> <span data-ttu-id="9cdae-145">Alle vom System bereitgestellten Bindungen, die Sicherheitssitzungen unterstützen, verwenden standardmäßig ein zustandsloses Token für den Sicherheitskontext.</span><span class="sxs-lookup"><span data-stu-id="9cdae-145">All of the system-provided bindings that support secure sessions use a stateless security context token (SCT) by default.</span></span> <span data-ttu-id="9cdae-146">Wenn es sich bei dem Client jedoch um eine [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] -Seite handelt und sichere Sitzungen mit zustandsbehafteten SCTs verwendet werden, kann kein Clientidentitätswechsel durchgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="9cdae-146">However, if the client is an [!INCLUDE[vstecasp](../../../../includes/vstecasp-md.md)] page, and secure sessions with stateful SCTs are used, the client cannot be impersonated.</span></span> <span data-ttu-id="9cdae-147">Weitere Informationen zur Verwendung von zustandsbehafteten SCTs in einer sicheren Sitzung finden Sie unter [Vorgehensweise: Erstellen Sie einen Sicherheitskontext für eine sichere Sitzung Token](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).</span><span class="sxs-lookup"><span data-stu-id="9cdae-147">For more information about using stateful SCTs in a secure session, see [How to: Create a Security Context Token for a Secure Session](../../../../docs/framework/wcf/feature-details/how-to-create-a-security-context-token-for-a-secure-session.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-declarative-model"></a><span data-ttu-id="9cdae-148">Identitätswechsel in einer Dienstmethode: Deklaratives Modell</span><span class="sxs-lookup"><span data-stu-id="9cdae-148">Impersonation in a Service Method: Declarative Model</span></span>  
 <span data-ttu-id="9cdae-149">Die meisten Identitätswechselszenarien umfassen das Ausführen der Dienstmethode im Aufruferkontext.</span><span class="sxs-lookup"><span data-stu-id="9cdae-149">Most impersonation scenarios involve executing the service method in the caller context.</span></span> <span data-ttu-id="9cdae-150">WCF bietet eine Identitätswechselfunktion, die dadurch erleichtert, indem der Benutzer an die Identitätswechsel-Anforderung in die <xref:System.ServiceModel.OperationBehaviorAttribute> Attribut.</span><span class="sxs-lookup"><span data-stu-id="9cdae-150">WCF provides an impersonation feature that makes this easy to do by allowing the user to specify the impersonation requirement in the <xref:System.ServiceModel.OperationBehaviorAttribute> attribute.</span></span> <span data-ttu-id="9cdae-151">Z. B. in den folgenden Code, die WCF-Infrastruktur nimmt die Identität des Aufrufers vor dem Ausführen der `Hello` Methode.</span><span class="sxs-lookup"><span data-stu-id="9cdae-151">For example, in the following code, the WCF infrastructure impersonates the caller before executing the `Hello` method.</span></span> <span data-ttu-id="9cdae-152">Jeder Versuch, auf die systemeigenen Ressourcen innerhalb der `Hello` -Methode zuzugreifen, ist nur erfolgreich, wenn die Zugriffsteuerungsliste der Ressource dem Aufrufer Zugriffsrechte erlaubt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-152">Any attempt to access native resources inside the `Hello` method succeed only if the access control list (ACL) of the resource allows the caller access privileges.</span></span> <span data-ttu-id="9cdae-153">Zum Aktivieren des Identitätswechsels legen Sie die <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> -Eigenschaft auf einen der <xref:System.ServiceModel.ImpersonationOption> -Enumerationswerte fest, entweder auf <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> oder auf <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, wie im folgenden Beispiel dargestellt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-153">To enable impersonation, set the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property to one of the <xref:System.ServiceModel.ImpersonationOption> enumeration values, either <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> or <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, as shown in the following example.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="9cdae-154">Wenn ein Dienst höhere Anmeldeinformationen besitzt als der Remoteclient, werden die Anmeldeinformationen des Diensts verwendet, wenn die <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> -Eigenschaft auf <xref:System.ServiceModel.ImpersonationOption.Allowed>eingestellt ist.</span><span class="sxs-lookup"><span data-stu-id="9cdae-154">When a service has higher credentials than the remote client, the credentials of the service are used if the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span></span> <span data-ttu-id="9cdae-155">Wenn also ein Benutzer mit niedrigen Rechten seine Anmeldeinformationen angibt, führt ein Dienst mit höheren Rechten die Methode mit den Anmeldeinformationen des Diensts aus und kann Ressourcen verwenden, die der Benutzer mit den niedrigen Rechten sonst keinesfalls verwenden könnte.</span><span class="sxs-lookup"><span data-stu-id="9cdae-155">That is, if a low-privileged user provides its credentials, a higher-privileged service executes the method with the credentials of the service, and can use resources that the low-privileged user would otherwise not be able to use.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#1)]
 [!code-vb[c_ImpersonationAndDelegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#1)]  
  
 <span data-ttu-id="9cdae-156">Die WCF-Infrastruktur kann die Identität des Aufrufers nur dann, wenn der Aufrufer mit Anmeldeinformationen authentifiziert wird, die ein Windows-Benutzerkonto zugeordnet werden können.</span><span class="sxs-lookup"><span data-stu-id="9cdae-156">The WCF infrastructure can impersonate the caller only if the caller is authenticated with credentials that can be mapped to a Windows user account.</span></span> <span data-ttu-id="9cdae-157">Wenn der Dienst für die Authentifizierung mit Anmeldeinformationen konfiguriert ist, die keinem Windows-Konto zugeordnet werden können, wird die Dienstmethode nicht ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-157">If the service is configured to authenticate using a credential that cannot be mapped to a Windows account, the service method is not executed.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="9cdae-158">Unter [!INCLUDE[wxp](../../../../includes/wxp-md.md)]schlägt der Identitätswechsel beim Erstellen eines zustandsbehafteten SCT fehl, was zu einer <xref:System.InvalidOperationException>führt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-158">On [!INCLUDE[wxp](../../../../includes/wxp-md.md)], impersonation fails if a stateful SCT is created, resulting in an <xref:System.InvalidOperationException>.</span></span> <span data-ttu-id="9cdae-159">Weitere Informationen finden Sie unter [nicht unterstützte Szenarien](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span><span class="sxs-lookup"><span data-stu-id="9cdae-159">For more information, see [Unsupported Scenarios](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-imperative-model"></a><span data-ttu-id="9cdae-160">Identitätswechsel in einer Dienstmethode: Verbindliches Modell</span><span class="sxs-lookup"><span data-stu-id="9cdae-160">Impersonation in a Service Method: Imperative Model</span></span>  
 <span data-ttu-id="9cdae-161">Mitunter benötigt ein Aufrufer nicht die gesamte Dienstmethode für den Identitätswechsel, sondern nur einen Teil der Methode.</span><span class="sxs-lookup"><span data-stu-id="9cdae-161">Sometimes a caller does not need to impersonate the entire service method to function, but for only a portion of it.</span></span> <span data-ttu-id="9cdae-162">In diesem Fall rufen Sie die Windows-Identität des Aufrufers innerhalb der Dienstmethode ab, und führen Sie den Identitätswechsel imperativ durch.</span><span class="sxs-lookup"><span data-stu-id="9cdae-162">In this case, obtain the Windows identity of the caller inside the service method and imperatively perform the impersonation.</span></span> <span data-ttu-id="9cdae-163">Verwenden Sie dazu die <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> -Eigenschaft des <xref:System.ServiceModel.ServiceSecurityContext> , um eine Instanz der <xref:System.Security.Principal.WindowsIdentity> -Klasse zurückzugeben und die <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> -Methode vor dem Verwenden der Instanz aufzurufen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-163">Do this by using the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property of the <xref:System.ServiceModel.ServiceSecurityContext> to return an instance of the <xref:System.Security.Principal.WindowsIdentity> class and calling the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method before using the instance.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="9cdae-164">Achten Sie darauf, dass Sie das Visual Basic verwenden`Using` -Anweisung oder die C#- `using` Anweisung, um den Identitätswechsel automatisch rückgängig.</span><span class="sxs-lookup"><span data-stu-id="9cdae-164">Be sure to use the Visual Basic`Using` statement or the C# `using` statement to automatically revert the impersonation action.</span></span> <span data-ttu-id="9cdae-165">Achten Sie Wenn Sie die Anweisung nicht verwenden oder wenn Sie eine Programmiersprache als Visual Basic oder c# verwenden, darauf, dass Sie die Identitätswechselebene zurücksetzen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-165">If you do not use the statement, or if you use a programming language other than Visual Basic or C#, be sure to revert the impersonation level.</span></span> <span data-ttu-id="9cdae-166">Wird dies versäumt, kann dies die Grundlage für Denial-of-Service-Angriffe und Rechteerweiterungsangriffe bilden.</span><span class="sxs-lookup"><span data-stu-id="9cdae-166">Failure to do this can form the basis for denial of service and elevation of privilege attacks.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#2)]
 [!code-vb[c_ImpersonationAndDelegation#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#2)]  
  
## <a name="impersonation-for-all-service-methods"></a><span data-ttu-id="9cdae-167">Identitätswechsel für alle Dienstmethoden</span><span class="sxs-lookup"><span data-stu-id="9cdae-167">Impersonation for All Service Methods</span></span>  
 <span data-ttu-id="9cdae-168">In einigen Fällen müssen Sie alle Methoden eines Diensts im Kontext eines Aufrufers ausführen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-168">In some cases, you must perform all the methods of a service in the caller’s context.</span></span> <span data-ttu-id="9cdae-169">Statt diese Funktion explizit für jede Methode einzeln zu aktivieren, verwenden Sie das <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span><span class="sxs-lookup"><span data-stu-id="9cdae-169">Instead of explicitly enabling this feature on a per-method basis, use the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span></span> <span data-ttu-id="9cdae-170">Wie im folgenden Code dargestellt, legen Sie die <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> -Eigenschaft auf `true`fest.</span><span class="sxs-lookup"><span data-stu-id="9cdae-170">As shown in the following code, set the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> property to `true`.</span></span> <span data-ttu-id="9cdae-171">Das <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> wird aus den Verhaltenssammlungen der <xref:System.ServiceModel.ServiceHost> -Klasse abgerufen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-171">The <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> is retrieved from the collections of behaviors of the <xref:System.ServiceModel.ServiceHost> class.</span></span> <span data-ttu-id="9cdae-172">Beachten Sie außerdem, dass die `Impersonation` -Eigenschaft des auf jede Methode angewendeten <xref:System.ServiceModel.OperationBehaviorAttribute> ebenfalls entweder auf <xref:System.ServiceModel.ImpersonationOption.Allowed> oder <xref:System.ServiceModel.ImpersonationOption.Required>eingestellt sein muss.</span><span class="sxs-lookup"><span data-stu-id="9cdae-172">Also note that the `Impersonation` property of the <xref:System.ServiceModel.OperationBehaviorAttribute> applied to each method must also be set to either <xref:System.ServiceModel.ImpersonationOption.Allowed> or <xref:System.ServiceModel.ImpersonationOption.Required>.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#3)]
 [!code-vb[c_ImpersonationAndDelegation#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#3)]  
  
 <span data-ttu-id="9cdae-173">Die folgende Tabelle beschreibt die WCF-Verhalten für alle möglichen Kombinationen von `ImpersonationOption` und `ImpersonateCallerForAllServiceOperations`.</span><span class="sxs-lookup"><span data-stu-id="9cdae-173">The following table describes WCF behavior for all possible combinations of `ImpersonationOption` and `ImpersonateCallerForAllServiceOperations`.</span></span>  
  
|`ImpersonationOption`|`ImpersonateCallerForAllServiceOperations`|<span data-ttu-id="9cdae-174">Verhalten</span><span class="sxs-lookup"><span data-stu-id="9cdae-174">Behavior</span></span>|  
|---------------------------|------------------------------------------------|--------------|  
|<span data-ttu-id="9cdae-175">Erforderlich</span><span class="sxs-lookup"><span data-stu-id="9cdae-175">Required</span></span>|<span data-ttu-id="9cdae-176">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-176">n/a</span></span>|<span data-ttu-id="9cdae-177">WCF-Identität des Aufrufers</span><span class="sxs-lookup"><span data-stu-id="9cdae-177">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="9cdae-178">Allowed</span><span class="sxs-lookup"><span data-stu-id="9cdae-178">Allowed</span></span>|<span data-ttu-id="9cdae-179">False</span><span class="sxs-lookup"><span data-stu-id="9cdae-179">false</span></span>|<span data-ttu-id="9cdae-180">WCF ist keine Identität des Aufrufers annehmen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-180">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="9cdae-181">Allowed</span><span class="sxs-lookup"><span data-stu-id="9cdae-181">Allowed</span></span>|<span data-ttu-id="9cdae-182">true</span><span class="sxs-lookup"><span data-stu-id="9cdae-182">true</span></span>|<span data-ttu-id="9cdae-183">WCF-Identität des Aufrufers</span><span class="sxs-lookup"><span data-stu-id="9cdae-183">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="9cdae-184">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="9cdae-184">NotAllowed</span></span>|<span data-ttu-id="9cdae-185">False</span><span class="sxs-lookup"><span data-stu-id="9cdae-185">false</span></span>|<span data-ttu-id="9cdae-186">WCF ist keine Identität des Aufrufers annehmen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-186">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="9cdae-187">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="9cdae-187">NotAllowed</span></span>|<span data-ttu-id="9cdae-188">true</span><span class="sxs-lookup"><span data-stu-id="9cdae-188">true</span></span>|<span data-ttu-id="9cdae-189">Disallowed.</span><span class="sxs-lookup"><span data-stu-id="9cdae-189">Disallowed.</span></span> <span data-ttu-id="9cdae-190">(Eine <xref:System.InvalidOperationException> wird ausgelöst.)</span><span class="sxs-lookup"><span data-stu-id="9cdae-190">(An <xref:System.InvalidOperationException> is thrown.)</span></span>|  
  
## <a name="impersonation-level-obtained-from-windows-credentials-and-cached-token-impersonation"></a><span data-ttu-id="9cdae-191">Identitätswechselebene aus Windows-Anmeldeinformationen und Identitätswechsel mit im Cache gespeichertem Token</span><span class="sxs-lookup"><span data-stu-id="9cdae-191">Impersonation Level Obtained from Windows Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="9cdae-192">In einigen Szenarien besitzt der Client eine Teilkontrolle über die Ebene des Identitätswechsels, den der Dienst bei Verwendung von Windows-Clientanmeldeinformationen ausführt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-192">In some scenarios the client has partial control over the level of impersonation the service performs when a Windows client credential is used.</span></span> <span data-ttu-id="9cdae-193">Ein Szenario tritt auf, wenn der Client die Identitätswechselebene "Anonymous" angibt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-193">One scenario occurs when the client specifies an Anonymous impersonation level.</span></span> <span data-ttu-id="9cdae-194">Das andere Szenario liegt vor, wenn Sie einen Identitätswechsel mit einem im Cache gespeicherten Token ausführen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-194">The other occurs when performing impersonation with a cached token.</span></span> <span data-ttu-id="9cdae-195">Legen Sie hierfür die <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> -Eigenschaft der <xref:System.ServiceModel.Security.WindowsClientCredential> -Klasse fest, auf die als Eigenschaft der generischen <xref:System.ServiceModel.ChannelFactory%601> -Klasse zugegriffen wird.</span><span class="sxs-lookup"><span data-stu-id="9cdae-195">This is done by setting the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class, which is accessed as a property of the generic <xref:System.ServiceModel.ChannelFactory%601> class.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="9cdae-196">Durch Angeben der Identitätswechselebene "Anonymous" meldet sich der Client anonym beim Dienst an.</span><span class="sxs-lookup"><span data-stu-id="9cdae-196">Specifying an impersonation level of Anonymous causes the client to log on to the service anonymously.</span></span> <span data-ttu-id="9cdae-197">Der Dienst muss daher anonyme Anmeldungen zulassen, unabhängig davon, ob ein Identitätswechsel durchgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="9cdae-197">The service must therefore allow anonymous logons, regardless of whether impersonation is performed.</span></span>  
  
 <span data-ttu-id="9cdae-198">Der Client kann die Identitätswechselebene als <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>oder <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>angeben.</span><span class="sxs-lookup"><span data-stu-id="9cdae-198">The client can specify the impersonation level as <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, or <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="9cdae-199">Es wird nur ein Token auf der angegebenen Ebene erstellt, wie im folgenden Code veranschaulicht.</span><span class="sxs-lookup"><span data-stu-id="9cdae-199">Only a token at the specified level is produced, as shown in the following code.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#4)]
 [!code-vb[c_ImpersonationAndDelegation#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#4)]  
  
 <span data-ttu-id="9cdae-200">In der folgenden Tabelle wird die Identitätswechselebene angegeben, die der Dienst bei einem Identitätswechsel mit einem im Cache gespeicherten Token erhält.</span><span class="sxs-lookup"><span data-stu-id="9cdae-200">The following table specifies the impersonation level the service obtains when impersonating from a cached token.</span></span>  
  
|<span data-ttu-id="9cdae-201">`AllowedImpersonationLevel` -Wert</span><span class="sxs-lookup"><span data-stu-id="9cdae-201">`AllowedImpersonationLevel` value</span></span>|<span data-ttu-id="9cdae-202">Der Dienst hat das `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="9cdae-202">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="9cdae-203">Dienst und Client sind delegierungsfähig.</span><span class="sxs-lookup"><span data-stu-id="9cdae-203">Service and client are capable of delegation</span></span>|<span data-ttu-id="9cdae-204"> `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="9cdae-204">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="9cdae-205">Anonym</span><span class="sxs-lookup"><span data-stu-id="9cdae-205">Anonymous</span></span>|<span data-ttu-id="9cdae-206">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-206">Yes</span></span>|<span data-ttu-id="9cdae-207">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-207">n/a</span></span>|<span data-ttu-id="9cdae-208">Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="9cdae-208">Impersonation</span></span>|  
|<span data-ttu-id="9cdae-209">Anonym</span><span class="sxs-lookup"><span data-stu-id="9cdae-209">Anonymous</span></span>|<span data-ttu-id="9cdae-210">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-210">No</span></span>|<span data-ttu-id="9cdae-211">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-211">n/a</span></span>|<span data-ttu-id="9cdae-212">Identifikation</span><span class="sxs-lookup"><span data-stu-id="9cdae-212">Identification</span></span>|  
|<span data-ttu-id="9cdae-213">Identifikation</span><span class="sxs-lookup"><span data-stu-id="9cdae-213">Identification</span></span>|<span data-ttu-id="9cdae-214">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-214">n/a</span></span>|<span data-ttu-id="9cdae-215">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-215">n/a</span></span>|<span data-ttu-id="9cdae-216">Identifikation</span><span class="sxs-lookup"><span data-stu-id="9cdae-216">Identification</span></span>|  
|<span data-ttu-id="9cdae-217">Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="9cdae-217">Impersonation</span></span>|<span data-ttu-id="9cdae-218">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-218">Yes</span></span>|<span data-ttu-id="9cdae-219">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-219">n/a</span></span>|<span data-ttu-id="9cdae-220">Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="9cdae-220">Impersonation</span></span>|  
|<span data-ttu-id="9cdae-221">Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="9cdae-221">Impersonation</span></span>|<span data-ttu-id="9cdae-222">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-222">No</span></span>|<span data-ttu-id="9cdae-223">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-223">n/a</span></span>|<span data-ttu-id="9cdae-224">Identifikation</span><span class="sxs-lookup"><span data-stu-id="9cdae-224">Identification</span></span>|  
|<span data-ttu-id="9cdae-225">Delegierung</span><span class="sxs-lookup"><span data-stu-id="9cdae-225">Delegation</span></span>|<span data-ttu-id="9cdae-226">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-226">Yes</span></span>|<span data-ttu-id="9cdae-227">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-227">Yes</span></span>|<span data-ttu-id="9cdae-228">Delegierung</span><span class="sxs-lookup"><span data-stu-id="9cdae-228">Delegation</span></span>|  
|<span data-ttu-id="9cdae-229">Delegierung</span><span class="sxs-lookup"><span data-stu-id="9cdae-229">Delegation</span></span>|<span data-ttu-id="9cdae-230">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-230">Yes</span></span>|<span data-ttu-id="9cdae-231">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-231">No</span></span>|<span data-ttu-id="9cdae-232">Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="9cdae-232">Impersonation</span></span>|  
|<span data-ttu-id="9cdae-233">Delegierung</span><span class="sxs-lookup"><span data-stu-id="9cdae-233">Delegation</span></span>|<span data-ttu-id="9cdae-234">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-234">No</span></span>|<span data-ttu-id="9cdae-235">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-235">n/a</span></span>|<span data-ttu-id="9cdae-236">Identifikation</span><span class="sxs-lookup"><span data-stu-id="9cdae-236">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-user-name-credentials-and-cached-token-impersonation"></a><span data-ttu-id="9cdae-237">Identitätswechselebene aus Benutzernamen-Anmeldeinformationen und Identitätswechsel mit im Cache gespeichertem Token</span><span class="sxs-lookup"><span data-stu-id="9cdae-237">Impersonation Level Obtained from User Name Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="9cdae-238">Übergeben Sie dem Dienst an, seinen Benutzernamen und Kennwort, einem Client ermöglicht WCF an, als dieser Benutzer anzumelden. dies dem Festlegen entspricht der `AllowedImpersonationLevel` Eigenschaft <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="9cdae-238">By passing the service its user name and password, a client enables WCF to log on as that user, which is equivalent to setting the `AllowedImpersonationLevel` property to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="9cdae-239">(Die `AllowedImpersonationLevel` ist in der <xref:System.ServiceModel.Security.WindowsClientCredential>-Klasse und in der <xref:System.ServiceModel.Security.HttpDigestClientCredential>-Klasse verfügbar.) In der folgenden Tabelle wird die Identitätswechselebene angegeben, die erhalten wird, wenn der Dienst Benutzernamen-Anmeldeinformationen empfängt.</span><span class="sxs-lookup"><span data-stu-id="9cdae-239">(The `AllowedImpersonationLevel` is available on the <xref:System.ServiceModel.Security.WindowsClientCredential> and <xref:System.ServiceModel.Security.HttpDigestClientCredential> classes.) The following table provides the impersonation level obtained when the service receives user name credentials.</span></span>  
  
|`AllowedImpersonationLevel`|<span data-ttu-id="9cdae-240">Der Dienst hat das `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="9cdae-240">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="9cdae-241">Dienst und Client sind delegierungsfähig.</span><span class="sxs-lookup"><span data-stu-id="9cdae-241">Service and client are capable of delegation</span></span>|<span data-ttu-id="9cdae-242"> `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="9cdae-242">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="9cdae-243">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-243">n/a</span></span>|<span data-ttu-id="9cdae-244">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-244">Yes</span></span>|<span data-ttu-id="9cdae-245">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-245">Yes</span></span>|<span data-ttu-id="9cdae-246">Delegierung</span><span class="sxs-lookup"><span data-stu-id="9cdae-246">Delegation</span></span>|  
|<span data-ttu-id="9cdae-247">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-247">n/a</span></span>|<span data-ttu-id="9cdae-248">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-248">Yes</span></span>|<span data-ttu-id="9cdae-249">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-249">No</span></span>|<span data-ttu-id="9cdae-250">Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="9cdae-250">Impersonation</span></span>|  
|<span data-ttu-id="9cdae-251">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-251">n/a</span></span>|<span data-ttu-id="9cdae-252">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-252">No</span></span>|<span data-ttu-id="9cdae-253">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-253">n/a</span></span>|<span data-ttu-id="9cdae-254">Identifikation</span><span class="sxs-lookup"><span data-stu-id="9cdae-254">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-s4u-based-impersonation"></a><span data-ttu-id="9cdae-255">Identitätswechselebene aus einem auf S4U basierenden Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="9cdae-255">Impersonation Level Obtained from S4U-Based Impersonation</span></span>  
  
|<span data-ttu-id="9cdae-256">Der Dienst hat das `SeTcbPrivilege`</span><span class="sxs-lookup"><span data-stu-id="9cdae-256">Service has `SeTcbPrivilege`</span></span>|<span data-ttu-id="9cdae-257">Der Dienst hat das `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="9cdae-257">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="9cdae-258">Dienst und Client sind delegierungsfähig.</span><span class="sxs-lookup"><span data-stu-id="9cdae-258">Service and client are capable of delegation</span></span>|<span data-ttu-id="9cdae-259"> `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="9cdae-259">Cached token `ImpersonationLevel`</span></span>|  
|----------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="9cdae-260">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-260">Yes</span></span>|<span data-ttu-id="9cdae-261">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-261">Yes</span></span>|<span data-ttu-id="9cdae-262">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-262">n/a</span></span>|<span data-ttu-id="9cdae-263">Identitätswechsel</span><span class="sxs-lookup"><span data-stu-id="9cdae-263">Impersonation</span></span>|  
|<span data-ttu-id="9cdae-264">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-264">Yes</span></span>|<span data-ttu-id="9cdae-265">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-265">No</span></span>|<span data-ttu-id="9cdae-266">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-266">n/a</span></span>|<span data-ttu-id="9cdae-267">Identifikation</span><span class="sxs-lookup"><span data-stu-id="9cdae-267">Identification</span></span>|  
|<span data-ttu-id="9cdae-268">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-268">No</span></span>|<span data-ttu-id="9cdae-269">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-269">n/a</span></span>|<span data-ttu-id="9cdae-270">n/v</span><span class="sxs-lookup"><span data-stu-id="9cdae-270">n/a</span></span>|<span data-ttu-id="9cdae-271">Identifikation</span><span class="sxs-lookup"><span data-stu-id="9cdae-271">Identification</span></span>|  
  
## <a name="mapping-a-client-certificate-to-a-windows-account"></a><span data-ttu-id="9cdae-272">Zuordnen eines Clientzertifikats zu einem Windows-Konto</span><span class="sxs-lookup"><span data-stu-id="9cdae-272">Mapping a Client Certificate to a Windows Account</span></span>  
 <span data-ttu-id="9cdae-273">Ein Client kann sich gegenüber einem Dienst mithilfe eines Zertifikats ausweisen; der Dienst kann angewiesen werden, den Client mittels Active Directory einem vorhandenen Konto zuzuordnen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-273">It is possible for a client to authenticate itself to a service using a certificate, and to have the service map the client to an existing account through Active Directory.</span></span> <span data-ttu-id="9cdae-274">Im folgenden XML wird gezeigt, wie der Dienst so konfiguriert wird, dass er das Zertifikat zuordnet:</span><span class="sxs-lookup"><span data-stu-id="9cdae-274">The following XML shows how to configure the service to map the certificate.</span></span>  
  
```xml  
<behaviors>  
  <serviceBehaviors>  
    <behavior name="MapToWindowsAccount">  
      <serviceCredentials>  
        <clientCertificate>  
          <authentication mapClientCertificateToWindowsAccount="true" />  
        </clientCertificate>  
      </serviceCredentials>  
    </behavior>  
  </serviceBehaviors>  
</behaviors>  
```  
  
 <span data-ttu-id="9cdae-275">Im folgenden Code wird gezeigt, wie der Dienst konfiguriert wird:</span><span class="sxs-lookup"><span data-stu-id="9cdae-275">The following code shows how to configure the service.</span></span>  
  
```  
// Create a binding that sets a certificate as the client credential type.  
WSHttpBinding b = new WSHttpBinding();  
b.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;  
  
// Create a service host that maps the certificate to a Windows account.  
Uri httpUri = new Uri("http://localhost/Calculator");  
ServiceHost sh = new ServiceHost(typeof(HelloService), httpUri);  
sh.Credentials.ClientCertificate.Authentication.MapClientCertificateToWindowsAccount = true;  
```  
  
## <a name="delegation"></a><span data-ttu-id="9cdae-276">Delegierung</span><span class="sxs-lookup"><span data-stu-id="9cdae-276">Delegation</span></span>  
 <span data-ttu-id="9cdae-277">Damit ein Dienst an einen Back-End-Dienst delegiert werden kann, muss er sich gegenüber dem Back-End-Dienst mittels bilateraler (SSPI ohne Rückgriff auf NTLM) oder direkter Kerberos-Authentifizierung unter Verwendung der Windows-Identität des Clients authentifizieren.</span><span class="sxs-lookup"><span data-stu-id="9cdae-277">To delegate to a back-end service, a service must perform Kerberos multi-leg (SSPI without NTLM fallback) or Kerberos direct authentication to the back-end service using the client’s Windows identity.</span></span> <span data-ttu-id="9cdae-278">Um einen Dienst an einen Back-End-Dienst zu delegieren, erstellen Sie eine <xref:System.ServiceModel.ChannelFactory%601> und einen Kanal und leiten die Kommunikation über diesen Kanal, solange die Identität des Clients angenommen wird.</span><span class="sxs-lookup"><span data-stu-id="9cdae-278">To delegate to a back-end service, create a <xref:System.ServiceModel.ChannelFactory%601> and a channel, and then communicate through the channel while impersonating the client.</span></span> <span data-ttu-id="9cdae-279">Bei dieser Form der Delegierung hängt die maximale Entfernung zwischen Back-End-Dienst und Front-End-Dienst von der Identitätswechselebene des Front-End-Diensts ab.</span><span class="sxs-lookup"><span data-stu-id="9cdae-279">With this form of delegation, the distance at which the back-end service can be located from the front-end service depends on the impersonation level achieved by the front-end service.</span></span> <span data-ttu-id="9cdae-280">Wenn die Identitätswechselebene <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>festgelegt wird, müssen Front-End- und Back-End-Dienst auf dem gleichen Computer ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="9cdae-280">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, the front-end and back-end services must be running on the same machine.</span></span> <span data-ttu-id="9cdae-281">Wenn die Identitätswechselebene <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>verwendet wird, können Front-End- und Back-End-Dienst auf unterschiedlichen Computern oder dem gleichen Computer ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="9cdae-281">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, the front-end and back-end services can be on separate machines or on the same machine.</span></span> <span data-ttu-id="9cdae-282">Ein Identitätswechsel auf Delegierungsebene erfordert, dass die Windows-Domänenrichtlinie entsprechend konfiguriert wurde, um eine Delegierung zuzulassen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-282">Enabling delegation-level impersonation requires that Windows domain policy be configured to permit delegation.</span></span> <span data-ttu-id="9cdae-283">Weitere Informationen zum Konfigurieren von Active Directory für die Delegierung finden Sie unter [Enabling Delegated Authentication](https://go.microsoft.com/fwlink/?LinkId=99690).</span><span class="sxs-lookup"><span data-stu-id="9cdae-283">For more information about configuring Active Directory for delegation support, see [Enabling Delegated Authentication](https://go.microsoft.com/fwlink/?LinkId=99690).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="9cdae-284">Wenn sich der Client dem Front-End-Dienst gegenüber mit einem Benutzernamen und einem Kennwort authentifiziert, die einem Windows-Konto für den Back-End-Dienst entsprechen, dann kann sich der Front-End-Dienst durch erneute Angabe des Benutzernamens und des Kennworts des Clients dem Back-End-Dienst gegenüber authentifizieren.</span><span class="sxs-lookup"><span data-stu-id="9cdae-284">When a client authenticates to the front-end service using a user name and password that correspond to a Windows account on the back-end service, the front-end service can authenticate to the back-end service by reusing the client’s user name and password.</span></span> <span data-ttu-id="9cdae-285">Dies ist eine besonders mächtige Form der Identitätsübergabe, weil die Weitergabe von Benutzernamen und Kennwort an den Back-End-Dienst diesen in die Lage versetzt, einen Identitätswechsel durchzuführen. Weil Kerberos nicht verwendet wird, stellt dieser Vorgang jedoch keine Delegierung dar.</span><span class="sxs-lookup"><span data-stu-id="9cdae-285">This is a particularly powerful form of identity flow, because passing user name and password to the back-end service enables the back-end service to perform impersonation, but it does not constitute delegation because Kerberos is not used.</span></span> <span data-ttu-id="9cdae-286">Die Delegierung betreffende Active Directory-Steuerelemente gelten nicht für die Authentifizierung durch Benutzername und Kennwort.</span><span class="sxs-lookup"><span data-stu-id="9cdae-286">Active Directory controls on delegation do not apply to user name and password authentication.</span></span>  
  
### <a name="delegation-ability-as-a-function-of-impersonation-level"></a><span data-ttu-id="9cdae-287">Delegierungsfähigkeit als Funktion der Identitätswechselebene</span><span class="sxs-lookup"><span data-stu-id="9cdae-287">Delegation Ability as a Function of Impersonation Level</span></span>  
  
|<span data-ttu-id="9cdae-288">Ebene des Identitätswechsels</span><span class="sxs-lookup"><span data-stu-id="9cdae-288">Impersonation level</span></span>|<span data-ttu-id="9cdae-289">Dienst kann eine prozessübergreifende Delegierung ausführen</span><span class="sxs-lookup"><span data-stu-id="9cdae-289">Service can perform cross-process delegation</span></span>|<span data-ttu-id="9cdae-290">Dienst kann eine computerübergreifende Delegierung ausführen</span><span class="sxs-lookup"><span data-stu-id="9cdae-290">Service can perform cross-machine delegation</span></span>|  
|-------------------------|---------------------------------------------------|---------------------------------------------------|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Identification>|<span data-ttu-id="9cdae-291">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-291">No</span></span>|<span data-ttu-id="9cdae-292">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-292">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>|<span data-ttu-id="9cdae-293">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-293">Yes</span></span>|<span data-ttu-id="9cdae-294">Nein</span><span class="sxs-lookup"><span data-stu-id="9cdae-294">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Delegation>|<span data-ttu-id="9cdae-295">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-295">Yes</span></span>|<span data-ttu-id="9cdae-296">Ja</span><span class="sxs-lookup"><span data-stu-id="9cdae-296">Yes</span></span>|  
  
 <span data-ttu-id="9cdae-297">Im folgenden Codebeispiel wird die Verwendung der Delegierung veranschaulicht.</span><span class="sxs-lookup"><span data-stu-id="9cdae-297">The following code example demonstrates how to use delegation.</span></span>  
  
 [!code-csharp[c_delegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_delegation/cs/source.cs#1)]
 [!code-vb[c_delegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_delegation/vb/source.vb#1)]  
  
### <a name="how-to-configure-an-application-to-use-constrained-delegation"></a><span data-ttu-id="9cdae-298">Konfigurieren einer Anwendung für die Verwendung der eingeschränkten Delegierung</span><span class="sxs-lookup"><span data-stu-id="9cdae-298">How to Configure an Application to Use Constrained Delegation</span></span>  
 <span data-ttu-id="9cdae-299">Die eingeschränkte Delegierung kann erst verwendet werden, nachdem Absender, Empfänger und Domänencontroller entsprechend konfiguriert wurden.</span><span class="sxs-lookup"><span data-stu-id="9cdae-299">Before you can use constrained delegation, the sender, receiver, and the domain controller must be configured to do so.</span></span> <span data-ttu-id="9cdae-300">Die folgende Prozedur listet die Schritte auf, die eine eingeschränkte Delegierung ermöglichen.</span><span class="sxs-lookup"><span data-stu-id="9cdae-300">The following procedure lists the steps that enable constrained delegation.</span></span> <span data-ttu-id="9cdae-301">Nähere Angaben zu den Unterschieden zwischen Delegierung und eingeschränkter Delegierung finden Sie in dem Abschnitt unter [Windows Server 2003 Kerberos Extensions](https://go.microsoft.com/fwlink/?LinkId=100194) , der sich mit eingeschränkter Delegierung befasst (Seite möglicherweise auf Englisch).</span><span class="sxs-lookup"><span data-stu-id="9cdae-301">For details about the differences between delegation and constrained delegation, see the portion of [Windows Server 2003 Kerberos Extensions](https://go.microsoft.com/fwlink/?LinkId=100194) that discusses constrained discussion.</span></span>  
  
1. <span data-ttu-id="9cdae-302">Deaktivieren Sie auf dem Domänencontroller das Kontrollkästchen **Konto ist vertraulich und kann nicht delegiert werden** für das Konto, unter dem die Clientanwendung ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="9cdae-302">On the domain controller, clear the **Account is sensitive and cannot be delegated** check box for the account under which the client application is running.</span></span>  
  
2. <span data-ttu-id="9cdae-303">Aktivieren Sie auf dem Domänencontroller das Kontrollkästchen **Konto wird für Delegierungszwecke vertraut** für das Konto, unter dem die Clientanwendung ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="9cdae-303">On the domain controller, select the **Account is trusted for delegation** check box for the account under which the client application is running.</span></span>  
  
3. <span data-ttu-id="9cdae-304">Konfigurieren Sie auf dem Domänencontroller den Computer der mittleren Schicht, sodass diesem für Delegierungszwecke vertraut wird, indem Sie auf die Option **Computer für Delegierungszwecke vertrauen** klicken.</span><span class="sxs-lookup"><span data-stu-id="9cdae-304">On the domain controller, configure the middle tier computer so that it is trusted for delegation, by clicking the **Trust computer for delegation** option.</span></span>  
  
4. <span data-ttu-id="9cdae-305">Konfigurieren Sie auf dem Domänencontroller den Computer der mittleren Schicht für die Verwendung der eingeschränkten Delegierung, indem Sie auf die Option **Computer nur für Delegierungszwecke angegebener Dienste vertrauen** klicken.</span><span class="sxs-lookup"><span data-stu-id="9cdae-305">On the domain controller, configure the middle tier computer to use constrained delegation, by clicking the **Trust this computer for delegation to specified services only** option.</span></span>  
  
 <span data-ttu-id="9cdae-306">Ausführlichere Anweisungen zum Konfigurieren der eingeschränkten Delegierung finden Sie in den folgenden MSDN-Themen:</span><span class="sxs-lookup"><span data-stu-id="9cdae-306">For more detailed instructions about configuring constrained delegation, see the following topics on MSDN:</span></span>  
  
- [<span data-ttu-id="9cdae-307">Problembehandlung der Kerberos-Delegierung (Seite möglicherweise auf Englisch)</span><span class="sxs-lookup"><span data-stu-id="9cdae-307">Troubleshooting Kerberos Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36724)  
  
- [<span data-ttu-id="9cdae-308">Kerberos-Protokollübergang und eingeschränkte Delegierung</span><span class="sxs-lookup"><span data-stu-id="9cdae-308">Kerberos Protocol Transition and Constrained Delegation</span></span>](https://go.microsoft.com/fwlink/?LinkId=36725)  
  
## <a name="see-also"></a><span data-ttu-id="9cdae-309">Siehe auch</span><span class="sxs-lookup"><span data-stu-id="9cdae-309">See also</span></span>

- <xref:System.ServiceModel.OperationBehaviorAttribute>
- <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A>
- <xref:System.ServiceModel.ImpersonationOption>
- <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A>
- <xref:System.ServiceModel.ServiceSecurityContext>
- <xref:System.Security.Principal.WindowsIdentity>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A>
- <xref:System.ServiceModel.ServiceHost>
- <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ChannelFactory%601>
- <xref:System.Security.Principal.TokenImpersonationLevel.Identification>
- [<span data-ttu-id="9cdae-310">Verwenden von Identitätswechsel mit Transportsicherheit</span><span class="sxs-lookup"><span data-stu-id="9cdae-310">Using Impersonation with Transport Security</span></span>](../../../../docs/framework/wcf/feature-details/using-impersonation-with-transport-security.md)
- [<span data-ttu-id="9cdae-311">Durchführen eines Identitätswechsels für den Client</span><span class="sxs-lookup"><span data-stu-id="9cdae-311">Impersonating the Client</span></span>](../../../../docs/framework/wcf/samples/impersonating-the-client.md)
- [<span data-ttu-id="9cdae-312">Vorgehensweise: Annehmen der Clientidentität für einen Dienst</span><span class="sxs-lookup"><span data-stu-id="9cdae-312">How to: Impersonate a Client on a Service</span></span>](../../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)
- [<span data-ttu-id="9cdae-313">ServiceModel Metadata Utility-Tool (Svcutil.exe)</span><span class="sxs-lookup"><span data-stu-id="9cdae-313">ServiceModel Metadata Utility Tool (Svcutil.exe)</span></span>](../../../../docs/framework/wcf/servicemodel-metadata-utility-tool-svcutil-exe.md)
