---
title: Transaktionen und Massenkopiervorgänge
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: fb27e11f81451d6a982edcf5b88b23861bef3c37
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 08/22/2019
ms.locfileid: "69938428"
---
# <a name="transaction-and-bulk-copy-operations"></a><span data-ttu-id="5de3c-102">Transaktionen und Massenkopiervorgänge</span><span class="sxs-lookup"><span data-stu-id="5de3c-102">Transaction and Bulk Copy Operations</span></span>
<span data-ttu-id="5de3c-103">Massenkopiervorgänge können als isolierte Vorgänge oder als Teil einer mehrstufigen Transaktion ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="5de3c-103">Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.</span></span> <span data-ttu-id="5de3c-104">Die Ausführung als Teil einer mehrstufigen Transaktion ermöglicht es Ihnen, innerhalb ein und derselben Transaktion mehr als einen Massenkopiervorgang sowie andere Datenbankoperationen (z. B. Einfüge-, Update- und Löschvorgänge) auszuführen, ohne dabei auf die Möglichkeit verzichten zu müssen, einen Commit oder einen Rollback für die gesamte Transaktion durchführen zu können.</span><span class="sxs-lookup"><span data-stu-id="5de3c-104">This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.</span></span>  
  
 <span data-ttu-id="5de3c-105">Massenkopiervorgänge werden standardmäßig als isolierte Vorgänge ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="5de3c-105">By default, a bulk copy operation is performed as an isolated operation.</span></span> <span data-ttu-id="5de3c-106">Der Massenkopiervorgang erfolgt auf eine nicht transaktive Art und Weise und bietet keine Möglichkeit für einen Rollback.</span><span class="sxs-lookup"><span data-stu-id="5de3c-106">The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.</span></span> <span data-ttu-id="5de3c-107">Wenn Sie bei einem Fehler den gesamten Massen Kopiervorgang oder einen Teil davon zurücksetzen müssen, können Sie eine <xref:System.Data.SqlClient.SqlBulkCopy>von verwaltete Transaktion verwenden, den Massen Kopiervorgang innerhalb einer vorhandenen Transaktion ausführen oder in eine **System. Transactions**<xref:System.Transactions.Transaction>-Rolle eingetragen werden.</span><span class="sxs-lookup"><span data-stu-id="5de3c-107">If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.</span></span>  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a><span data-ttu-id="5de3c-108">Ausführen eines nicht transaktiven Massenkopiervorgangs</span><span class="sxs-lookup"><span data-stu-id="5de3c-108">Performing a Non-transacted Bulk Copy Operation</span></span>  
 <span data-ttu-id="5de3c-109">Die folgende Konsolenanwendung zeigt, was passiert, wenn während eines nicht transaktiven Massenkopiervorgangs ein Fehler auftritt.</span><span class="sxs-lookup"><span data-stu-id="5de3c-109">The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.</span></span>  
  
 <span data-ttu-id="5de3c-110">In diesem Beispiel enthalten die Quell Tabelle und die Ziel Tabelle jeweils eine `Identity` Spalte mit dem Namen **ProductID**.</span><span class="sxs-lookup"><span data-stu-id="5de3c-110">In the example, the source table and destination table each include an `Identity` column named **ProductID**.</span></span> <span data-ttu-id="5de3c-111">Der Code bereitet zuerst die Ziel Tabelle vor, indem alle Zeilen gelöscht und anschließend eine einzelne Zeile eingefügt wird, deren **ProductID** bekanntermaßen in der Quell Tabelle vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="5de3c-111">The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table.</span></span> <span data-ttu-id="5de3c-112">In der Standardeinstellung wird für jede hinzugefügte Zeile ein neuer Wert für die `Identity`-Spalte in der Zieltabelle generiert.</span><span class="sxs-lookup"><span data-stu-id="5de3c-112">By default, a new value for the `Identity` column is generated in the destination table for each row added.</span></span> <span data-ttu-id="5de3c-113">In diesem Beispiel wird beim Öffnen der Verbindung eine Option festgelegt, durch die beim Massenladevorgang stattdessen die `Identity`-Werte aus der Quelltabelle verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="5de3c-113">In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.</span></span>  
  
 <span data-ttu-id="5de3c-114">Der Massenkopiervorgang wird mit der Einstellung "10" für die <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A>-Eigenschaft ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="5de3c-114">The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10.</span></span> <span data-ttu-id="5de3c-115">Wenn der Vorgang auf die ungültige Zeile stößt, wird eine Ausnahme ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="5de3c-115">When the operation encounters the invalid row, an exception is thrown.</span></span> <span data-ttu-id="5de3c-116">In diesem ersten Beispiel ist der Massenkopiervorgang nicht Teil einer Transaktion.</span><span class="sxs-lookup"><span data-stu-id="5de3c-116">In this first example, the bulk copy operation is non-transacted.</span></span> <span data-ttu-id="5de3c-117">Für alle bis zum Zeitpunkt des Fehlers kopierten Batches wird ein Commit ausgeführt. Für den Batch mit dem doppelten Schlüssel wird ein Rollback ausgeführt, und der Massenkopiervorgang wird vor der Verarbeitung weiterer Batches angehalten.</span><span class="sxs-lookup"><span data-stu-id="5de3c-117">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="5de3c-118">Dieses Beispiel wird nur dann ausgeführt, wenn Sie die Arbeits Tabellen erstellt haben, wie unter [Beispiel für Massen Kopier](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)Vorgänge beschrieben.</span><span class="sxs-lookup"><span data-stu-id="5de3c-118">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="5de3c-119">Dieser Code wird bereitgestellt, um die Syntax nur für die Verwendung von **SqlBulkCopy** zu veranschaulichen.</span><span class="sxs-lookup"><span data-stu-id="5de3c-119">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="5de3c-120">Wenn sich die Quell-und Ziel Tabelle in derselben SQL Server Instanz befinden, ist es einfacher und schneller, eine Transact-SQL`INSERT … SELECT` -Anweisung zu verwenden, um die Daten zu kopieren.</span><span class="sxs-lookup"><span data-stu-id="5de3c-120">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a><span data-ttu-id="5de3c-121">Ausführen eines dedizierten Massenkopiervorgangs in einer Transaktion</span><span class="sxs-lookup"><span data-stu-id="5de3c-121">Performing a Dedicated Bulk Copy Operation in a Transaction</span></span>  
 <span data-ttu-id="5de3c-122">Standardmäßig ist ein Massenkopiervorgang seine eigene Transaktion.</span><span class="sxs-lookup"><span data-stu-id="5de3c-122">By default, a bulk copy operation is its own transaction.</span></span> <span data-ttu-id="5de3c-123">Wenn Sie einen dedizierten Massenkopiervorgang ausführen möchten, erstellen Sie eine neue Instanz von <xref:System.Data.SqlClient.SqlBulkCopy> mit einer Verbindungszeichenfolge, oder Sie verwenden ein vorhandenes <xref:System.Data.SqlClient.SqlConnection>-Objekt ohne aktive Transaktion.</span><span class="sxs-lookup"><span data-stu-id="5de3c-123">When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction.</span></span> <span data-ttu-id="5de3c-124">In allen Szenarien erstellt der Massenkopiervorgang die Transaktion und führt dann einen Commit oder einen Rollback aus.</span><span class="sxs-lookup"><span data-stu-id="5de3c-124">In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.</span></span>  
  
 <span data-ttu-id="5de3c-125">Sie können die <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction>-Option im <xref:System.Data.SqlClient.SqlBulkCopy>-Klassenkonstruktor explizit angeben und so einen Massenkopiervorgang explizit dazu zwingen, seine eigene Transaktion auszuführen, wodurch jeder Batch des Massenkopiervorgangs innerhalb einer separaten Transaktion ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="5de3c-125">You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="5de3c-126">Da verschiedene Batches in unterschiedlichen Transaktionen ausgeführt werden, wird für alle Zeilen im aktuellen Batch ein Rollback ausgeführt, wenn beim Ausführen des Massenkopiervorgangs ein Fehler auftritt. Zeilen aus früheren Batches verbleiben jedoch in der Datenbank.</span><span class="sxs-lookup"><span data-stu-id="5de3c-126">Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.</span></span>  
  
 <span data-ttu-id="5de3c-127">Die folgende Konsolenanwendung ähnelt mit einer Ausnahme dem vorherigen Beispiel: In diesem Beispiel verwaltet der Massenkopiervorgang eine eigene Transaktion.</span><span class="sxs-lookup"><span data-stu-id="5de3c-127">The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.</span></span> <span data-ttu-id="5de3c-128">Für alle bis zum Zeitpunkt des Fehlers kopierten Batches wird ein Commit ausgeführt. Für den Batch mit dem doppelten Schlüssel wird ein Rollback ausgeführt, und der Massenkopiervorgang wird vor der Verarbeitung weiterer Batches angehalten.</span><span class="sxs-lookup"><span data-stu-id="5de3c-128">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="5de3c-129">Dieses Beispiel wird nur dann ausgeführt, wenn Sie die Arbeits Tabellen erstellt haben, wie unter [Beispiel für Massen Kopier](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)Vorgänge beschrieben.</span><span class="sxs-lookup"><span data-stu-id="5de3c-129">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="5de3c-130">Dieser Code wird bereitgestellt, um die Syntax nur für die Verwendung von **SqlBulkCopy** zu veranschaulichen.</span><span class="sxs-lookup"><span data-stu-id="5de3c-130">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="5de3c-131">Wenn sich die Quell-und Ziel Tabelle in derselben SQL Server Instanz befinden, ist es einfacher und schneller, eine Transact-SQL`INSERT … SELECT` -Anweisung zu verwenden, um die Daten zu kopieren.</span><span class="sxs-lookup"><span data-stu-id="5de3c-131">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a><span data-ttu-id="5de3c-132">Verwenden vorhandener Transaktionen</span><span class="sxs-lookup"><span data-stu-id="5de3c-132">Using Existing Transactions</span></span>  
 <span data-ttu-id="5de3c-133">Sie können ein vorhandenes <xref:System.Data.SqlClient.SqlTransaction>-Objekt als Parameter in einem <xref:System.Data.SqlClient.SqlBulkCopy>-Konstruktor angeben.</span><span class="sxs-lookup"><span data-stu-id="5de3c-133">You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span> <span data-ttu-id="5de3c-134">In dieser Situation wird der Massenkopiervorgang in einer vorhandenen Transaktion ausgeführt. Der Transaktionszustand bleibt unverändert (d. h., es erfolgt weder ein Commit noch ein Abbruch).</span><span class="sxs-lookup"><span data-stu-id="5de3c-134">In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).</span></span> <span data-ttu-id="5de3c-135">Daher ist es möglich, dass in einer Anwendung der Massenkopiervorgang in einer Transaktion zusammen mit anderen Datenbankoperationen ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="5de3c-135">This allows an application to include the bulk copy operation in a transaction with other database operations.</span></span> <span data-ttu-id="5de3c-136">Wenn Sie jedoch kein <xref:System.Data.SqlClient.SqlTransaction>-Objekt angeben und einen NULL-Verweis übergeben und die Verbindung außerdem eine aktive Transaktion aufweist, wird eine Ausnahme ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="5de3c-136">However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.</span></span>  
  
 <span data-ttu-id="5de3c-137">Wenn Sie einen Rollback für den gesamten Massenkopiervorgang ausführen müssen, weil ein Fehler aufgetreten ist, oder wenn der Massenkopiervorgang als Teil eines größeren Prozesses ausgeführt werden soll, für den ein Rollback ausgeführt werden kann, können Sie dem <xref:System.Data.SqlClient.SqlTransaction>-Konstruktor ein <xref:System.Data.SqlClient.SqlBulkCopy>-Objekt bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="5de3c-137">If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span>  
  
 <span data-ttu-id="5de3c-138">Die folgende Konsolenanwendung ähnelt der im vorherigen Beispiel, jedoch mit einem Unterschied: In diesem Beispiel ist der Massenkopiervorgang Teil einer größeren, externen Transaktion.</span><span class="sxs-lookup"><span data-stu-id="5de3c-138">The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.</span></span> <span data-ttu-id="5de3c-139">Wenn der Fehler für einen Primärschlüsselkonflikt auftritt, wird ein Rollback für die gesamte Transaktion ausgeführt. In diesem Fall werden der Zieltabelle keine Zeilen hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="5de3c-139">When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="5de3c-140">Dieses Beispiel wird nur dann ausgeführt, wenn Sie die Arbeits Tabellen erstellt haben, wie unter [Beispiel für Massen Kopier](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md)Vorgänge beschrieben.</span><span class="sxs-lookup"><span data-stu-id="5de3c-140">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](../../../../../docs/framework/data/adonet/sql/bulk-copy-example-setup.md).</span></span> <span data-ttu-id="5de3c-141">Dieser Code wird bereitgestellt, um die Syntax nur für die Verwendung von **SqlBulkCopy** zu veranschaulichen.</span><span class="sxs-lookup"><span data-stu-id="5de3c-141">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="5de3c-142">Wenn sich die Quell-und Ziel Tabelle in derselben SQL Server Instanz befinden, ist es einfacher und schneller, eine Transact-SQL`INSERT … SELECT` -Anweisung zu verwenden, um die Daten zu kopieren.</span><span class="sxs-lookup"><span data-stu-id="5de3c-142">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a><span data-ttu-id="5de3c-143">Siehe auch</span><span class="sxs-lookup"><span data-stu-id="5de3c-143">See also</span></span>

- [<span data-ttu-id="5de3c-144">Massenkopiervorgänge in SQL Server</span><span class="sxs-lookup"><span data-stu-id="5de3c-144">Bulk Copy Operations in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/bulk-copy-operations-in-sql-server.md)
- [<span data-ttu-id="5de3c-145">ADO.NET Managed Provider und DataSet Developer Center</span><span class="sxs-lookup"><span data-stu-id="5de3c-145">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
