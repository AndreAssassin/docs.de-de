---
title: Signieren von gespeicherten Prozeduren in SQL Server
ms.date: 01/05/2018
ms.assetid: eeed752c-0084-48e5-9dca-381353007a0d
ms.openlocfilehash: 0131655d06a6ef543ea460d04739401538cac04b
ms.sourcegitcommit: 700ea803fb06c5ce98de017c7f76463ba33ff4a9
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 02/19/2020
ms.locfileid: "77452356"
---
# <a name="signing-stored-procedures-in-sql-server"></a><span data-ttu-id="18303-102">Signieren von gespeicherten Prozeduren in SQL Server</span><span class="sxs-lookup"><span data-stu-id="18303-102">Signing Stored Procedures in SQL Server</span></span>

<span data-ttu-id="18303-103">Bei einer digitalen Signatur handelt es sich um einen Datendigest, der mit dem privaten Schlüssel des Signaturgebers verschlüsselt wurde.</span><span class="sxs-lookup"><span data-stu-id="18303-103">A digital signature is a data digest encrypted with the private key of the signer.</span></span> <span data-ttu-id="18303-104">Durch den privaten Schlüssel ist sichergestellt, dass die digitale Signatur eindeutig vom Träger oder Besitzer der Signatur stammt.</span><span class="sxs-lookup"><span data-stu-id="18303-104">The private key ensures that the digital signature is unique to its bearer or owner.</span></span> <span data-ttu-id="18303-105">Sie können gespeicherte Prozeduren, Funktionen (mit Ausnahme von Inline-Tabellenwert Funktionen), Trigger und Assemblys signieren.</span><span class="sxs-lookup"><span data-stu-id="18303-105">You can sign stored procedures, functions (except for inline table-valued functions), triggers, and assemblies.</span></span>

<span data-ttu-id="18303-106">Sie können gespeicherte Prozeduren mit einem Zertifikat oder einem asymmetrischen Schlüssel signieren.</span><span class="sxs-lookup"><span data-stu-id="18303-106">You can sign a stored procedure with a certificate or an asymmetric key.</span></span> <span data-ttu-id="18303-107">Gedacht ist dies für Szenarien, in denen Berechtigungen nicht über die Besitzverkettung geerbt werden können oder in denen die Besitzkette unterbrochen ist, wie bei dynamischem SQL.</span><span class="sxs-lookup"><span data-stu-id="18303-107">This is designed for scenarios when permissions cannot be inherited through ownership chaining or when the ownership chain is broken, such as dynamic SQL.</span></span> <span data-ttu-id="18303-108">Anschließend können Sie einen Benutzer erstellen, der dem Zertifikat zugeordnet ist, und dem Zertifikat Benutzerberechtigungen für die Objekte erteilen, auf die die gespeicherte Prozedur zugreifen muss.</span><span class="sxs-lookup"><span data-stu-id="18303-108">You can then create a user mapped to the certificate, granting the certificate user permissions on the objects the stored procedure needs to access.</span></span>

<span data-ttu-id="18303-109">Sie können auch einen Anmelde Namen erstellen, der demselben Zertifikat zugeordnet ist, und dann allen erforderlichen Berechtigungen auf Serverebene für diesen Anmelde Namen erteilen oder den Anmelde Namen einer oder mehreren der Server Rollen hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="18303-109">You can also create a login mapped to the same certificate, and then grant any necessary server-level permissions to that login, or add the login to one or more of the fixed server roles.</span></span> <span data-ttu-id="18303-110">Dadurch wird vermieden, dass die `TRUSTWORTHY`-Datenbankeinstellung für Szenarios aktiviert werden soll, in denen Berechtigungen höherer Ebene erforderlich sind.</span><span class="sxs-lookup"><span data-stu-id="18303-110">This is designed to avoid enabling the `TRUSTWORTHY` database setting for scenarios in which higher level permissions are needed.</span></span>

<span data-ttu-id="18303-111">Beim Ausführen der gespeicherten Prozedur werden SQL Server die Berechtigungen des Zertifikats Benutzers und/oder die Anmeldung mit den Berechtigungen des Aufrufers kombiniert.</span><span class="sxs-lookup"><span data-stu-id="18303-111">When the stored procedure is executed, SQL Server combines the permissions of the certificate user and/or login with those of the caller.</span></span> <span data-ttu-id="18303-112">Anders als bei der `EXECUTE AS`-Klausel wird der Ausführungs Kontext der Prozedur nicht geändert.</span><span class="sxs-lookup"><span data-stu-id="18303-112">Unlike the `EXECUTE AS` clause, it does not change the execution context of the procedure.</span></span> <span data-ttu-id="18303-113">Integrierte Funktionen, die Anmelde- und Benutzernamen zurückgeben, geben den Namen des Aufrufers, und nicht den Namen des Zertifikatsbenutzers zurück.</span><span class="sxs-lookup"><span data-stu-id="18303-113">Built-in functions that return login and user names return the name of the caller, not the certificate user name.</span></span>

## <a name="creating-certificates"></a><span data-ttu-id="18303-114">Erstellen von Zertifikaten</span><span class="sxs-lookup"><span data-stu-id="18303-114">Creating Certificates</span></span>

<span data-ttu-id="18303-115">Wenn Sie eine gespeicherte Prozedur mit einem Zertifikat oder einem asymmetrischen Schlüssel signieren, wird ein Daten Digest, der aus dem verschlüsselten Hash des Codes der gespeicherten Prozedur zusammen mit dem EXECUTE-AS-Benutzer besteht, mithilfe des privaten Schlüssels erstellt.</span><span class="sxs-lookup"><span data-stu-id="18303-115">When you sign a stored procedure with a certificate or asymmetric key, a data digest consisting of the encrypted hash of the stored procedure code, along with the execute-as user, is created using the private key.</span></span> <span data-ttu-id="18303-116">Zur Laufzeit wird der Datenhashwert mit dem öffentlichen Schlüssel entschlüsselt und mit dem Hashwert der gespeicherten Prozedur verglichen.</span><span class="sxs-lookup"><span data-stu-id="18303-116">At run time, the data digest is decrypted with the public key and compared with the hash value of the stored procedure.</span></span> <span data-ttu-id="18303-117">Wenn Sie den EXECUTE-AS-Benutzer ändern, wird der Hashwert ungültig, damit die digitale Signatur nicht mehr übereinstimmt.</span><span class="sxs-lookup"><span data-stu-id="18303-117">Changing the execute-as user invalidates the hash value so that the digital signature no longer matches.</span></span> <span data-ttu-id="18303-118">Wenn Sie die gespeicherte Prozedur ändern, wird die Signatur vollständig gelöscht, wodurch verhindert wird, dass jemand, der keinen Zugriff auf den privaten Schlüssel hat, den Code der gespeicherten Prozedur ändert.</span><span class="sxs-lookup"><span data-stu-id="18303-118">Modifying the stored procedure drops the signature entirely, which prevents someone who does not have access to the private key from changing the stored procedure code.</span></span> <span data-ttu-id="18303-119">In beiden Fällen müssen Sie die Prozedur jedes Mal neu signieren, wenn Sie den Code oder den EXECUTE-AS-Benutzer ändern.</span><span class="sxs-lookup"><span data-stu-id="18303-119">In either case, you must re-sign the procedure each time you change the code or the execute-as user.</span></span>

<span data-ttu-id="18303-120">Zum Signieren eines Moduls müssen zwei Schritte ausgeführt werden:</span><span class="sxs-lookup"><span data-stu-id="18303-120">There are two required steps involved in signing a module:</span></span>

1. <span data-ttu-id="18303-121">Erstellen Sie mit der Transact-SQL-`CREATE CERTIFICATE [certificateName]`-Anweisung ein Zertifikat.</span><span class="sxs-lookup"><span data-stu-id="18303-121">Create a certificate using the Transact-SQL `CREATE CERTIFICATE [certificateName]` statement.</span></span> <span data-ttu-id="18303-122">Diese Anweisung verfügt über mehrere Optionen, mit denen das Start- und Enddatum und ein Kennwort festgelegt werden können.</span><span class="sxs-lookup"><span data-stu-id="18303-122">This statement has several options for setting a start and end date and a password.</span></span> <span data-ttu-id="18303-123">Das Standard Ablaufdatum beträgt ein Jahr.</span><span class="sxs-lookup"><span data-stu-id="18303-123">The default expiration date is one year.</span></span>

1. <span data-ttu-id="18303-124">Signieren Sie die Prozedur mit dem Zertifikat. Verwenden Sie dazu die Transact-SQL-`ADD SIGNATURE TO [procedureName] BY CERTIFICATE [certificateName]`-Anweisung.</span><span class="sxs-lookup"><span data-stu-id="18303-124">Sign the procedure with the certificate using the Transact-SQL `ADD SIGNATURE TO [procedureName] BY CERTIFICATE [certificateName]` statement.</span></span>

<span data-ttu-id="18303-125">Nachdem das Modul signiert wurde, muss mindestens ein Prinzipal erstellt werden, um die zusätzlichen Berechtigungen zu speichern, die dem Zertifikat zugeordnet werden sollen.</span><span class="sxs-lookup"><span data-stu-id="18303-125">Once the module has been signed, one or more principals needs to be created in order to hold the additional permissions that should be associated with the certificate.</span></span>

<span data-ttu-id="18303-126">Wenn das Modul zusätzliche Berechtigungen auf Datenbankebene benötigt:</span><span class="sxs-lookup"><span data-stu-id="18303-126">If the module needs additional database-level permissions:</span></span>

1. <span data-ttu-id="18303-127">Erstellen Sie mit der Transact-SQL-`CREATE USER [userName] FROM CERTIFICATE [certificateName]`-Anweisung einen mit diesem Zertifikat verknüpften Datenbankbenutzer.</span><span class="sxs-lookup"><span data-stu-id="18303-127">Create a database user associated with that certificate using the Transact-SQL `CREATE USER [userName] FROM CERTIFICATE [certificateName]` statement.</span></span> <span data-ttu-id="18303-128">Dieser Benutzer ist nur in der-Datenbank vorhanden und ist nicht mit einem-Anmelde Namen verknüpft, es sei denn, es wurde auch ein Anmelde Name aus demselben Zertifikat erstellt.</span><span class="sxs-lookup"><span data-stu-id="18303-128">This user exists in the database only and is not associated with a login unless a login has also been created from that same certificate.</span></span>

1. <span data-ttu-id="18303-129">Erteilen Sie dem Zertifikat Benutzer die erforderlichen Berechtigungen auf Datenbankebene.</span><span class="sxs-lookup"><span data-stu-id="18303-129">Grant the certificate user the required database-level permissions.</span></span>

<span data-ttu-id="18303-130">Wenn das Modul zusätzliche Berechtigungen auf Serverebene benötigt:</span><span class="sxs-lookup"><span data-stu-id="18303-130">If the module needs additional server-level permissions:</span></span>

1. <span data-ttu-id="18303-131">Kopieren Sie das Zertifikat in die `master` Datenbank.</span><span class="sxs-lookup"><span data-stu-id="18303-131">Copy the certificate to the `master` database.</span></span>

1. <span data-ttu-id="18303-132">Erstellen Sie mit der Transact-SQL-`CREATE LOGIN [userName] FROM CERTIFICATE [certificateName]`-Anweisung einen diesem Zertifikat zugeordneten Anmelde Namen.</span><span class="sxs-lookup"><span data-stu-id="18303-132">Create a login associated with that certificate using the Transact-SQL `CREATE LOGIN [userName] FROM CERTIFICATE [certificateName]` statement.</span></span>

1. <span data-ttu-id="18303-133">Erteilen Sie dem Zertifikat Anmelde Namen die erforderlichen Berechtigungen auf Serverebene.</span><span class="sxs-lookup"><span data-stu-id="18303-133">Grant the certificate login the required server-level permissions.</span></span>

> [!NOTE]
> <span data-ttu-id="18303-134">Ein Zertifikat kann keine Berechtigungen für Benutzer gewähren, die Berechtigungen hatten, die mit der DENY-Anweisung widerrufen wurden.</span><span class="sxs-lookup"><span data-stu-id="18303-134">A certificate cannot grant permissions to a user that has had permissions revoked using the DENY statement.</span></span> <span data-ttu-id="18303-135">DENY hat immer Vorrang gegenüber GRANT und verhindert, dass der Aufrufer Berechtigungen erben kann, die dem Zertifikatsbenutzer gewährt wurden.</span><span class="sxs-lookup"><span data-stu-id="18303-135">DENY always takes precedence over GRANT, preventing the caller from inheriting permissions granted to the certificate user.</span></span>

## <a name="external-resources"></a><span data-ttu-id="18303-136">Externe Ressourcen</span><span class="sxs-lookup"><span data-stu-id="18303-136">External Resources</span></span>

<span data-ttu-id="18303-137">Weitere Informationen finden Sie in den folgenden Ressourcen.</span><span class="sxs-lookup"><span data-stu-id="18303-137">For more information, see the following resources.</span></span>

|<span data-ttu-id="18303-138">Ressource</span><span class="sxs-lookup"><span data-stu-id="18303-138">Resource</span></span>|<span data-ttu-id="18303-139">Beschreibung</span><span class="sxs-lookup"><span data-stu-id="18303-139">Description</span></span>|
|--------------|-----------------|
|<span data-ttu-id="18303-140">[Modul Signierung](https://docs.microsoft.com/previous-versions/sql/sql-server-2008/ms345102(v=sql.100))</span><span class="sxs-lookup"><span data-stu-id="18303-140">[Module Signing](https://docs.microsoft.com/previous-versions/sql/sql-server-2008/ms345102(v=sql.100))</span></span>|<span data-ttu-id="18303-141">Beschreibt das Signieren von Modulen, das Bereitstellen eines Beispiel Szenarios und Links zu den relevanten Transact-SQL-Artikeln.</span><span class="sxs-lookup"><span data-stu-id="18303-141">Describes module signing, providing a sample scenario and links to the relevant Transact-SQL articles.</span></span>|
|[<span data-ttu-id="18303-142">Signieren von gespeicherten Prozeduren mit einem Zertifikat</span><span class="sxs-lookup"><span data-stu-id="18303-142">Signing Stored Procedures with a Certificate</span></span>](/sql/relational-databases/tutorial-signing-stored-procedures-with-a-certificate)|<span data-ttu-id="18303-143">Enthält ein Lernprogramm zum Signieren einer gespeicherten Prozedur mit einem Zertifikat.</span><span class="sxs-lookup"><span data-stu-id="18303-143">Provides a tutorial for signing a stored procedure with a certificate.</span></span>|

## <a name="see-also"></a><span data-ttu-id="18303-144">Siehe auch</span><span class="sxs-lookup"><span data-stu-id="18303-144">See also</span></span>

- [<span data-ttu-id="18303-145">Sichern von ADO.NET-Anwendungen</span><span class="sxs-lookup"><span data-stu-id="18303-145">Securing ADO.NET Applications</span></span>](../securing-ado-net-applications.md)
- [<span data-ttu-id="18303-146">Übersicht über die SQL Server-Sicherheit</span><span class="sxs-lookup"><span data-stu-id="18303-146">Overview of SQL Server Security</span></span>](overview-of-sql-server-security.md)
- [<span data-ttu-id="18303-147">Anwendungssicherheitsszenarios in SQL Server</span><span class="sxs-lookup"><span data-stu-id="18303-147">Application Security Scenarios in SQL Server</span></span>](application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="18303-148">Verwalten von Berechtigungen mit gespeicherten Prozeduren in SQL Server</span><span class="sxs-lookup"><span data-stu-id="18303-148">Managing Permissions with Stored Procedures in SQL Server</span></span>](managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="18303-149">Schreiben von sicherem dynamischem SQL in SQL Server</span><span class="sxs-lookup"><span data-stu-id="18303-149">Writing Secure Dynamic SQL in SQL Server</span></span>](writing-secure-dynamic-sql-in-sql-server.md)
- [<span data-ttu-id="18303-150">Anpassen von Berechtigungen durch Identitätswechsel in SQL Server</span><span class="sxs-lookup"><span data-stu-id="18303-150">Customizing Permissions with Impersonation in SQL Server</span></span>](customizing-permissions-with-impersonation-in-sql-server.md)
- [<span data-ttu-id="18303-151">Ändern von Daten mit gespeicherten Prozeduren</span><span class="sxs-lookup"><span data-stu-id="18303-151">Modifying Data with Stored Procedures</span></span>](../modifying-data-with-stored-procedures.md)
- [<span data-ttu-id="18303-152">Übersicht über ADO.NET</span><span class="sxs-lookup"><span data-stu-id="18303-152">ADO.NET Overview</span></span>](../ado-net-overview.md)
