---
title: Signieren von gespeicherten Prozeduren in SQL Server
ms.date: 01/05/2018
ms.assetid: eeed752c-0084-48e5-9dca-381353007a0d
ms.openlocfilehash: 2c2076294c0e06ec411ceb1f5b1238dc3d7eb304
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 04/23/2019
ms.locfileid: "61922186"
---
# <a name="signing-stored-procedures-in-sql-server"></a><span data-ttu-id="761b7-102">Signieren von gespeicherten Prozeduren in SQL Server</span><span class="sxs-lookup"><span data-stu-id="761b7-102">Signing Stored Procedures in SQL Server</span></span>
 <span data-ttu-id="761b7-103">Eine digitale Signatur ist ein mit dem privaten Schlüssel des Signaturgebers verschlüsselter Datenhashwert.</span><span class="sxs-lookup"><span data-stu-id="761b7-103">A digital signature is a data digest encrypted with the private key of the signer.</span></span> <span data-ttu-id="761b7-104">Der private Schlüssel stellt sicher, dass die digitale Signatur für den Träger oder Besitzer eindeutig ist.</span><span class="sxs-lookup"><span data-stu-id="761b7-104">The private key ensures that the digital signature is unique to its bearer or owner.</span></span> <span data-ttu-id="761b7-105">Sie können gespeicherte Prozeduren, Funktionen (mit Ausnahme von Inline-Tabellenwertfunktionen), Trigger und Assemblys registrieren.</span><span class="sxs-lookup"><span data-stu-id="761b7-105">You can sign stored procedures, functions (except for inline table-valued functions), triggers, and assemblies.</span></span>  
  
 <span data-ttu-id="761b7-106">Sie können gespeicherte Prozeduren mit einem Zertifikat oder einem asymmetrischen Schlüssel signieren.</span><span class="sxs-lookup"><span data-stu-id="761b7-106">You can sign a stored procedure with a certificate or an asymmetric key.</span></span> <span data-ttu-id="761b7-107">Gedacht ist dies für Szenarien, in denen Berechtigungen nicht über die Besitzverkettung geerbt werden können oder in denen die Besitzkette unterbrochen ist, wie bei dynamischem SQL.</span><span class="sxs-lookup"><span data-stu-id="761b7-107">This is designed for scenarios when permissions cannot be inherited through ownership chaining or when the ownership chain is broken, such as dynamic SQL.</span></span> <span data-ttu-id="761b7-108">Anschließend können Sie erstellen einen auf das Zertifikat zugeordneten Benutzer erteilen von Benutzerberechtigungen für die Objekte, die Zugriff auf die gespeicherte Prozedur muss für das Zertifikat.</span><span class="sxs-lookup"><span data-stu-id="761b7-108">You can then create a user mapped to the certificate, granting the certificate user permissions on the objects the stored procedure needs to access.</span></span>  

 <span data-ttu-id="761b7-109">Sie können auch erstellen eine Anmeldung für das gleiche Zertifikat, und klicken Sie dann alle erforderlichen Berechtigungen auf Serverebene, die dieser Anmeldung zu gewähren oder hinzufügen die Anmeldung an eine oder mehrere der festen Serverrollen.</span><span class="sxs-lookup"><span data-stu-id="761b7-109">You can also create a login mapped to the same certificate, and then grant any necessary server-level permissions to that login, or add the login to one or more of the fixed server roles.</span></span> <span data-ttu-id="761b7-110">Auf diese Weise vermeiden Sie aktivieren die `TRUSTWORTHY` Datenbank-Einstellung für Szenarien, in dem Berechtigungen auf höhere Ebene benötigt werden.</span><span class="sxs-lookup"><span data-stu-id="761b7-110">This is designed to avoid enabling the `TRUSTWORTHY` database setting for scenarios in which higher level permissions are needed.</span></span>  
  
 <span data-ttu-id="761b7-111">Wenn die gespeicherte Prozedur ausgeführt wird, kombiniert SQL Server die Berechtigungen der Zertifikatsbenutzer bzw. der Anmeldung, mit denen des Aufrufers.</span><span class="sxs-lookup"><span data-stu-id="761b7-111">When the stored procedure is executed, SQL Server combines the permissions of the certificate user and/or login with those of the caller.</span></span> <span data-ttu-id="761b7-112">Im Gegensatz zu den `EXECUTE AS` -Klausel wird nicht den Ausführungskontext der Prozedur geändert.</span><span class="sxs-lookup"><span data-stu-id="761b7-112">Unlike the `EXECUTE AS` clause, it does not change the execution context of the procedure.</span></span> <span data-ttu-id="761b7-113">Integrierte Funktionen, die Anmelde- und Benutzernamen zurückgeben, geben den Namen des Aufrufers, und nicht den Namen des Zertifikatsbenutzers zurück.</span><span class="sxs-lookup"><span data-stu-id="761b7-113">Built-in functions that return login and user names return the name of the caller, not the certificate user name.</span></span>  
  
## <a name="creating-certificates"></a><span data-ttu-id="761b7-114">Erstellen von Zertifikaten</span><span class="sxs-lookup"><span data-stu-id="761b7-114">Creating Certificates</span></span>  
 <span data-ttu-id="761b7-115">Wenn Sie eine gespeicherte Prozedur mit einem Zertifikat oder asymmetrischen Schlüssels ein datenhashwert bestehend aus dem verschlüsselten Hash Code der gespeicherten Prozedur, zusammen mit der Execute Anmelden – als Benutzer erstellt wird, mit dem privaten Schlüssel.</span><span class="sxs-lookup"><span data-stu-id="761b7-115">When you sign a stored procedure with a certificate or asymmetric key, a data digest consisting of the encrypted hash of the stored procedure code, along with the execute-as user, is created using the private key.</span></span> <span data-ttu-id="761b7-116">Zur Laufzeit wird der Datenhashwert mit dem öffentlichen Schlüssel entschlüsselt und mit dem Hashwert der gespeicherten Prozedur verglichen.</span><span class="sxs-lookup"><span data-stu-id="761b7-116">At run time, the data digest is decrypted with the public key and compared with the hash value of the stored procedure.</span></span> <span data-ttu-id="761b7-117">Ändern die Execute-wie Benutzer den Hashwert ungültig, so, dass die digitale Signatur nicht mehr übereinstimmt.</span><span class="sxs-lookup"><span data-stu-id="761b7-117">Changing the execute-as user invalidates the hash value so that the digital signature no longer matches.</span></span> <span data-ttu-id="761b7-118">Ändern die gespeicherte Prozedur löscht die Signatur vollständig, die verhindert, dass eine Person, die keinen Zugriff auf den privaten Schlüssel aus Code der gespeicherten Prozedur zu ändern.</span><span class="sxs-lookup"><span data-stu-id="761b7-118">Modifying the stored procedure drops the signature entirely, which prevents someone who does not have access to the private key from changing the stored procedure code.</span></span> <span data-ttu-id="761b7-119">In beiden Fällen Sie müssen neu signieren die Prozedur bei jeder Änderung des Codes oder die Execute-Benutzer.</span><span class="sxs-lookup"><span data-stu-id="761b7-119">In either case, you must re-sign the procedure each time you change the code or the execute-as user.</span></span>  
  
 <span data-ttu-id="761b7-120">Es gibt zwei notwendigen Schritten beteiligt, die zum Signieren eines Moduls:</span><span class="sxs-lookup"><span data-stu-id="761b7-120">There are two required steps involved in signing a module:</span></span>  
  
1. <span data-ttu-id="761b7-121">Erstellen Sie mit der Transact-SQL-`CREATE CERTIFICATE [certificateName]`-Anweisung ein Zertifikat.</span><span class="sxs-lookup"><span data-stu-id="761b7-121">Create a certificate using the Transact-SQL `CREATE CERTIFICATE [certificateName]` statement.</span></span> <span data-ttu-id="761b7-122">Diese Anweisung verfügt über mehrere Optionen, mit denen das Start- und Enddatum und ein Kennwort festgelegt werden können.</span><span class="sxs-lookup"><span data-stu-id="761b7-122">This statement has several options for setting a start and end date and a password.</span></span> <span data-ttu-id="761b7-123">Die Standardgültigkeitsdauer ist ein Jahr.</span><span class="sxs-lookup"><span data-stu-id="761b7-123">The default expiration date is one year.</span></span>  
  
1. <span data-ttu-id="761b7-124">Signieren Sie die Prozedur mit dem Zertifikat. Verwenden Sie dazu die Transact-SQL-`ADD SIGNATURE TO [procedureName] BY CERTIFICATE [certificateName]`-Anweisung.</span><span class="sxs-lookup"><span data-stu-id="761b7-124">Sign the procedure with the certificate using the Transact-SQL `ADD SIGNATURE TO [procedureName] BY CERTIFICATE [certificateName]` statement.</span></span>  

<span data-ttu-id="761b7-125">Nachdem das Modul signiert wurde, muss einen oder mehrere Prinzipale erstellt werden, um die zusätzlichen Berechtigungen enthalten, die mit dem Zertifikat verknüpft werden sollen.</span><span class="sxs-lookup"><span data-stu-id="761b7-125">Once the module has been signed, one or more principals needs to be created in order to hold the additional permissions that should be associated with the certificate.</span></span>  

<span data-ttu-id="761b7-126">Wenn das Modul zusätzliche auf Datenbankebene-Berechtigungen erforderlich:</span><span class="sxs-lookup"><span data-stu-id="761b7-126">If the module needs additional database-level permissions:</span></span>  
  
1. <span data-ttu-id="761b7-127">Erstellen Sie mit der Transact-SQL-`CREATE USER [userName] FROM CERTIFICATE [certificateName]`-Anweisung einen mit diesem Zertifikat verknüpften Datenbankbenutzer.</span><span class="sxs-lookup"><span data-stu-id="761b7-127">Create a database user associated with that certificate using the Transact-SQL `CREATE USER [userName] FROM CERTIFICATE [certificateName]` statement.</span></span> <span data-ttu-id="761b7-128">Dieser Benutzer nur in der Datenbank vorhanden ist, und es ist nicht mit einer Anmeldung verknüpft, es sei denn, eine Anmeldung auch über das gleiche Zertifikat erstellt wurde.</span><span class="sxs-lookup"><span data-stu-id="761b7-128">This user exists in the database only and is not associated with a login unless a login has also been created from that same certificate.</span></span>  
  
1. <span data-ttu-id="761b7-129">Erteilen Sie dem Zertifikatsbenutzer die erforderlichen Berechtigungen auf Datenbankebene.</span><span class="sxs-lookup"><span data-stu-id="761b7-129">Grant the certificate user the required database-level permissions.</span></span>  
  
<span data-ttu-id="761b7-130">Wenn das Modul zusätzliche auf Serverebene-Berechtigungen erforderlich:</span><span class="sxs-lookup"><span data-stu-id="761b7-130">If the module needs additional server-level permissions:</span></span>  
  
1. <span data-ttu-id="761b7-131">Kopieren Sie das Zertifikat auf dem `master` Datenbank.</span><span class="sxs-lookup"><span data-stu-id="761b7-131">Copy the certificate to the `master` database.</span></span>  
 
1. <span data-ttu-id="761b7-132">Erstellen Sie eine Anmeldung mit diesem Zertifikat, mit der Transact-SQL-verknüpften `CREATE LOGIN [userName] FROM CERTIFICATE [certificateName]` Anweisung.</span><span class="sxs-lookup"><span data-stu-id="761b7-132">Create a login associated with that certificate using the Transact-SQL `CREATE LOGIN [userName] FROM CERTIFICATE [certificateName]` statement.</span></span>  
  
1. <span data-ttu-id="761b7-133">Erteilen Sie der Anmeldung des Zertifikats die erforderlichen Berechtigungen auf Serverebene.</span><span class="sxs-lookup"><span data-stu-id="761b7-133">Grant the certificate login the required server-level permissions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="761b7-134">Ein Zertifikat kann keine Berechtigungen für Benutzer gewähren, die Berechtigungen hatten, die mit der DENY-Anweisung widerrufen wurden.</span><span class="sxs-lookup"><span data-stu-id="761b7-134">A certificate cannot grant permissions to a user that has had permissions revoked using the DENY statement.</span></span> <span data-ttu-id="761b7-135">DENY hat immer Vorrang gegenüber GRANT und verhindert, dass der Aufrufer Berechtigungen erben kann, die dem Zertifikatsbenutzer gewährt wurden.</span><span class="sxs-lookup"><span data-stu-id="761b7-135">DENY always takes precedence over GRANT, preventing the caller from inheriting permissions granted to the certificate user.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="761b7-136">Externe Ressourcen</span><span class="sxs-lookup"><span data-stu-id="761b7-136">External Resources</span></span>  
 <span data-ttu-id="761b7-137">Weitere Informationen finden Sie in den folgenden Ressourcen.</span><span class="sxs-lookup"><span data-stu-id="761b7-137">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="761b7-138">Ressource</span><span class="sxs-lookup"><span data-stu-id="761b7-138">Resource</span></span>|<span data-ttu-id="761b7-139">Beschreibung</span><span class="sxs-lookup"><span data-stu-id="761b7-139">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="761b7-140">[Modulsignierung](https://go.microsoft.com/fwlink/?LinkId=98590) in SQL Server-Onlinedokumentation</span><span class="sxs-lookup"><span data-stu-id="761b7-140">[Module Signing](https://go.microsoft.com/fwlink/?LinkId=98590) in SQL Server Books Online</span></span>|<span data-ttu-id="761b7-141">Beschreibt die Modulsignierung und enthält ein Beispielszenario sowie Links zu den relevanten Transact-SQL-Themen.</span><span class="sxs-lookup"><span data-stu-id="761b7-141">Describes module signing, providing a sample scenario and links to the relevant Transact-SQL topics.</span></span>|  
|<span data-ttu-id="761b7-142">[Signieren von gespeicherten Prozeduren mit einem Zertifikat](/sql/relational-databases/tutorial-signing-stored-procedures-with-a-certificate) in SQL Server-Onlinedokumentation</span><span class="sxs-lookup"><span data-stu-id="761b7-142">[Signing Stored Procedures with a Certificate](/sql/relational-databases/tutorial-signing-stored-procedures-with-a-certificate) in SQL Server Books Online</span></span>|<span data-ttu-id="761b7-143">Enthält ein Lernprogramm zum Signieren einer gespeicherten Prozedur mit einem Zertifikat.</span><span class="sxs-lookup"><span data-stu-id="761b7-143">Provides a tutorial for signing a stored procedure with a certificate.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="761b7-144">Siehe auch</span><span class="sxs-lookup"><span data-stu-id="761b7-144">See also</span></span>

- [<span data-ttu-id="761b7-145">Sichern von ADO.NET-Anwendungen</span><span class="sxs-lookup"><span data-stu-id="761b7-145">Securing ADO.NET Applications</span></span>](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)
- [<span data-ttu-id="761b7-146">Übersicht über die SQL Server-Sicherheit</span><span class="sxs-lookup"><span data-stu-id="761b7-146">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)
- [<span data-ttu-id="761b7-147">Anwendungssicherheitsszenarios in SQL Server</span><span class="sxs-lookup"><span data-stu-id="761b7-147">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="761b7-148">Verwalten von Berechtigungen mit gespeicherten Prozeduren in SQL Server</span><span class="sxs-lookup"><span data-stu-id="761b7-148">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="761b7-149">Schreiben von sicherem dynamischen SQL in SQL Server</span><span class="sxs-lookup"><span data-stu-id="761b7-149">Writing Secure Dynamic SQL in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/writing-secure-dynamic-sql-in-sql-server.md)
- [<span data-ttu-id="761b7-150">Anpassen von Berechtigungen durch Identitätswechsel in SQL Server</span><span class="sxs-lookup"><span data-stu-id="761b7-150">Customizing Permissions with Impersonation in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)
- [<span data-ttu-id="761b7-151">Ändern von Daten mit gespeicherten Prozeduren</span><span class="sxs-lookup"><span data-stu-id="761b7-151">Modifying Data with Stored Procedures</span></span>](../../../../../docs/framework/data/adonet/modifying-data-with-stored-procedures.md)
- [<span data-ttu-id="761b7-152">ADO.NET Managed Provider und DataSet Developer Center</span><span class="sxs-lookup"><span data-stu-id="761b7-152">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
