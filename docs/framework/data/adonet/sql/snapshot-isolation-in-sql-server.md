---
title: Momentaufnahmenisolation in SQL Server
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 43ae5dd3-50f5-43a8-8d01-e37a61664176
ms.openlocfilehash: 6d85cc041850300d1d079b227dcb8ed9201a0502
ms.sourcegitcommit: 3094dcd17141b32a570a82ae3f62a331616e2c9c
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 10/01/2019
ms.locfileid: "71699063"
---
# <a name="snapshot-isolation-in-sql-server"></a><span data-ttu-id="8c97e-102">Momentaufnahmenisolation in SQL Server</span><span class="sxs-lookup"><span data-stu-id="8c97e-102">Snapshot Isolation in SQL Server</span></span>
<span data-ttu-id="8c97e-103">Die Momentaufnahmeisolation erweitert die Parallelität für OLTP-Anwendungen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-103">Snapshot isolation enhances concurrency for OLTP applications.</span></span>  
  
## <a name="understanding-snapshot-isolation-and-row-versioning"></a><span data-ttu-id="8c97e-104">Informationen zur Snapshot-Isolation und Zeilenversionserstellung</span><span class="sxs-lookup"><span data-stu-id="8c97e-104">Understanding Snapshot Isolation and Row Versioning</span></span>  
 <span data-ttu-id="8c97e-105">Sobald die Momentaufnahme Isolation aktiviert ist, müssen die aktualisierten Zeilen Versionen für jede Transaktion beibehalten werden.</span><span class="sxs-lookup"><span data-stu-id="8c97e-105">Once snapshot isolation is enabled, updated row versions for each transaction must be maintained.</span></span>  <span data-ttu-id="8c97e-106">Vor SQL Server 2019 wurden diese Versionen in **tempdb**gespeichert.</span><span class="sxs-lookup"><span data-stu-id="8c97e-106">Prior to SQL Server 2019, these versions were stored in **tempdb**.</span></span> <span data-ttu-id="8c97e-107">In SQL Server 2019 wird eine neue Funktion eingeführt, Accelerated Database Recovery (ADR), die einen eigenen Satz von Zeilen Versionen erfordert.</span><span class="sxs-lookup"><span data-stu-id="8c97e-107">SQL Server 2019 introduces a new feature, Accelerated Database Recovery (ADR) which requires its own set of row versions.</span></span>  <span data-ttu-id="8c97e-108">Ab SQL Server 2019 werden Zeilen Versionen in **tempdb** wie immer beibehalten, wenn die ADR nicht aktiviert ist.</span><span class="sxs-lookup"><span data-stu-id="8c97e-108">So, as of SQL Server 2019, if ADR is not enabled, row versions are kept in **tempdb** as always.</span></span>  <span data-ttu-id="8c97e-109">Wenn die automatische Bereitstellungs Funktion aktiviert ist, werden alle Zeilen Versionen, die mit der Momentaufnahme Isolation und der AdR verknüpft sind, im permanenten Versionsspeicher der AdR (PVS) gespeichert, der sich in der Benutzerdatenbank in einer Datei Gruppe befindet, die der Benutzer angibt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-109">If ADR is enabled, then all row versions, both related to snapshot isolation and ADR, are kept in ADR's Persistent Version Store (PVS), which is located in the user database in a filegroup which the user specifies.</span></span> <span data-ttu-id="8c97e-110">Jede Transaktion wird durch eine Transaktionsfolgenummer gekennzeichnet, und diese eindeutigen Nummern werden für jede Zeilenversion aufgezeichnet.</span><span class="sxs-lookup"><span data-stu-id="8c97e-110">A unique transaction sequence number identifies each transaction, and these unique numbers are recorded for each row version.</span></span> <span data-ttu-id="8c97e-111">Für die Transaktion werden die aktuellsten Zeilenversionen verwendet, die über eine Folgenummer verfügen, die niedriger ist als diejenige der Transaktion.</span><span class="sxs-lookup"><span data-stu-id="8c97e-111">The transaction works with the most recent row versions having a sequence number before the sequence number of the transaction.</span></span> <span data-ttu-id="8c97e-112">Aktuellere, nach dem Beginn der Transaktion erstellte Zeilenversionen werden von der Transaktion ignoriert.</span><span class="sxs-lookup"><span data-stu-id="8c97e-112">Newer row versions created after the transaction has begun are ignored by the transaction.</span></span>  
  
 <span data-ttu-id="8c97e-113">Die Benennung „Momentaufnahme“ gibt die Tatsache wieder, dass alle Abfragen in der Transaktion auf dieselbe Version (Momentaufnahme) der Datenbank zurückgehen, die auf dem Zustand der Datenbank zum Zeitpunkt des Beginns der Transaktion basiert.</span><span class="sxs-lookup"><span data-stu-id="8c97e-113">The term "snapshot" reflects the fact that all queries in the transaction see the same version, or snapshot, of the database, based on the state of the database at the moment in time when the transaction begins.</span></span> <span data-ttu-id="8c97e-114">In einer Snapshot-Transaktion werden für die zugrunde liegenden Datenzeilen oder Datenseiten keine Sperren bezogen, wodurch andere Transaktionen ausgeführt werden können, ohne durch eine vorherige, nicht vollständig ausgeführte Transaktion blockiert zu werden.</span><span class="sxs-lookup"><span data-stu-id="8c97e-114">No locks are acquired on the underlying data rows or data pages in a snapshot transaction, which permits other transactions to execute without being blocked by a prior uncompleted transaction.</span></span> <span data-ttu-id="8c97e-115">Transaktionen, die Daten ändern, blockieren keine Transaktionen, die Daten lesen; und Transaktionen, die Daten lesen, blockieren keine Transaktionen, die Daten schreiben. Bei der READ COMMITTED-Standardisolationsstufe in SQL Server wäre dies i. d. R. der Fall.</span><span class="sxs-lookup"><span data-stu-id="8c97e-115">Transactions that modify data do not block transactions that read data, and transactions that read data do not block transactions that write data, as they normally would under the default READ COMMITTED isolation level in SQL Server.</span></span> <span data-ttu-id="8c97e-116">Dieses nicht blockierende Verhalten verringert die Wahrscheinlichkeit für Deadlocks bei komplexen Transaktionen beträchtlich.</span><span class="sxs-lookup"><span data-stu-id="8c97e-116">This non-blocking behavior also significantly reduces the likelihood of deadlocks for complex transactions.</span></span>  
  
 <span data-ttu-id="8c97e-117">Bei der Snapshot-Isolation wird ein Modell der vollständigen Parallelität verwendet.</span><span class="sxs-lookup"><span data-stu-id="8c97e-117">Snapshot isolation uses an optimistic concurrency model.</span></span> <span data-ttu-id="8c97e-118">Wenn eine Snapshot-Transaktion versucht, Änderungen an Daten zu speichern, die seit dem Beginn der Transaktion geändert wurden, wird die Transaktion zurückgesetzt und ein Fehler ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="8c97e-118">If a snapshot transaction attempts to commit modifications to data that has changed since the transaction began, the transaction will roll back and an error will be raised.</span></span> <span data-ttu-id="8c97e-119">Dies kann durch das Verwenden von UPDLOCK-Hinweisen für SELECT-Anweisungen verhindert werden, die auf zu ändernde Daten zugreifen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-119">You can avoid this by using UPDLOCK hints for SELECT statements that access data to be modified.</span></span> <span data-ttu-id="8c97e-120">Weitere Informationen finden Sie in der Onlinedokumentation zu SQL Server unter "Locking Hints".</span><span class="sxs-lookup"><span data-stu-id="8c97e-120">See "Locking Hints" in SQL Server Books Online for more information.</span></span>  
  
 <span data-ttu-id="8c97e-121">Die Snapshot-Isolation muss durch das Festlegen der ALLOW_SNAPSHOT_ISOLATION ON-Datenbankoption aktiviert werden, bevor sie in Transaktionen verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="8c97e-121">Snapshot isolation must be enabled by setting the ALLOW_SNAPSHOT_ISOLATION ON database option before it is used in transactions.</span></span> <span data-ttu-id="8c97e-122">Dies aktiviert den Mechanismus zum Speichern von Zeilen Versionen in der temporären Datenbank (**tempdb**).</span><span class="sxs-lookup"><span data-stu-id="8c97e-122">This activates the mechanism for storing row versions in the temporary database (**tempdb**).</span></span> <span data-ttu-id="8c97e-123">Die Snapshot-Isolation muss in jeder Datenbank, die diese verwendet, mit der ALTER DATABASE-Transact-SQL-Anweisung aktiviert werden.</span><span class="sxs-lookup"><span data-stu-id="8c97e-123">You must enable snapshot isolation in each database that uses it with the Transact-SQL ALTER DATABASE statement.</span></span> <span data-ttu-id="8c97e-124">In diesem Punkt unterscheidet sich die Snapshot-Isolation von den herkömmlichen Isolationsstufen READ COMMITTED, REPEATABLE READ, SERIALIZABLE und READ UNCOMMITTED, für die keine Konfiguration erforderlich ist.</span><span class="sxs-lookup"><span data-stu-id="8c97e-124">In this respect, snapshot isolation differs from the traditional isolation levels of READ COMMITTED, REPEATABLE READ, SERIALIZABLE, and READ UNCOMMITTED, which require no configuration.</span></span> <span data-ttu-id="8c97e-125">Die folgenden Anweisungen aktivieren die Snapshot-Isolation und ersetzen das READ COMMITTED-Standardverhalten durch SNAPSHOT:</span><span class="sxs-lookup"><span data-stu-id="8c97e-125">The following statements activate snapshot isolation and replace the default READ COMMITTED behavior with SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE MyDatabase  
SET ALLOW_SNAPSHOT_ISOLATION ON  
  
ALTER DATABASE MyDatabase  
SET READ_COMMITTED_SNAPSHOT ON  
```  
  
 <span data-ttu-id="8c97e-126">Das Festlegen der READ_COMMITTED_SNAPSHOT ON-Option ermöglicht Zugriff auf versionierte Zeilen mit der READ COMMITTED-Isolationsstufe.</span><span class="sxs-lookup"><span data-stu-id="8c97e-126">Setting the READ_COMMITTED_SNAPSHOT ON option allows access to versioned rows under the default READ COMMITTED isolation level.</span></span> <span data-ttu-id="8c97e-127">Wenn die READ_COMMITTED_SNAPSHOT-Option auf OFF festgelegt ist, müssen Sie die Snapshot-Isolationsstufe für jede Sitzung explizit festlegen, um auf versionierte Zeilen zuzugreifen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-127">If the READ_COMMITTED_SNAPSHOT option is set to OFF, you must explicitly set the Snapshot isolation level for each session in order to access versioned rows.</span></span>  
  
## <a name="managing-concurrency-with-isolation-levels"></a><span data-ttu-id="8c97e-128">Verwalten von Parallelität mit Isolationsstufen</span><span class="sxs-lookup"><span data-stu-id="8c97e-128">Managing Concurrency with Isolation Levels</span></span>  
 <span data-ttu-id="8c97e-129">Die Isolationsstufe, mit der eine Transact-SQL-Anweisung ausgeführt wird, bestimmt das entsprechende Verhalten bei der Sperr- und Zeilenversionserstellung.</span><span class="sxs-lookup"><span data-stu-id="8c97e-129">The isolation level under which a Transact-SQL statement executes determines its locking and row versioning behavior.</span></span> <span data-ttu-id="8c97e-130">Eine Isolationsstufe gilt für die gesamte Verbindung, und sobald sie mit der SET TRANSACTION ISOLATION LEVEL-Anweisung für eine Verbindung festgelegt wurde, bleibt sie aktiv, bis die Verbindung geschlossen oder eine andere Isolationsstufe festgelegt wird.</span><span class="sxs-lookup"><span data-stu-id="8c97e-130">An isolation level has connection-wide scope, and once set for a connection with the SET TRANSACTION ISOLATION LEVEL statement, it remains in effect until the connection is closed or another isolation level is set.</span></span> <span data-ttu-id="8c97e-131">Wenn eine Verbindung geschlossen und an den Pool zurückgegeben wird, wird die Isolationsstufe aus der letzten SET TRANSACTION ISOLATION LEVEL-Anweisung beibehalten.</span><span class="sxs-lookup"><span data-stu-id="8c97e-131">When a connection is closed and returned to the pool, the isolation level from the last SET TRANSACTION ISOLATION LEVEL statement is retained.</span></span> <span data-ttu-id="8c97e-132">Nachfolgende Verbindungen, die eine an den Pool zurückgegebene Verbindung erneut verwenden, verwenden die Isolationsstufe, die zu dem Zeitpunkt gültig war, als die Verbindung an den Pool zurückgegeben wurde.</span><span class="sxs-lookup"><span data-stu-id="8c97e-132">Subsequent connections reusing a pooled connection use the isolation level that was in effect at the time the connection is pooled.</span></span>  
  
 <span data-ttu-id="8c97e-133">Einzelne innerhalb einer Verbindung durchgeführte Abfragen können Sperrhinweise enthalten, die die Isolation für eine einzelne Anweisung oder Transaktion ändern, aber die Isolationsstufe der Verbindung nicht beeinflussen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-133">Individual queries issued within a connection can contain lock hints that modify the isolation for a single statement or transaction but do not affect the isolation level of the connection.</span></span> <span data-ttu-id="8c97e-134">Isolationsstufen oder Sperrhinweise, die in gespeicherten Prozeduren oder Funktionen festgelegt sind, ändern die Isolationsstufe der aufrufenden Verbindung nicht. Sie sind nur für die Dauer der gespeicherten Prozedur oder des Funktionsaufrufs aktiv.</span><span class="sxs-lookup"><span data-stu-id="8c97e-134">Isolation levels or lock hints set in stored procedures or functions do not change the isolation level of the connection that calls them and are in effect only for the duration of the stored procedure or function call.</span></span>  
  
 <span data-ttu-id="8c97e-135">In frühen Versionen von SQL Server wurden vier Isolationsstufen unterstützt, die im SQL-92-Standard definiert wurden:</span><span class="sxs-lookup"><span data-stu-id="8c97e-135">Four isolation levels defined in the SQL-92 standard were supported in early versions of SQL Server:</span></span>  
  
- <span data-ttu-id="8c97e-136">READ UNCOMMITTED ist die am wenigsten restriktive Isolationsstufe, da sie von anderen Transaktionen platzierte Sperren ignoriert.</span><span class="sxs-lookup"><span data-stu-id="8c97e-136">READ UNCOMMITTED is the least restrictive isolation level because it ignores locks placed by other transactions.</span></span> <span data-ttu-id="8c97e-137">Mit READ UNCOMMITTED ausgeführte Transaktionen können geänderte Datenwerte lesen, die noch nicht von anderen Transaktionen gespeichert wurden; diese werden "unsaubere" Lesevorgänge genannt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-137">Transactions executing under READ UNCOMMITTED can read modified data values that have not yet been committed by other transactions; these are called "dirty" reads.</span></span>  
  
- <span data-ttu-id="8c97e-138">READ COMMITTED ist die Standardisolationsstufe für SQL Server.</span><span class="sxs-lookup"><span data-stu-id="8c97e-138">READ COMMITTED is the default isolation level for SQL Server.</span></span> <span data-ttu-id="8c97e-139">Er verhindert „unsaubere“ Lesevorgänge, indem festgelegt wird, dass Anweisungen keine Datenwerte lesen können, die geändert, aber noch nicht von anderen Transaktionen gespeichert wurden.</span><span class="sxs-lookup"><span data-stu-id="8c97e-139">It prevents dirty reads by specifying that statements cannot read data values that have been modified but not yet committed by other transactions.</span></span> <span data-ttu-id="8c97e-140">Andere Transaktionen können immer noch Daten zwischen Ausführungen einzelner Anweisungen innerhalb der aktuellen Transaktion ändern, einfügen oder löschen, was zu nicht wiederholbaren Lesevorgängen oder "Phantomdaten" führt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-140">Other transactions can still modify, insert, or delete data between executions of individual statements within the current transaction, resulting in non-repeatable reads, or "phantom" data.</span></span>  
  
- <span data-ttu-id="8c97e-141">REPEATABLE READ ist eine restriktivere Isolationsstufe als READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="8c97e-141">REPEATABLE READ is a more restrictive isolation level than READ COMMITTED.</span></span> <span data-ttu-id="8c97e-142">Er umfasst READ COMMITTED und gibt zusätzlich an, dass keine andere Transaktion Daten ändern oder löschen kann, die von der aktuellen Transaktion gelesen wurden, bis die aktuelle Transaktion einen Commit durchführt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-142">It encompasses READ COMMITTED and additionally specifies that no other transactions can modify or delete data that has been read by the current transaction until the current transaction commits.</span></span> <span data-ttu-id="8c97e-143">Die Parallelität ist geringer als bei READ COMMITTED, da gemeinsam verwendete Sperren für gelesene Daten für die Dauer der Transaktion beibehalten und nicht am Ende jeder Anweisung zurückgegeben werden.</span><span class="sxs-lookup"><span data-stu-id="8c97e-143">Concurrency is lower than for READ COMMITTED because shared locks on read data are held for the duration of the transaction instead of being released at the end of each statement.</span></span>  
  
- <span data-ttu-id="8c97e-144">SERIALIZABLE ist die restriktivste Isolationsstufe, da sie bis zum Abschluss der Transaktion vollständige Schlüsselbereiche sperrt und die Sperren beibehält.</span><span class="sxs-lookup"><span data-stu-id="8c97e-144">SERIALIZABLE is the most restrictive isolation level, because it locks entire ranges of keys and holds the locks until the transaction is complete.</span></span> <span data-ttu-id="8c97e-145">Er umfasst REPEATABLE READ und fügt die Einschränkung hinzu, dass andere Transaktionen bis zum Abschluss der Transaktion keine neuen Zeilen in Bereiche einfügen können, die von der Transaktion gelesen wurden.</span><span class="sxs-lookup"><span data-stu-id="8c97e-145">It encompasses REPEATABLE READ and adds the restriction that other transactions cannot insert new rows into ranges that have been read by the transaction until the transaction is complete.</span></span>  
  
 <span data-ttu-id="8c97e-146">Weitere Informationen finden Sie im Handbuch zu [Transaktions Sperren und Zeilen Versions](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide)Verwaltung.</span><span class="sxs-lookup"><span data-stu-id="8c97e-146">For more information, refer to the [Transaction Locking and Row Versioning Guide](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span></span>  
  
### <a name="snapshot-isolation-level-extensions"></a><span data-ttu-id="8c97e-147">Snapshot-Isolationsstufenerweiterungen</span><span class="sxs-lookup"><span data-stu-id="8c97e-147">Snapshot Isolation Level Extensions</span></span>  
 <span data-ttu-id="8c97e-148">In SQL Server wurden mit der SNAPSHOT-Isolationsstufe und einer zusätzlichen READ COMMITTED-Implementierung Erweiterungen zu den SQL-92-Isolationsstufen eingeführt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-148">SQL Server introduced extensions to the SQL-92 isolation levels with the introduction of the SNAPSHOT isolation level and an additional implementation of READ COMMITTED.</span></span> <span data-ttu-id="8c97e-149">Die READ_COMMITTED_SNAPSHOT-Isolationsstufe kann READ COMMITTED für alle Transaktionen auf transparente Weise ersetzen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-149">The READ_COMMITTED_SNAPSHOT isolation level can transparently replace READ COMMITTED for all transactions.</span></span>  
  
- <span data-ttu-id="8c97e-150">SNAPSHOT-Isolation gibt an, dass innerhalb einer Transaktion gelesene Daten niemals Änderungen widerspiegeln, die von anderen gleichzeitigen Transaktionen durchgeführt wurden.</span><span class="sxs-lookup"><span data-stu-id="8c97e-150">SNAPSHOT isolation specifies that data read within a transaction will never reflect changes made by other simultaneous transactions.</span></span> <span data-ttu-id="8c97e-151">Die Transaktion verwendet die Datenzeilenversionen, die zu Beginn der Transaktion vorhanden sind.</span><span class="sxs-lookup"><span data-stu-id="8c97e-151">The transaction uses the data row versions that exist when the transaction begins.</span></span> <span data-ttu-id="8c97e-152">Beim Lesen der Daten werden keine Sperren erstellt, deshalb blockieren SNAPSHOT-Transaktionen das Schreiben von Daten durch andere Transaktionen nicht.</span><span class="sxs-lookup"><span data-stu-id="8c97e-152">No locks are placed on the data when it is read, so SNAPSHOT transactions do not block other transactions from writing data.</span></span> <span data-ttu-id="8c97e-153">Transaktionen, die Daten schreiben, blockieren das Lesen von Daten durch andere Transaktionen nicht.</span><span class="sxs-lookup"><span data-stu-id="8c97e-153">Transactions that write data do not block snapshot transactions from reading data.</span></span> <span data-ttu-id="8c97e-154">Um die Snapshot-Isolation verwenden zu können, müssen Sie die ALLOW_SNAPSHOT_ISOLATION-Datenbankoption aktivieren.</span><span class="sxs-lookup"><span data-stu-id="8c97e-154">You need to enable snapshot isolation by setting the ALLOW_SNAPSHOT_ISOLATION database option in order to use it.</span></span>  
  
- <span data-ttu-id="8c97e-155">Die READ_COMMITTED_SNAPSHOT-Datenbankoption bestimmt das Verhalten der READ COMMITTED-Standardisolationsstufe, wenn Snapshot-Isolation in einer Datenbank aktiviert ist.</span><span class="sxs-lookup"><span data-stu-id="8c97e-155">The READ_COMMITTED_SNAPSHOT database option determines the behavior of the default READ COMMITTED isolation level when snapshot isolation is enabled in a database.</span></span> <span data-ttu-id="8c97e-156">Wenn Sie READ_COMMITTED_SNAPSHOT ON nicht explizit angeben, wird READ COMMITTED für alle impliziten Transaktionen angewendet.</span><span class="sxs-lookup"><span data-stu-id="8c97e-156">If you do not explicitly specify READ_COMMITTED_SNAPSHOT ON, READ COMMITTED is applied to all implicit transactions.</span></span> <span data-ttu-id="8c97e-157">Dies führt zum gleichen Verhalten wie beim Festlegen von READ_COMMITTED_SNAPSHOT auf OFF (Standardeinstellung).</span><span class="sxs-lookup"><span data-stu-id="8c97e-157">This produces the same behavior as setting READ_COMMITTED_SNAPSHOT OFF (the default).</span></span> <span data-ttu-id="8c97e-158">Wenn READ_COMMITTED_SNAPSHOT auf OFF festgelegt ist, verwendet die Datenbank-Engine gemeinsame Sperren, um die Standardisolationsstufe zu erzwingen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-158">When READ_COMMITTED_SNAPSHOT OFF is in effect, the Database Engine uses shared locks to enforce the default isolation level.</span></span> <span data-ttu-id="8c97e-159">Wenn Sie die READ_COMMITTED_SNAPSHOT-Datenbankoption auf ON festlegen, verwendet die Datenbank-Engine Zeilenversionserstellung und die Snapshot-Isolation als Standard, anstatt Sperren zum Schutz der Daten zu verwenden.</span><span class="sxs-lookup"><span data-stu-id="8c97e-159">If you set the READ_COMMITTED_SNAPSHOT database option to ON, the database engine uses row versioning and snapshot isolation as the default, instead of using locks to protect the data.</span></span>  
  
## <a name="how-snapshot-isolation-and-row-versioning-work"></a><span data-ttu-id="8c97e-160">Funktionsweise der Snapshot-Isolation und der Zeilenversionserstellung</span><span class="sxs-lookup"><span data-stu-id="8c97e-160">How Snapshot Isolation and Row Versioning Work</span></span>  
 <span data-ttu-id="8c97e-161">Wenn die Momentaufnahme Isolationsstufe aktiviert ist, wird bei jeder Aktualisierung einer Zeile die SQL Server Datenbank-Engine eine Kopie der ursprünglichen Zeile in **tempdb**speichert, und der Zeile wird eine Transaktions Sequenznummer hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-161">When the SNAPSHOT isolation level is enabled, each time a row is updated, the SQL Server Database Engine stores a copy of the original row in **tempdb**, and adds a transaction sequence number to the row.</span></span> <span data-ttu-id="8c97e-162">Nachfolgend ist die Reihenfolge der Ereignisse angegeben:</span><span class="sxs-lookup"><span data-stu-id="8c97e-162">The following is the sequence of events that occurs:</span></span>  
  
- <span data-ttu-id="8c97e-163">Eine neue Transaktion wird initiiert, und ihr wird eine Transaktionsfolgenummer zugewiesen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-163">A new transaction is initiated, and it is assigned a transaction sequence number.</span></span>  
  
- <span data-ttu-id="8c97e-164">Der Datenbank-Engine liest eine Zeile innerhalb der Transaktion und ruft die Zeilen Version von **tempdb** ab, deren Sequenznummer der Transaktions Sequenznummer am nächsten und kleiner ist als die Transaktions Sequenznummer.</span><span class="sxs-lookup"><span data-stu-id="8c97e-164">The Database Engine reads a row within the transaction and retrieves the row version from **tempdb** whose sequence number is closest to, and lower than, the transaction sequence number.</span></span>  
  
- <span data-ttu-id="8c97e-165">Die Datenbank-Engine prüft, ob die Transaktionsfolgenummer in der Liste von Transaktionsfolgenummern der nicht übernommenen Transaktionen vorhanden ist, die beim Start der Snapshot-Transaktion aktiv waren.</span><span class="sxs-lookup"><span data-stu-id="8c97e-165">The Database Engine checks to see if the transaction sequence number is not in the list of transaction sequence numbers of the uncommitted transactions active when the snapshot transaction started.</span></span>  
  
- <span data-ttu-id="8c97e-166">Die Transaktion liest die Version der Zeile aus **tempdb** , die zum Beginn der Transaktion aktuell war.</span><span class="sxs-lookup"><span data-stu-id="8c97e-166">The transaction reads the version of the row from **tempdb** that was current as of the start of the transaction.</span></span> <span data-ttu-id="8c97e-167">Nach dem Start der Transaktion kann diese keine neu eingefügten Zeilen erfassen, da diese Folgenummernwerte höher sind als der Wert der Transaktionsfolgenummer.</span><span class="sxs-lookup"><span data-stu-id="8c97e-167">It will not see new rows inserted after the transaction was started because those sequence number values will be higher than the value of the transaction sequence number.</span></span>  
  
- <span data-ttu-id="8c97e-168">In der aktuellen Transaktion werden Zeilen angezeigt, die nach Beginn der Transaktion gelöscht wurden, da in **tempdb** eine Zeilen Version mit einem niedrigeren Sequenznummern Wert vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="8c97e-168">The current transaction will see rows that were deleted after the transaction began, because there will be a row version in **tempdb** with a lower sequence number value.</span></span>  
  
 <span data-ttu-id="8c97e-169">Das Ergebnis der Snapshot-Isolation besteht darin, dass die Transaktion alle Daten so erfasst, wie sie zum Transaktionsstart vorhanden waren, ohne für die zugrunde liegenden Tabellen Sperren umzusetzen oder zu platzieren.</span><span class="sxs-lookup"><span data-stu-id="8c97e-169">The net effect of snapshot isolation is that the transaction sees all of the data as it existed at the start of the transaction, without honoring or placing any locks on the underlying tables.</span></span> <span data-ttu-id="8c97e-170">Dies kann in Situationen mit Konflikten zu einer Leistungssteigerung führen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-170">This can result in performance improvements in situations where there is contention.</span></span>  
  
 <span data-ttu-id="8c97e-171">Eine Snapshot-Transaktion verwendet immer vollständige Parallelitätssteuerung, wobei alle Sperren zurückgehalten werden, die das Aktualisieren von Zeilen durch andere Transaktionen verhindern.</span><span class="sxs-lookup"><span data-stu-id="8c97e-171">A snapshot transaction always uses optimistic concurrency control, withholding any locks that would prevent other transactions from updating rows.</span></span> <span data-ttu-id="8c97e-172">Wenn eine Snapshot-Transaktion versucht, ein Update für eine Zeile zu übernehmen, die nach dem Beginn der Transaktion geändert wurde, wird die Transaktion zurückgenommen und ein Fehler ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="8c97e-172">If a snapshot transaction attempts to commit an update to a row that was changed after the transaction began, the transaction is rolled back, and an error is raised.</span></span>  
  
## <a name="working-with-snapshot-isolation-in-adonet"></a><span data-ttu-id="8c97e-173">Verwenden der Snapshot-Isolation in ADO.NET</span><span class="sxs-lookup"><span data-stu-id="8c97e-173">Working with Snapshot Isolation in ADO.NET</span></span>  
 <span data-ttu-id="8c97e-174">Die Snapshot-Isolation wird in ADO.NET durch die <xref:System.Data.SqlClient.SqlTransaction>-Klasse unterstützt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-174">Snapshot isolation is supported in ADO.NET by the <xref:System.Data.SqlClient.SqlTransaction> class.</span></span> <span data-ttu-id="8c97e-175">Wenn eine Datenbank für die Momentaufnahme Isolation aktiviert ist, aber nicht für READ_COMMITTED_SNAPSHOT on konfiguriert ist, müssen Sie beim Aufrufen der <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A>-Methode eine <xref:System.Data.SqlClient.SqlTransaction> mit dem **IsolationLevel. Snapshot** -Enumerationswert initiieren.</span><span class="sxs-lookup"><span data-stu-id="8c97e-175">If a database has been enabled for snapshot isolation but is not configured for READ_COMMITTED_SNAPSHOT ON, you must initiate a <xref:System.Data.SqlClient.SqlTransaction> using the **IsolationLevel.Snapshot** enumeration value when calling the <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="8c97e-176">Für dieses Codefragment wird angenommen, dass es sich bei der Verbindung um ein offenes <xref:System.Data.SqlClient.SqlConnection>-Objekt handelt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-176">This code fragment assumes that connection is an open <xref:System.Data.SqlClient.SqlConnection> object.</span></span>  
  
```vb  
Dim sqlTran As SqlTransaction = _  
  connection.BeginTransaction(IsolationLevel.Snapshot)  
```  
  
```csharp  
SqlTransaction sqlTran =   
  connection.BeginTransaction(IsolationLevel.Snapshot);  
```  
  
### <a name="example"></a><span data-ttu-id="8c97e-177">Beispiel</span><span class="sxs-lookup"><span data-stu-id="8c97e-177">Example</span></span>  
 <span data-ttu-id="8c97e-178">Im folgenden Beispiel wird gezeigt, wie sich die verschiedenen Isolationsstufen beim Zugriff auf gesperrte Daten verhalten. Dieses Beispiel ist nicht zur Verwendung in Produktionscode bestimmt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-178">The following example demonstrates how the different isolation levels behave by attempting to access locked data, and it is not intended to be used in production code.</span></span>  
  
 <span data-ttu-id="8c97e-179">Der Code stellt eine Verbindung mit der **AdventureWorks** -Beispieldatenbank in SQL Server her und erstellt eine Tabelle mit dem Namen " **TestSnapshot** " und fügt eine Zeile mit Daten ein.</span><span class="sxs-lookup"><span data-stu-id="8c97e-179">The code connects to the **AdventureWorks** sample database in SQL Server and creates a table named **TestSnapshot** and inserts one row of data.</span></span> <span data-ttu-id="8c97e-180">Der Code verwendet die ALTER DATABASE Transact-SQL-Anweisung zum Aktivieren der Snapshot-Isolation für die Datenbank, legt aber nicht die READ_COMMITTED_SNAPSHOT-Option fest, wodurch das READ COMMITTED-Isolationsstufenverhalten bestehen bleibt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-180">The code uses the ALTER DATABASE Transact-SQL statement to turn on snapshot isolation for the database, but it does not set the READ_COMMITTED_SNAPSHOT option, leaving the default READ COMMITTED isolation-level behavior in effect.</span></span> <span data-ttu-id="8c97e-181">Der Code führt dann die folgenden Aktionen aus:</span><span class="sxs-lookup"><span data-stu-id="8c97e-181">The code then performs the following actions:</span></span>  
  
- <span data-ttu-id="8c97e-182">Er startet sqlTransaction1, die die SERIALIZABLE-Isolationsstufe verwendet, um eine Updatetransaktion zu starten. sqlTransaction1 wird allerdings nicht fertig gestellt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-182">It begins, but does not complete, sqlTransaction1, which uses the SERIALIZABLE isolation level to start an update transaction.</span></span> <span data-ttu-id="8c97e-183">Dadurch wird die Tabelle gesperrt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-183">This has the effect of locking the table.</span></span>  
  
- <span data-ttu-id="8c97e-184">Er öffnet eine zweite Verbindung und initiiert eine zweite Transaktion mit der Momentaufnahme Isolationsstufe, um die Daten in der Tabelle **TestSnapshot** zu lesen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-184">It opens a second connection and initiates a second transaction using the SNAPSHOT isolation level to read the data in the **TestSnapshot** table.</span></span> <span data-ttu-id="8c97e-185">Da die Snapshot-Isolation aktiviert ist, kann diese Transaktion die Daten lesen, die vor dem Start von sqlTransaction1 vorhanden waren.</span><span class="sxs-lookup"><span data-stu-id="8c97e-185">Because snapshot isolation is enabled, this transaction can read the data that existed before sqlTransaction1 started.</span></span>  
  
- <span data-ttu-id="8c97e-186">Der Code öffnet eine dritte Verbindung und initiiert eine Transaktion mit der READ COMMITED-Isolationsstufe, um die Daten in der Tabelle zu lesen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-186">It opens a third connection and initiates a transaction using the READ COMMITTED isolation level to attempt to read the data in the table.</span></span> <span data-ttu-id="8c97e-187">In diesem Fall kann der Code die Daten nicht lesen, weil er nicht über die Sperren hinweg lesen kann, die in der ersten Transaktion für die Tabelle platziert wurden, und löst eine Zeitüberschreitung aus. Das gleiche Ergebnis tritt auch bei den Isolationsstufen REPEATABLE READ und SERIALIZABLE auf, weil diese Isolationsstufen ebenfalls nicht über die in der ersten Transaktion platzierten Sperren hinweg lesen können.</span><span class="sxs-lookup"><span data-stu-id="8c97e-187">In this case, the code cannot read the data because it cannot read past the locks placed on the table in the first transaction and times out. The same result would occur if the REPEATABLE READ and SERIALIZABLE isolation levels were used because these isolation levels also cannot read past the locks placed in the first transaction.</span></span>  
  
- <span data-ttu-id="8c97e-188">Der Code öffnet eine vierte Verbindung und initiiert mit der READ UNCOMMITTED-Isolationsstufe eine Transaktion, die einen „unsauberen“ Lesevorgang für den nicht übernommenen Wert in sqlTransaction1 durchführt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-188">It opens a fourth connection and initiates a transaction using the READ UNCOMMITTED isolation level, which performs a dirty read of the uncommitted value in sqlTransaction1.</span></span> <span data-ttu-id="8c97e-189">Dieser Wert ist möglicherweise tatsächlich nie in der Datenbank vorhanden, wenn die erste Transaktion nicht übernommen wird.</span><span class="sxs-lookup"><span data-stu-id="8c97e-189">This value may never actually exist in the database if the first transaction is not committed.</span></span>  
  
- <span data-ttu-id="8c97e-190">Sie führt einen Rollback für die erste Transaktion aus und bereinigt Sie, indem die Tabelle " **TestSnapshot** " gelöscht und die Momentaufnahme Isolation für die **AdventureWorks** -Datenbank deaktiviert wird.</span><span class="sxs-lookup"><span data-stu-id="8c97e-190">It rolls back the first transaction and cleans up by deleting the **TestSnapshot** table and turning off snapshot isolation for the **AdventureWorks** database.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="8c97e-191">In den folgenden Beispielen wird dieselbe Verbindungszeichenfolge verwendet, wobei aber das Verbindungspooling deaktiviert ist.</span><span class="sxs-lookup"><span data-stu-id="8c97e-191">The following examples use the same connection string with connection pooling turned off.</span></span> <span data-ttu-id="8c97e-192">Wenn sich eine Verbindung in einem Pool befindet, führt die Rücksetzung ihrer Isolationsstufe nicht automatisch auch zur Rücksetzung der Isolationsstufe auf dem Server.</span><span class="sxs-lookup"><span data-stu-id="8c97e-192">If a connection is pooled, resetting its isolation level does not reset the isolation level at the server.</span></span> <span data-ttu-id="8c97e-193">Nachfolgende Verbindungen, die dieselbe innere Verbindung aus dem Pool verwenden, beginnen daher mit der Isolationsstufe, die für die Verbindung im Pool festgelegt ist.</span><span class="sxs-lookup"><span data-stu-id="8c97e-193">As a result, subsequent connections that use the same pooled inner connection start with their isolation levels set to that of the pooled connection.</span></span> <span data-ttu-id="8c97e-194">Alternativ zum Deaktivieren des Verbindungspoolings können Sie auch die Isolationsstufe explizit für jede Verbindung festlegen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-194">An alternative to turning off connection pooling is to set the isolation level explicitly for each connection.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/VB/source.vb#1)]  
  
### <a name="example"></a><span data-ttu-id="8c97e-195">Beispiel</span><span class="sxs-lookup"><span data-stu-id="8c97e-195">Example</span></span>  
 <span data-ttu-id="8c97e-196">Im folgenden Beispiel wird das Verhalten der Snapshot-Isolation beim Ändern von Daten gezeigt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-196">The following example demonstrates the behavior of snapshot isolation when data is being modified.</span></span> <span data-ttu-id="8c97e-197">Der Code führt die folgenden Aktionen aus:</span><span class="sxs-lookup"><span data-stu-id="8c97e-197">The code performs the following actions:</span></span>  
  
- <span data-ttu-id="8c97e-198">Stellt eine Verbindung zur **AdventureWorks** -Beispieldatenbank her und aktiviert die Momentaufnahme Isolation.</span><span class="sxs-lookup"><span data-stu-id="8c97e-198">Connects to the **AdventureWorks** sample database and enables SNAPSHOT isolation.</span></span>  
  
- <span data-ttu-id="8c97e-199">Erstellt eine Tabelle mit **dem Namen TestSnapshotUpdate** und fügt drei Zeilen mit Beispiel Daten ein.</span><span class="sxs-lookup"><span data-stu-id="8c97e-199">Creates a table named **TestSnapshotUpdate** and inserts three rows of sample data.</span></span>  
  
- <span data-ttu-id="8c97e-200">Startet sqlTransaction1 mit einer SNAPSHOT-Isolation, stellt diese aber nicht fertig.</span><span class="sxs-lookup"><span data-stu-id="8c97e-200">Begins, but does not complete, sqlTransaction1 using SNAPSHOT isolation.</span></span> <span data-ttu-id="8c97e-201">In der Transaktion werden drei Zeilen mit Daten ausgewählt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-201">Three rows of data are selected in the transaction.</span></span>  
  
- <span data-ttu-id="8c97e-202">Erstellt eine zweite **SqlConnection** zu **AdventureWorks** und erstellt eine zweite Transaktion mit der Isolationsstufe Read Commit, die einen Wert in einer der in sqlTransaction1 ausgewählten Zeilen aktualisiert.</span><span class="sxs-lookup"><span data-stu-id="8c97e-202">Creates a second **SqlConnection** to **AdventureWorks** and creates a second transaction using the READ COMMITTED isolation level that updates a value in one of the rows selected in sqlTransaction1.</span></span>  
  
- <span data-ttu-id="8c97e-203">Führt einen Commit für sqlTransaction2 durch.</span><span class="sxs-lookup"><span data-stu-id="8c97e-203">Commits sqlTransaction2.</span></span>  
  
- <span data-ttu-id="8c97e-204">Kehrt zu sqlTransaction1 zurück und versucht, dieselbe Zeile zu aktualisieren, für die sqlTransaction1 bereits einen Commit durchgeführt hat.</span><span class="sxs-lookup"><span data-stu-id="8c97e-204">Returns to sqlTransaction1 and attempts to update the same row that sqlTransaction1 already committed.</span></span> <span data-ttu-id="8c97e-205">Der Fehler 3960 wird ausgelöst, und sqlTransaction1 wird automatisch zurückgenommen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-205">Error 3960 is raised, and sqlTransaction1 is rolled back automatically.</span></span> <span data-ttu-id="8c97e-206">Die **SqlException. Number** und **SqlException. Message** werden im Konsolenfenster angezeigt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-206">The **SqlException.Number** and **SqlException.Message** are displayed in the Console window.</span></span>  
  
- <span data-ttu-id="8c97e-207">Führt einen Bereinigungs Code aus, um die Momentaufnahme Isolation in **AdventureWorks** zu deaktivieren und die **TestSnapshotUpdate** -Tabelle zu löschen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-207">Executes clean-up code to turn off snapshot isolation in **AdventureWorks** and delete the **TestSnapshotUpdate** table.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/VB/source.vb#1)]  
  
### <a name="using-lock-hints-with-snapshot-isolation"></a><span data-ttu-id="8c97e-208">Verwenden von Sperrhinweisen mit der Snapshot-Isolation</span><span class="sxs-lookup"><span data-stu-id="8c97e-208">Using Lock Hints with Snapshot Isolation</span></span>  
 <span data-ttu-id="8c97e-209">Im vorigen Beispiel wählt die erste Transaktion Daten aus, und eine zweite Transaktion aktualisiert die Daten, bevor die erste Transaktion beendet werden kann, wodurch ein Updatekonflikt entsteht, wenn die erste Transaktion versucht, dieselbe Zeile zu aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="8c97e-209">In the previous example, the first transaction selects data, and a second transaction updates the data before the first transaction is able to complete, causing an update conflict when the first transaction tries to update the same row.</span></span> <span data-ttu-id="8c97e-210">Sie können die Gefahr von Updatekonflikten in Snapshot-Transaktionen mit langen Laufzeiten reduzieren, indem Sie zu Beginn der Transaktionen Sperrhinweise bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="8c97e-210">You can reduce the chance of update conflicts in long-running snapshot transactions by supplying lock hints at the beginning of the transaction.</span></span> <span data-ttu-id="8c97e-211">In der folgenden SELECT-Anweisung wird der UPDLOCK-Hinweis zum Sperren der ausgewählten Zeilen verwendet:</span><span class="sxs-lookup"><span data-stu-id="8c97e-211">The following SELECT statement uses the UPDLOCK hint to lock the selected rows:</span></span>  
  
```sql  
SELECT * FROM TestSnapshotUpdate WITH (UPDLOCK)   
  WHERE PriKey BETWEEN 1 AND 3  
```  
  
 <span data-ttu-id="8c97e-212">Mit dem UPDLOCK-Sperrhinweis werden alle Zeilen blockiert, die versuchen, die Zeilen vor dem Fertigstellen der ersten Transaktion zu aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="8c97e-212">Using the UPDLOCK lock hint blocks any rows attempting to update the rows before the first transaction completes.</span></span> <span data-ttu-id="8c97e-213">Dadurch wird gewährleistet, dass die ausgewählten Zeilen fehlerfrei sind, wenn sie später in der Transaktion aktualisiert werden.</span><span class="sxs-lookup"><span data-stu-id="8c97e-213">This guarantees that the selected rows have no conflicts when they are updated later in the transaction.</span></span> <span data-ttu-id="8c97e-214">Weitere Informationen finden Sie in der Onlinedokumentation zu SQL Server unter "Locking Hints".</span><span class="sxs-lookup"><span data-stu-id="8c97e-214">See "Locking Hints" in SQL Server Books Online.</span></span>  
  
 <span data-ttu-id="8c97e-215">Wenn eine Anwendung viele Konflikte aufweist, stellt die Snapshot-Isolation möglicherweise nicht die optimale Vorgehensweise dar.</span><span class="sxs-lookup"><span data-stu-id="8c97e-215">If your application has many conflicts, snapshot isolation may not be the best choice.</span></span> <span data-ttu-id="8c97e-216">Hinweise sollten nur verwendet werden, wenn sie wirklich erforderlich sind.</span><span class="sxs-lookup"><span data-stu-id="8c97e-216">Hints should only be used when really needed.</span></span> <span data-ttu-id="8c97e-217">Eine Anwendung sollte nicht so erstellt werden, dass ihre Ausführung stets von Sperrhinweisen abhängt.</span><span class="sxs-lookup"><span data-stu-id="8c97e-217">Your application should not be designed so that it constantly relies on lock hints for its operation.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="8c97e-218">Siehe auch</span><span class="sxs-lookup"><span data-stu-id="8c97e-218">See also</span></span>

- [<span data-ttu-id="8c97e-219">SQL Server und ADO.NET</span><span class="sxs-lookup"><span data-stu-id="8c97e-219">SQL Server and ADO.NET</span></span>](index.md)
- [<span data-ttu-id="8c97e-220">Übersicht über ADO.NET</span><span class="sxs-lookup"><span data-stu-id="8c97e-220">ADO.NET Overview</span></span>](../ado-net-overview.md)
- [<span data-ttu-id="8c97e-221">Handbuch zu Transaktions Sperren und Zeilen Versionsverwaltung</span><span class="sxs-lookup"><span data-stu-id="8c97e-221">Transaction Locking and Row Versioning Guide</span></span>](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide)
