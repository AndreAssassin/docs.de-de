---
title: Momentaufnahmenisolation in SQL Server
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 43ae5dd3-50f5-43a8-8d01-e37a61664176
ms.openlocfilehash: 8313ffc8eef70c1e5efc24b09a160edb7cec1595
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 03/12/2020
ms.locfileid: "79174263"
---
# <a name="snapshot-isolation-in-sql-server"></a><span data-ttu-id="36e1f-102">Momentaufnahmenisolation in SQL Server</span><span class="sxs-lookup"><span data-stu-id="36e1f-102">Snapshot Isolation in SQL Server</span></span>
<span data-ttu-id="36e1f-103">Die Momentaufnahmenisolation verbessert die Parallelität für OLTP-Anwendungen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-103">Snapshot isolation enhances concurrency for OLTP applications.</span></span>  
  
## <a name="understanding-snapshot-isolation-and-row-versioning"></a><span data-ttu-id="36e1f-104">Informationen zur Snapshot-Isolation und Zeilenversionserstellung</span><span class="sxs-lookup"><span data-stu-id="36e1f-104">Understanding Snapshot Isolation and Row Versioning</span></span>  
 <span data-ttu-id="36e1f-105">Sobald die Snapshot-Isolation aktiviert ist, müssen aktualisierte Zeilenversionen für jede Transaktion beibehalten werden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-105">Once snapshot isolation is enabled, updated row versions for each transaction must be maintained.</span></span>  <span data-ttu-id="36e1f-106">Vor SQL Server 2019 wurden diese Versionen in **tempdb**gespeichert.</span><span class="sxs-lookup"><span data-stu-id="36e1f-106">Prior to SQL Server 2019, these versions were stored in **tempdb**.</span></span> <span data-ttu-id="36e1f-107">SQL Server 2019 führt eine neue Funktion ein, Accelerated Database Recovery (ADR), die einen eigenen Satz von Zeilenversionen erfordert.</span><span class="sxs-lookup"><span data-stu-id="36e1f-107">SQL Server 2019 introduces a new feature, Accelerated Database Recovery (ADR) which requires its own set of row versions.</span></span>  <span data-ttu-id="36e1f-108">Wenn Also ab SQL Server 2019 ADR nicht aktiviert ist, werden Zeilenversionen wie immer in **tempdb** beibehalten.</span><span class="sxs-lookup"><span data-stu-id="36e1f-108">So, as of SQL Server 2019, if ADR is not enabled, row versions are kept in **tempdb** as always.</span></span>  <span data-ttu-id="36e1f-109">Wenn ADR aktiviert ist, werden alle Zeilenversionen, die sich beide auf die Snapshot-Isolation und ADR beziehen, im Persistent Version Store (PVS) von ADR gespeichert, der sich in der Benutzerdatenbank in einer Dateigruppe befindet, die der Benutzer angibt.</span><span class="sxs-lookup"><span data-stu-id="36e1f-109">If ADR is enabled, then all row versions, both related to snapshot isolation and ADR, are kept in ADR's Persistent Version Store (PVS), which is located in the user database in a filegroup which the user specifies.</span></span> <span data-ttu-id="36e1f-110">Eine eindeutige Transaktionssequenznummer identifiziert jede Transaktion, wobei diese eindeutigen Nummern für jede Zeilenversion aufgezeichnet werden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-110">A unique transaction sequence number identifies each transaction, and these unique numbers are recorded for each row version.</span></span> <span data-ttu-id="36e1f-111">Die Transaktion arbeitet mit den neuesten Zeilenversionen, die eine Sequenznummer vor der Sequenznummer der Transaktion haben.</span><span class="sxs-lookup"><span data-stu-id="36e1f-111">The transaction works with the most recent row versions having a sequence number before the sequence number of the transaction.</span></span> <span data-ttu-id="36e1f-112">Neuere Zeilenversionen, die nach Beginn der Transaktion erstellt wurden, werden von der Transaktion ignoriert.</span><span class="sxs-lookup"><span data-stu-id="36e1f-112">Newer row versions created after the transaction has begun are ignored by the transaction.</span></span>  
  
 <span data-ttu-id="36e1f-113">Der Begriff „Momentaufnahme“ spiegelt die Tatsache wider, dass alle Abfragen in der Transaktion die gleiche Version bzw. Momentaufnahme der Datenbank sehen, und zwar basierend auf dem Zustand der Datenbank zum Zeitpunkt des Transaktionsbeginns.</span><span class="sxs-lookup"><span data-stu-id="36e1f-113">The term "snapshot" reflects the fact that all queries in the transaction see the same version, or snapshot, of the database, based on the state of the database at the moment in time when the transaction begins.</span></span> <span data-ttu-id="36e1f-114">In einer Snapshot-Transaktion werden für die zugrunde liegenden Datenzeilen oder Datenseiten keine Sperren bezogen, wodurch andere Transaktionen ausgeführt werden können, ohne durch eine vorherige, nicht vollständig ausgeführte Transaktion blockiert zu werden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-114">No locks are acquired on the underlying data rows or data pages in a snapshot transaction, which permits other transactions to execute without being blocked by a prior uncompleted transaction.</span></span> <span data-ttu-id="36e1f-115">Transaktionen, die Daten ändern, blockieren keine Transaktionen, die Daten lesen. Transaktionen, die Daten lesen, blockieren keine Transaktionen, die Daten schreiben. Dies ist bei der Standardisolationsstufe READ COMMITTED in SQL Server normalerweise der Fall.</span><span class="sxs-lookup"><span data-stu-id="36e1f-115">Transactions that modify data do not block transactions that read data, and transactions that read data do not block transactions that write data, as they normally would under the default READ COMMITTED isolation level in SQL Server.</span></span> <span data-ttu-id="36e1f-116">Dieses nicht blockierende Verhalten verringert auch beträchtlich die Wahrscheinlichkeit für Deadlocks bei komplexen Transaktionen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-116">This non-blocking behavior also significantly reduces the likelihood of deadlocks for complex transactions.</span></span>  
  
 <span data-ttu-id="36e1f-117">Für die Momentaufnahmenisolation wird ein optimistisches Parallelitätsmodell verwendet.</span><span class="sxs-lookup"><span data-stu-id="36e1f-117">Snapshot isolation uses an optimistic concurrency model.</span></span> <span data-ttu-id="36e1f-118">Wenn eine Momentaufnahmentransaktion versucht, Änderungen an Daten zu committen, die sich seit Beginn der Transaktion geändert haben, wird die Transaktion rückgängig gemacht und ein Fehler ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="36e1f-118">If a snapshot transaction attempts to commit modifications to data that has changed since the transaction began, the transaction will roll back and an error will be raised.</span></span> <span data-ttu-id="36e1f-119">Sie können dies vermeiden, indem Sie UPDLOCK-Hinweise für SELECT-Anweisungen verwenden, die auf zu ändernde Daten zugreifen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-119">You can avoid this by using UPDLOCK hints for SELECT statements that access data to be modified.</span></span> <span data-ttu-id="36e1f-120">Weitere Informationen finden Sie in der SQL Server-Onlinedokumentation unter „Sperrhinweise“.</span><span class="sxs-lookup"><span data-stu-id="36e1f-120">See "Locking Hints" in SQL Server Books Online for more information.</span></span>  
  
 <span data-ttu-id="36e1f-121">Die Momentaufnahmenisolation muss durch Festlegen der Datenbankoption ALLOW_SNAPSHOT_ISOLATION ON aktiviert werden, bevor sie in Transaktionen verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="36e1f-121">Snapshot isolation must be enabled by setting the ALLOW_SNAPSHOT_ISOLATION ON database option before it is used in transactions.</span></span> <span data-ttu-id="36e1f-122">Dadurch wird der Mechanismus zum Speichern von Zeilenversionen in der temporären Datenbank (**tempdb**) aktiviert.</span><span class="sxs-lookup"><span data-stu-id="36e1f-122">This activates the mechanism for storing row versions in the temporary database (**tempdb**).</span></span> <span data-ttu-id="36e1f-123">Sie müssen die Momentaufnahmenisolation in jeder Datenbank aktivieren, die sie mit der Transact-SQL-Anweisung ALTER DATABASE verwendet.</span><span class="sxs-lookup"><span data-stu-id="36e1f-123">You must enable snapshot isolation in each database that uses it with the Transact-SQL ALTER DATABASE statement.</span></span> <span data-ttu-id="36e1f-124">In dieser Hinsicht unterscheidet sich die Momentaufnahmenisolation von den herkömmlichen Isolationsstufen READ COMMITTED, REPEATABLE READ, SERIALIZABLE und READ UNCOMMITTED, die keine Konfiguration erfordern.</span><span class="sxs-lookup"><span data-stu-id="36e1f-124">In this respect, snapshot isolation differs from the traditional isolation levels of READ COMMITTED, REPEATABLE READ, SERIALIZABLE, and READ UNCOMMITTED, which require no configuration.</span></span> <span data-ttu-id="36e1f-125">Die folgenden Anweisungen aktivieren die Momentaufnahmenisolation und ersetzen das Standardverhalten von READ COMMITTED durch SNAPSHOT:</span><span class="sxs-lookup"><span data-stu-id="36e1f-125">The following statements activate snapshot isolation and replace the default READ COMMITTED behavior with SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE MyDatabase  
SET ALLOW_SNAPSHOT_ISOLATION ON  
  
ALTER DATABASE MyDatabase  
SET READ_COMMITTED_SNAPSHOT ON  
```  
  
 <span data-ttu-id="36e1f-126">Das Festlegen der Option READ_COMMITTED_SNAPSHOT auf ON ermöglicht den Zugriff auf Zeilen mit Versionsangabe unter der Standardisolationsstufe READ_COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="36e1f-126">Setting the READ_COMMITTED_SNAPSHOT ON option allows access to versioned rows under the default READ COMMITTED isolation level.</span></span> <span data-ttu-id="36e1f-127">Wenn die Option READ_COMMITTED_SNAPSHOT auf OFF festgelegt ist, müssen Sie die Isolationsstufe für Momentaufnahmen für jede Sitzung explizit festlegen, um auf Zeilen mit Versionsangabe zugreifen zu können.</span><span class="sxs-lookup"><span data-stu-id="36e1f-127">If the READ_COMMITTED_SNAPSHOT option is set to OFF, you must explicitly set the Snapshot isolation level for each session in order to access versioned rows.</span></span>  
  
## <a name="managing-concurrency-with-isolation-levels"></a><span data-ttu-id="36e1f-128">Verwalten von Parallelität mit Isolationsstufen</span><span class="sxs-lookup"><span data-stu-id="36e1f-128">Managing Concurrency with Isolation Levels</span></span>  
 <span data-ttu-id="36e1f-129">Die Isolationsstufe, auf der eine Transact-SQL-Anweisung ausgeführt wird, bestimmt ihr Sperr- und Zeilenversionsverwaltungs-Verhalten.</span><span class="sxs-lookup"><span data-stu-id="36e1f-129">The isolation level under which a Transact-SQL statement executes determines its locking and row versioning behavior.</span></span> <span data-ttu-id="36e1f-130">Eine Isolationsstufe gilt verbindungsweit. Sobald sie für eine Verbindung mit der Anweisung SET TRANSACTION ISOLATION LEVEL festgelegt wurde, bleibt sie in Kraft, bis die Verbindung geschlossen oder eine andere Isolationsstufe festgelegt wird.</span><span class="sxs-lookup"><span data-stu-id="36e1f-130">An isolation level has connection-wide scope, and once set for a connection with the SET TRANSACTION ISOLATION LEVEL statement, it remains in effect until the connection is closed or another isolation level is set.</span></span> <span data-ttu-id="36e1f-131">Wenn eine Verbindung geschlossen und an den Pool zurückgegeben wird, wird die Isolationsstufe der letzten SET TRANSACTION ISOLATION LEVEL-Anweisung beibehalten.</span><span class="sxs-lookup"><span data-stu-id="36e1f-131">When a connection is closed and returned to the pool, the isolation level from the last SET TRANSACTION ISOLATION LEVEL statement is retained.</span></span> <span data-ttu-id="36e1f-132">Nachfolgende Verbindungen, die eine Verbindung im Pool wiederverwenden, arbeiten mit der Isolationsstufe, die zum Zeitpunkt des Hinzufügens zum Pool in Kraft war.</span><span class="sxs-lookup"><span data-stu-id="36e1f-132">Subsequent connections reusing a pooled connection use the isolation level that was in effect at the time the connection is pooled.</span></span>  
  
 <span data-ttu-id="36e1f-133">Einzelne innerhalb einer Verbindung gestellte Abfragen können Sperrhinweise enthalten, die die Isolation für eine einzelne Anweisung oder Transaktion ändern, aber die Isolationsstufe der Verbindung nicht beeinflussen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-133">Individual queries issued within a connection can contain lock hints that modify the isolation for a single statement or transaction but do not affect the isolation level of the connection.</span></span> <span data-ttu-id="36e1f-134">In gespeicherten Prozeduren oder Funktionen festgelegte Isolationsstufen oder Sperrhinweise ändern die Isolationsstufe der Verbindung, die sie aufruft, nicht und sind nur für die Dauer des Aufrufs der gespeicherten Prozedur oder Funktion wirksam.</span><span class="sxs-lookup"><span data-stu-id="36e1f-134">Isolation levels or lock hints set in stored procedures or functions do not change the isolation level of the connection that calls them and are in effect only for the duration of the stored procedure or function call.</span></span>  
  
 <span data-ttu-id="36e1f-135">In frühen Versionen von SQL Server wurden vier im Standard SQL-92 definierte Isolationsstufen unterstützt:</span><span class="sxs-lookup"><span data-stu-id="36e1f-135">Four isolation levels defined in the SQL-92 standard were supported in early versions of SQL Server:</span></span>  
  
- <span data-ttu-id="36e1f-136">READ UNCOMMITTED ist die am wenigsten restriktive Isolationsstufe, da sie Sperren ignoriert, die von anderen Transaktionen aktiviert wurden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-136">READ UNCOMMITTED is the least restrictive isolation level because it ignores locks placed by other transactions.</span></span> <span data-ttu-id="36e1f-137">Transaktionen, die unter READ UNCOMMITTED ausgeführt werden, können geänderte Datenwerte lesen, die noch nicht von anderen Transaktionen committet wurden. Diese werden als „Dirty Reads“ bezeichnet.</span><span class="sxs-lookup"><span data-stu-id="36e1f-137">Transactions executing under READ UNCOMMITTED can read modified data values that have not yet been committed by other transactions; these are called "dirty" reads.</span></span>  
  
- <span data-ttu-id="36e1f-138">Die Standardisolationsstufe für SQL Server ist READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="36e1f-138">READ COMMITTED is the default isolation level for SQL Server.</span></span> <span data-ttu-id="36e1f-139">Sie verhindert Dirty Reads, indem sie festlegt, dass Anweisungen keine Datenwerte lesen können, die zwar geändert, aber noch nicht von anderen Transaktionen committet wurden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-139">It prevents dirty reads by specifying that statements cannot read data values that have been modified but not yet committed by other transactions.</span></span> <span data-ttu-id="36e1f-140">Andere Transaktionen können nach wie vor Daten zwischen der Ausführung einzelner Anweisungen innerhalb der aktuellen Transaktion ändern, einfügen oder löschen, was zu nicht wiederholbaren Lesevorgängen oder „Phantomdaten“ führt.</span><span class="sxs-lookup"><span data-stu-id="36e1f-140">Other transactions can still modify, insert, or delete data between executions of individual statements within the current transaction, resulting in non-repeatable reads, or "phantom" data.</span></span>  
  
- <span data-ttu-id="36e1f-141">REPEATABLE READ ist eine restriktivere Isolationsstufe als READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="36e1f-141">REPEATABLE READ is a more restrictive isolation level than READ COMMITTED.</span></span> <span data-ttu-id="36e1f-142">Sie umfasst READ COMMITTED und legt zusätzlich fest, dass keine anderen Transaktionen Daten, die von der aktuellen Transaktion gelesen wurden, ändern oder löschen können, bis die aktuelle Transaktion committet wurde.</span><span class="sxs-lookup"><span data-stu-id="36e1f-142">It encompasses READ COMMITTED and additionally specifies that no other transactions can modify or delete data that has been read by the current transaction until the current transaction commits.</span></span> <span data-ttu-id="36e1f-143">Die Parallelität ist geringer als bei READ COMMITTED, da gemeinsame Sperren für gelesene Daten für die Dauer der Transaktion bestehen bleiben, anstatt am Ende jeder Anweisung freigegeben zu werden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-143">Concurrency is lower than for READ COMMITTED because shared locks on read data are held for the duration of the transaction instead of being released at the end of each statement.</span></span>  
  
- <span data-ttu-id="36e1f-144">SERIALIZABLE ist die restriktivste Isolationsstufe, da gesamte Schlüsselbereiche gesperrt werden, und die Sperren bis zum Abschluss der Transaktion aufrechterhalten werden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-144">SERIALIZABLE is the most restrictive isolation level, because it locks entire ranges of keys and holds the locks until the transaction is complete.</span></span> <span data-ttu-id="36e1f-145">Sie umfasst REPEATABLE READ und fügt die Einschränkung hinzu, dass andere Transaktionen keine neuen Zeilen in Bereiche einfügen können, die von der Transaktion gelesen wurden, bis die Transaktion abgeschlossen ist.</span><span class="sxs-lookup"><span data-stu-id="36e1f-145">It encompasses REPEATABLE READ and adds the restriction that other transactions cannot insert new rows into ranges that have been read by the transaction until the transaction is complete.</span></span>  
  
 <span data-ttu-id="36e1f-146">Weitere Informationen finden Sie im [Handbuch zu Transaktionssperren und Zeilenversionsverwaltung](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span><span class="sxs-lookup"><span data-stu-id="36e1f-146">For more information, refer to the [Transaction Locking and Row Versioning Guide](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span></span>  
  
### <a name="snapshot-isolation-level-extensions"></a><span data-ttu-id="36e1f-147">Snapshot-Isolationsstufenerweiterungen</span><span class="sxs-lookup"><span data-stu-id="36e1f-147">Snapshot Isolation Level Extensions</span></span>  
 <span data-ttu-id="36e1f-148">SQL Server hat Erweiterungen für die SQL-92-Isolationsgrade eingeführt, zu denen der SNAPSHOT-Isolationsgrad und eine zusätzliche Implementierung von READ COMMITTED gehört.</span><span class="sxs-lookup"><span data-stu-id="36e1f-148">SQL Server introduced extensions to the SQL-92 isolation levels with the introduction of the SNAPSHOT isolation level and an additional implementation of READ COMMITTED.</span></span> <span data-ttu-id="36e1f-149">Der READ_COMMITTED_SNAPSHOT-Isolationsgrad kann auf transparente Weise READ COMMITTED für alle Transaktionen ersetzen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-149">The READ_COMMITTED_SNAPSHOT isolation level can transparently replace READ COMMITTED for all transactions.</span></span>  
  
- <span data-ttu-id="36e1f-150">Die SNAPSHOT-Isolation legt fest, dass Daten, die innerhalb einer Transaktion gelesen werden, niemals Änderungen widerspiegeln, die durch andere gleichzeitige Transaktionen vorgenommen wurden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-150">SNAPSHOT isolation specifies that data read within a transaction will never reflect changes made by other simultaneous transactions.</span></span> <span data-ttu-id="36e1f-151">Die Transaktion verwendet die Datenzeilenversionen, die zu Beginn der Transaktion vorhanden sind.</span><span class="sxs-lookup"><span data-stu-id="36e1f-151">The transaction uses the data row versions that exist when the transaction begins.</span></span> <span data-ttu-id="36e1f-152">Beim Lesen werden keine Sperren für die Daten aktiviert, sodass SNAPSHOT-Transaktionen andere Transaktionen nicht am Schreiben von Daten hindern.</span><span class="sxs-lookup"><span data-stu-id="36e1f-152">No locks are placed on the data when it is read, so SNAPSHOT transactions do not block other transactions from writing data.</span></span> <span data-ttu-id="36e1f-153">Transaktionen, die Daten schreiben, halten SNAPSHOT-Transaktionen nicht vom Lesen von Daten ab.</span><span class="sxs-lookup"><span data-stu-id="36e1f-153">Transactions that write data do not block snapshot transactions from reading data.</span></span> <span data-ttu-id="36e1f-154">Sie müssen die Momentaufnahmenisolation durch Festlegen der Datenbankoption ALLOW_SNAPSHOT_ISOLATION aktivieren, um sie verwenden zu können.</span><span class="sxs-lookup"><span data-stu-id="36e1f-154">You need to enable snapshot isolation by setting the ALLOW_SNAPSHOT_ISOLATION database option in order to use it.</span></span>  
  
- <span data-ttu-id="36e1f-155">Die Datenbankoption READ_COMMITTED_SNAPSHOT bestimmt das Verhalten der Standardisolationsstufe READ COMMITTED, wenn die Momentaufnahmenisolation in einer Datenbank aktiviert ist.</span><span class="sxs-lookup"><span data-stu-id="36e1f-155">The READ_COMMITTED_SNAPSHOT database option determines the behavior of the default READ COMMITTED isolation level when snapshot isolation is enabled in a database.</span></span> <span data-ttu-id="36e1f-156">Wenn Sie ON für READ_COMMITTED_SNAPSHOT nicht explizit angeben, gilt READ COMMITTED für alle impliziten Transaktionen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-156">If you do not explicitly specify READ_COMMITTED_SNAPSHOT ON, READ COMMITTED is applied to all implicit transactions.</span></span> <span data-ttu-id="36e1f-157">Dies führt zum selben Verhalten wie das Festlegen von READ_COMMITTED_SNAPSHOT auf OFF (Standard).</span><span class="sxs-lookup"><span data-stu-id="36e1f-157">This produces the same behavior as setting READ_COMMITTED_SNAPSHOT OFF (the default).</span></span> <span data-ttu-id="36e1f-158">Wenn OFF für READ_COMMITTED_SNAPSHOT aktiviert ist, verwendet die Datenbank-Engine gemeinsame Sperren, um die Standardisolationsstufe zu erzwingen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-158">When READ_COMMITTED_SNAPSHOT OFF is in effect, the Database Engine uses shared locks to enforce the default isolation level.</span></span> <span data-ttu-id="36e1f-159">Wenn Sie die Datenbankoption READ_COMMITTED_SNAPSHOT auf ON festlegen, verwendet die Datenbank-Engine standardmäßig die Zeilenversionsverwaltung und Momentaufnahmenisolation, anstatt Sperren zum Schutz der Daten einzusetzen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-159">If you set the READ_COMMITTED_SNAPSHOT database option to ON, the database engine uses row versioning and snapshot isolation as the default, instead of using locks to protect the data.</span></span>  
  
## <a name="how-snapshot-isolation-and-row-versioning-work"></a><span data-ttu-id="36e1f-160">Funktionsweise der Snapshot-Isolation und der Zeilenversionserstellung</span><span class="sxs-lookup"><span data-stu-id="36e1f-160">How Snapshot Isolation and Row Versioning Work</span></span>  
 <span data-ttu-id="36e1f-161">Wenn die SNAPSHOT-Isolationsstufe aktiviert ist, speichert die SQL Server-Datenbank-Engine bei jedem Aktualisieren einer Zeile eine Kopie der Ursprungszeile in **tempdb** und fügt der Zeile eine Transaktionsfolgenummer hinzu.</span><span class="sxs-lookup"><span data-stu-id="36e1f-161">When the SNAPSHOT isolation level is enabled, each time a row is updated, the SQL Server Database Engine stores a copy of the original row in **tempdb**, and adds a transaction sequence number to the row.</span></span> <span data-ttu-id="36e1f-162">Es folgt die Abfolge der eintretenden Ereignisse:</span><span class="sxs-lookup"><span data-stu-id="36e1f-162">The following is the sequence of events that occurs:</span></span>  
  
- <span data-ttu-id="36e1f-163">Eine neue Transaktion wird eingeleitet, der eine Transaktionssequenznummer zugewiesen wird.</span><span class="sxs-lookup"><span data-stu-id="36e1f-163">A new transaction is initiated, and it is assigned a transaction sequence number.</span></span>  
  
- <span data-ttu-id="36e1f-164">Die Datenbank-Engine liest eine Zeile innerhalb der Transaktion und ruft die Zeilenversion von **tempdb** ab, deren Nummer kleiner ist als die Transaktionsfolgenummer und gleichzeitig am nächsten bei dieser liegt.</span><span class="sxs-lookup"><span data-stu-id="36e1f-164">The Database Engine reads a row within the transaction and retrieves the row version from **tempdb** whose sequence number is closest to, and lower than, the transaction sequence number.</span></span>  
  
- <span data-ttu-id="36e1f-165">Die Datenbank-Engine prüft, ob die Transaktionssequenznummer nicht in der Liste der Transaktionssequenznummern der nicht committeten Transaktionen enthalten ist, die beim Start der Momentaufnahmentransaktion aktiv waren.</span><span class="sxs-lookup"><span data-stu-id="36e1f-165">The Database Engine checks to see if the transaction sequence number is not in the list of transaction sequence numbers of the uncommitted transactions active when the snapshot transaction started.</span></span>  
  
- <span data-ttu-id="36e1f-166">Die Transaktion liest in **tempdb** die Version der Zeile, die beim Start der Transaktion aktuell war.</span><span class="sxs-lookup"><span data-stu-id="36e1f-166">The transaction reads the version of the row from **tempdb** that was current as of the start of the transaction.</span></span> <span data-ttu-id="36e1f-167">Es werden keine neuen Zeilen eingefügt, nachdem die Transaktion gestartet wurde, da diese Sequenznummernwerte höher als der Wert der Transaktionssequenznummer sind.</span><span class="sxs-lookup"><span data-stu-id="36e1f-167">It will not see new rows inserted after the transaction was started because those sequence number values will be higher than the value of the transaction sequence number.</span></span>  
  
- <span data-ttu-id="36e1f-168">Die aktuelle Transaktion erfasst Zeilen, die nach dem Start der Transaktion gelöscht wurden, weil in **tempdb** eine Zeilenversion mit niedrigerem Folgenummernwert vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="36e1f-168">The current transaction will see rows that were deleted after the transaction began, because there will be a row version in **tempdb** with a lower sequence number value.</span></span>  
  
 <span data-ttu-id="36e1f-169">Der Nutzeffekt der Momentaufnahmenisolation besteht darin, dass die Transaktion alle Daten so sieht, wie sie zu Beginn der Transaktion vorhanden waren, ohne die zugrunde liegenden Tabellen zu berücksichtigen oder zu sperren.</span><span class="sxs-lookup"><span data-stu-id="36e1f-169">The net effect of snapshot isolation is that the transaction sees all of the data as it existed at the start of the transaction, without honoring or placing any locks on the underlying tables.</span></span> <span data-ttu-id="36e1f-170">Dies kann in Konfliktsituationen zu Leistungsverbesserungen führen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-170">This can result in performance improvements in situations where there is contention.</span></span>  
  
 <span data-ttu-id="36e1f-171">Eine Momentaufnahmentransaktion verwendet immer eine optimistische Parallelitätssteuerung, wobei alle Sperren zurückgehalten werden, die andere Transaktionen an der Aktualisierung von Zeilen hindern würden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-171">A snapshot transaction always uses optimistic concurrency control, withholding any locks that would prevent other transactions from updating rows.</span></span> <span data-ttu-id="36e1f-172">Wenn eine Momentaufnahmentransaktion versucht, eine Aktualisierung einer Zeile zu committen, die nach Beginn der Transaktion geändert wurde, wird die Transaktion rückgängig gemacht und ein Fehler ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="36e1f-172">If a snapshot transaction attempts to commit an update to a row that was changed after the transaction began, the transaction is rolled back, and an error is raised.</span></span>  
  
## <a name="working-with-snapshot-isolation-in-adonet"></a><span data-ttu-id="36e1f-173">Verwenden der Snapshot-Isolation in ADO.NET</span><span class="sxs-lookup"><span data-stu-id="36e1f-173">Working with Snapshot Isolation in ADO.NET</span></span>  
 <span data-ttu-id="36e1f-174">Die Momentaufnahmenisolation wird in ADO.NET von der <xref:System.Data.SqlClient.SqlTransaction>-Klasse unterstützt.</span><span class="sxs-lookup"><span data-stu-id="36e1f-174">Snapshot isolation is supported in ADO.NET by the <xref:System.Data.SqlClient.SqlTransaction> class.</span></span> <span data-ttu-id="36e1f-175">Wenn eine Datenbank für die Snapshot-Isolation aktiviert, aber nicht für READ_COMMITTED_SNAPSHOT ON konfiguriert wurde, müssen Sie eine <xref:System.Data.SqlClient.SqlTransaction> mit dem **IsolationLevel.Snapshot**-Enumerationswert initiieren, wenn Sie die <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A>-Methode aufrufen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-175">If a database has been enabled for snapshot isolation but is not configured for READ_COMMITTED_SNAPSHOT ON, you must initiate a <xref:System.Data.SqlClient.SqlTransaction> using the **IsolationLevel.Snapshot** enumeration value when calling the <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="36e1f-176">Dieses Codefragment geht davon aus, dass die Verbindung ein geöffnetes <xref:System.Data.SqlClient.SqlConnection>-Objekt ist.</span><span class="sxs-lookup"><span data-stu-id="36e1f-176">This code fragment assumes that connection is an open <xref:System.Data.SqlClient.SqlConnection> object.</span></span>  
  
```vb  
Dim sqlTran As SqlTransaction = _  
  connection.BeginTransaction(IsolationLevel.Snapshot)  
```  
  
```csharp  
SqlTransaction sqlTran =
  connection.BeginTransaction(IsolationLevel.Snapshot);  
```  
  
### <a name="example"></a><span data-ttu-id="36e1f-177">Beispiel</span><span class="sxs-lookup"><span data-stu-id="36e1f-177">Example</span></span>  
 <span data-ttu-id="36e1f-178">Das folgende Beispiel veranschaulicht das Verhalten der verschiedenen Isolationsstufen beim Versuch, auf gesperrte Daten zuzugreifen. Es ist nicht für die Verwendung im Produktionscode vorgesehen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-178">The following example demonstrates how the different isolation levels behave by attempting to access locked data, and it is not intended to be used in production code.</span></span>  
  
 <span data-ttu-id="36e1f-179">Der Code stellt eine Verbindung mit der **AdventureWorks**-Beispieldatenbank in SQL Server her, erstellt die Tabelle **TestSnapshot** und fügt eine Datenzeile ein.</span><span class="sxs-lookup"><span data-stu-id="36e1f-179">The code connects to the **AdventureWorks** sample database in SQL Server and creates a table named **TestSnapshot** and inserts one row of data.</span></span> <span data-ttu-id="36e1f-180">Der Code verwendet die Transact-SQL-Anweisung ALTER DATABASE, um die Momentaufnahmenisolation für die Datenbank zu aktivieren. Die Option READ_COMMITTED_SNAPSHOT wird jedoch nicht festgelegt, sodass das Standardverhalten der Isolationsstufe READ_COMMITTED weiterhin gilt.</span><span class="sxs-lookup"><span data-stu-id="36e1f-180">The code uses the ALTER DATABASE Transact-SQL statement to turn on snapshot isolation for the database, but it does not set the READ_COMMITTED_SNAPSHOT option, leaving the default READ COMMITTED isolation-level behavior in effect.</span></span> <span data-ttu-id="36e1f-181">Der Code führt dann die folgenden Aktionen aus:</span><span class="sxs-lookup"><span data-stu-id="36e1f-181">The code then performs the following actions:</span></span>  
  
- <span data-ttu-id="36e1f-182">Er beginnt sqlTransaction1, ohne sie jedoch abzuschließen, die die Isolationsstufe SERIALIZABLE verwendet, um eine Aktualisierungstransaktion zu starten.</span><span class="sxs-lookup"><span data-stu-id="36e1f-182">It begins, but does not complete, sqlTransaction1, which uses the SERIALIZABLE isolation level to start an update transaction.</span></span> <span data-ttu-id="36e1f-183">Dies hat Auswirkungen auf das Sperren der Tabelle.</span><span class="sxs-lookup"><span data-stu-id="36e1f-183">This has the effect of locking the table.</span></span>  
  
- <span data-ttu-id="36e1f-184">Der Code öffnet eine zweite Verbindung und initiiert eine zweite Transaktion mit der SNAPSHOT-Isolationsstufe zum Lesen der Daten in der **TestSnapshot**-Tabelle.</span><span class="sxs-lookup"><span data-stu-id="36e1f-184">It opens a second connection and initiates a second transaction using the SNAPSHOT isolation level to read the data in the **TestSnapshot** table.</span></span> <span data-ttu-id="36e1f-185">Da die Momentaufnahmenisolation aktiviert ist, kann diese Transaktion die Daten lesen, die vor dem Start von sqlTransaction1 vorhanden waren.</span><span class="sxs-lookup"><span data-stu-id="36e1f-185">Because snapshot isolation is enabled, this transaction can read the data that existed before sqlTransaction1 started.</span></span>  
  
- <span data-ttu-id="36e1f-186">Der Code öffnet eine dritte Verbindung und leitet eine Transaktion mit der Isolationsstufe READ COMMITTED ein, um zu versuchen, die Daten in der Tabelle zu lesen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-186">It opens a third connection and initiates a transaction using the READ COMMITTED isolation level to attempt to read the data in the table.</span></span> <span data-ttu-id="36e1f-187">In diesem Fall kann der Code die Daten nicht lesen, da er nicht über die Sperren lesen kann, die in der ersten Transaktion für die Tabelle platziert wurden, und eine Zeitauferung. Das gleiche Ergebnis würde auftreten, wenn die Isolationsstufen REPEATABLE READ und SERIALIZABLE verwendet würden, da diese Isolationsstufen auch nicht über die in der ersten Transaktion platzierten Sperren lesen können.</span><span class="sxs-lookup"><span data-stu-id="36e1f-187">In this case, the code cannot read the data because it cannot read past the locks placed on the table in the first transaction and times out. The same result would occur if the REPEATABLE READ and SERIALIZABLE isolation levels were used because these isolation levels also cannot read past the locks placed in the first transaction.</span></span>  
  
- <span data-ttu-id="36e1f-188">Der Code öffnet eine vierte Verbindung und leitet eine Transaktion mit der Isolationsstufe READ UNCOMMITTED ein, die einen Dirty Read des nicht committeten Werts in sqlTransaction1 durchführt.</span><span class="sxs-lookup"><span data-stu-id="36e1f-188">It opens a fourth connection and initiates a transaction using the READ UNCOMMITTED isolation level, which performs a dirty read of the uncommitted value in sqlTransaction1.</span></span> <span data-ttu-id="36e1f-189">Dieser Wert ist möglicherweise nie wirklich in der Datenbank vorhanden, wenn die erste Transaktion nicht committet wird.</span><span class="sxs-lookup"><span data-stu-id="36e1f-189">This value may never actually exist in the database if the first transaction is not committed.</span></span>  
  
- <span data-ttu-id="36e1f-190">Der Code nimmt die erste Transaktion zurück und führt eine Bereinigung durch, indem er die **TestSnapshot**-Tabelle löscht und die Snapshot-Isolation für die **AdventureWorks**-Datenbank deaktiviert.</span><span class="sxs-lookup"><span data-stu-id="36e1f-190">It rolls back the first transaction and cleans up by deleting the **TestSnapshot** table and turning off snapshot isolation for the **AdventureWorks** database.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="36e1f-191">Die folgenden Beispiele verwenden dieselbe Verbindungszeichenfolge bei deaktiviertem Verbindungspooling.</span><span class="sxs-lookup"><span data-stu-id="36e1f-191">The following examples use the same connection string with connection pooling turned off.</span></span> <span data-ttu-id="36e1f-192">Wenn eine Verbindung in einem Pool vorhanden ist, wird durch das Zurücksetzen der Isolationsstufe die Isolationsstufe auf dem Server nicht zurückgesetzt.</span><span class="sxs-lookup"><span data-stu-id="36e1f-192">If a connection is pooled, resetting its isolation level does not reset the isolation level at the server.</span></span> <span data-ttu-id="36e1f-193">Infolgedessen beginnen nachfolgende Verbindungen, die dieselbe innere Poolverbindung verwenden, mit der Isolationsstufe, die auf die der Poolverbindung festgelegt ist.</span><span class="sxs-lookup"><span data-stu-id="36e1f-193">As a result, subsequent connections that use the same pooled inner connection start with their isolation levels set to that of the pooled connection.</span></span> <span data-ttu-id="36e1f-194">Eine Alternative zum Deaktivieren des Verbindungspoolings besteht darin, die Isolationsstufe für jede Verbindung explizit festzulegen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-194">An alternative to turning off connection pooling is to set the isolation level explicitly for each connection.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/VB/source.vb#1)]  
  
### <a name="example"></a><span data-ttu-id="36e1f-195">Beispiel</span><span class="sxs-lookup"><span data-stu-id="36e1f-195">Example</span></span>  
 <span data-ttu-id="36e1f-196">Das folgende Beispiel veranschaulicht das Verhalten der Momentaufnahmenisolation, wenn Daten geändert werden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-196">The following example demonstrates the behavior of snapshot isolation when data is being modified.</span></span> <span data-ttu-id="36e1f-197">Der Code führt die folgenden Aktionen aus:</span><span class="sxs-lookup"><span data-stu-id="36e1f-197">The code performs the following actions:</span></span>  
  
- <span data-ttu-id="36e1f-198">Herstellen einer Verbindung mit der **AdventureWorks**-Beispieldatenbank und Aktivieren der SNAPSHOT-Isolation.</span><span class="sxs-lookup"><span data-stu-id="36e1f-198">Connects to the **AdventureWorks** sample database and enables SNAPSHOT isolation.</span></span>  
  
- <span data-ttu-id="36e1f-199">Erstellen der Tabelle **TestSnapshotUpdate** und Einfügen von drei Zeilen mit Beispieldaten.</span><span class="sxs-lookup"><span data-stu-id="36e1f-199">Creates a table named **TestSnapshotUpdate** and inserts three rows of sample data.</span></span>  
  
- <span data-ttu-id="36e1f-200">sqlTransaction1 wird mit SNAPSHOT-Isolation gestartet, aber nicht abgeschlossen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-200">Begins, but does not complete, sqlTransaction1 using SNAPSHOT isolation.</span></span> <span data-ttu-id="36e1f-201">In der Transaktion sind drei Datenzeilen ausgewählt.</span><span class="sxs-lookup"><span data-stu-id="36e1f-201">Three rows of data are selected in the transaction.</span></span>  
  
- <span data-ttu-id="36e1f-202">Erstellt eine zweite **SqlConnection** mit **AdventureWorks** und erstellt eine zweite Transaktion mit der READ COMMITTED-Isolationsstufe, die einen Wert in einer der in sqlTransaction1 ausgewählten Zeilen aktualisiert.</span><span class="sxs-lookup"><span data-stu-id="36e1f-202">Creates a second **SqlConnection** to **AdventureWorks** and creates a second transaction using the READ COMMITTED isolation level that updates a value in one of the rows selected in sqlTransaction1.</span></span>  
  
- <span data-ttu-id="36e1f-203">Committet sqlTransaction2.</span><span class="sxs-lookup"><span data-stu-id="36e1f-203">Commits sqlTransaction2.</span></span>  
  
- <span data-ttu-id="36e1f-204">Kehrt zu sqlTransaction1 zurück und versucht, dieselbe Zeile zu aktualisieren, für die sqlTransaction1 bereits committet wurde.</span><span class="sxs-lookup"><span data-stu-id="36e1f-204">Returns to sqlTransaction1 and attempts to update the same row that sqlTransaction1 already committed.</span></span> <span data-ttu-id="36e1f-205">Fehler 3960 wird ausgelöst, und für sqlTransaction1 wird automatisch ein Rollback ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="36e1f-205">Error 3960 is raised, and sqlTransaction1 is rolled back automatically.</span></span> <span data-ttu-id="36e1f-206">Im Konsolenfenster werden die **SqlException.Number** und die **SqlException.Message** angezeigt.</span><span class="sxs-lookup"><span data-stu-id="36e1f-206">The **SqlException.Number** and **SqlException.Message** are displayed in the Console window.</span></span>  
  
- <span data-ttu-id="36e1f-207">Führt Bereinigungscode aus, um die Snapshot-Isolation in **AdventureWorks** zu deaktivieren und die **TestSnapshotUpdate**-Tabelle zu löschen.</span><span class="sxs-lookup"><span data-stu-id="36e1f-207">Executes clean-up code to turn off snapshot isolation in **AdventureWorks** and delete the **TestSnapshotUpdate** table.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/VB/source.vb#1)]  
  
### <a name="using-lock-hints-with-snapshot-isolation"></a><span data-ttu-id="36e1f-208">Verwenden von Sperrhinweisen mit der Snapshot-Isolation</span><span class="sxs-lookup"><span data-stu-id="36e1f-208">Using Lock Hints with Snapshot Isolation</span></span>  
 <span data-ttu-id="36e1f-209">Im vorherigen Beispiel wählt die erste Transaktion Daten aus. Eine zweite Transaktion aktualisiert die Daten, bevor die erste Transaktion abgeschlossen werden kann. Dadurch entsteht ein Aktualisierungskonflikt, wenn die erste Transaktion versucht, dieselbe Zeile zu aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="36e1f-209">In the previous example, the first transaction selects data, and a second transaction updates the data before the first transaction is able to complete, causing an update conflict when the first transaction tries to update the same row.</span></span> <span data-ttu-id="36e1f-210">Sie können die Wahrscheinlichkeit von Aktualisierungskonflikten bei lang laufenden Momentaufnahmentransaktionen verringern, indem Sie zu Beginn der Transaktion Sperrhinweise angeben.</span><span class="sxs-lookup"><span data-stu-id="36e1f-210">You can reduce the chance of update conflicts in long-running snapshot transactions by supplying lock hints at the beginning of the transaction.</span></span> <span data-ttu-id="36e1f-211">Die folgende SELECT-Anweisung verwendet den UPDLOCK-Hinweis, um die ausgewählten Zeilen zu sperren:</span><span class="sxs-lookup"><span data-stu-id="36e1f-211">The following SELECT statement uses the UPDLOCK hint to lock the selected rows:</span></span>  
  
```sql  
SELECT * FROM TestSnapshotUpdate WITH (UPDLOCK)
  WHERE PriKey BETWEEN 1 AND 3  
```  
  
 <span data-ttu-id="36e1f-212">Die Verwendung des UPDLOCK-Sperrhinweises blockiert alle Zeilen, die versuchen, die Zeilen zu aktualisieren, bevor die erste Transaktion abgeschlossen ist.</span><span class="sxs-lookup"><span data-stu-id="36e1f-212">Using the UPDLOCK lock hint blocks any rows attempting to update the rows before the first transaction completes.</span></span> <span data-ttu-id="36e1f-213">Dies garantiert, dass die ausgewählten Zeilen keine Konflikte aufweisen, wenn sie später in der Transaktion aktualisiert werden.</span><span class="sxs-lookup"><span data-stu-id="36e1f-213">This guarantees that the selected rows have no conflicts when they are updated later in the transaction.</span></span> <span data-ttu-id="36e1f-214">Weitere Informationen finden Sie in der SQL Server-Onlinedokumentation unter „Sperrhinweise“.</span><span class="sxs-lookup"><span data-stu-id="36e1f-214">See "Locking Hints" in SQL Server Books Online.</span></span>  
  
 <span data-ttu-id="36e1f-215">Wenn Ihre Anwendung viele Konflikte aufweist, ist die Momentaufnahmenisolation möglicherweise nicht die beste Wahl.</span><span class="sxs-lookup"><span data-stu-id="36e1f-215">If your application has many conflicts, snapshot isolation may not be the best choice.</span></span> <span data-ttu-id="36e1f-216">Hinweise sollten nur verwendet werden, wenn unbedingt nötig.</span><span class="sxs-lookup"><span data-stu-id="36e1f-216">Hints should only be used when really needed.</span></span> <span data-ttu-id="36e1f-217">Ihre Anwendung sollte nicht so konzipiert sein, dass ihr Betrieb ständig auf Sperrhinweise angewiesen ist.</span><span class="sxs-lookup"><span data-stu-id="36e1f-217">Your application should not be designed so that it constantly relies on lock hints for its operation.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="36e1f-218">Weitere Informationen</span><span class="sxs-lookup"><span data-stu-id="36e1f-218">See also</span></span>

- [<span data-ttu-id="36e1f-219">SQL Server und ADO.NET</span><span class="sxs-lookup"><span data-stu-id="36e1f-219">SQL Server and ADO.NET</span></span>](index.md)
- [<span data-ttu-id="36e1f-220">Übersicht über ADO.NET</span><span class="sxs-lookup"><span data-stu-id="36e1f-220">ADO.NET Overview</span></span>](../ado-net-overview.md)
- [<span data-ttu-id="36e1f-221">Handbuch zu Transaktionssperren und Zeilenversionsverwaltung</span><span class="sxs-lookup"><span data-stu-id="36e1f-221">Transaction Locking and Row Versioning Guide</span></span>](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide)
